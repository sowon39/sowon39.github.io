<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>DK Fit OS v12.2 (Google Login · Cloud Sync)</title>

  <!-- ✅ PWA / iOS Standalone -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DK Fit">
  <meta name="theme-color" content="#050507">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800;900&display=swap');

    :root{
      --primary:#22d3ee;
      --accent:#6366f1;
      --bg:#050507;
      --card:rgba(255,255,255,0.04);
      --dockH: 110px;
      --headerH: 108px;
    }

    html,body{ height:100%; }

    *{
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
      -webkit-tap-highlight-color:transparent;
    }
    img, video{
      -webkit-user-drag:none;
      user-drag:none;
    }
    button,a{ touch-action: manipulation; }

    html{
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    body{
      font-family:'Pretendard',sans-serif;
      background-color:var(--bg);
      color:#e4e4e7;
      margin:0;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior: none;

      background-image:
        radial-gradient(1200px 700px at 15% -10%, rgba(34,211,238,0.18), transparent 55%),
        radial-gradient(1200px 700px at 100% 10%, rgba(99,102,241,0.22), transparent 55%),
        radial-gradient(900px 600px at 15% 110%, rgba(12,74,110,0.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      background-attachment: fixed;
    }

    ::-webkit-scrollbar{ display:none; }
    .scroll-hide{ -ms-overflow-style:none; scrollbar-width:none; }

    .glass{
      background:var(--card);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      border:1px solid rgba(255,255,255,0.10);
    }

    .layoutWrap{
      width:100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* =========================================================
       ✅ Splash
    ========================================================= */
    #splash-screen{
      position:fixed; inset:0; z-index:10000;
      display:flex; align-items:center; justify-content:center;
      background:#050507;
      overflow:hidden;
      transition:all 1s cubic-bezier(0.65,0,0.35,1);
    }
    #splash-screen::before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(1000px 600px at 30% 10%, rgba(34,211,238,0.35), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(99,102,241,0.35), transparent 62%),
        radial-gradient(900px 600px at 20% 90%, rgba(34,211,238,0.25), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,1));
      animation: liquidFloat 5.5s ease-in-out infinite alternate;
      filter:saturate(1.2);
      opacity:1;
    }
    #splash-screen::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.20'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.13;
      pointer-events:none;
    }
    @keyframes liquidFloat{
      0%{ transform: translateY(0) scale(1); }
      100%{ transform: translateY(-22px) scale(1.05); }
    }
    .splash-inner{
      width:min(540px, calc(100vw - 56px));
      padding: 56px 26px 46px;
      border-radius: 38px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 50px 160px rgba(0,0,0,0.6);
      position:relative;
      z-index:2;
      text-align:center;
      transform: translateY(14px) scale(.98);
      opacity:0;
      animation: splashIn 1.1s cubic-bezier(.2,.9,.2,1) forwards;
      overflow: hidden;
      isolation:isolate;
    }
    .splash-inner .shine{
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.35), transparent 40%);
      filter: blur(10px);
      opacity:.35;
      animation: shineMove 3.2s ease-in-out infinite alternate;
      pointer-events:none;
      z-index:0;
    }
    @keyframes shineMove{
      0%{ transform: translate(-10px, 10px); }
      100%{ transform: translate(18px, -18px); }
    }
    @keyframes splashIn{
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .splash-logo{
      font-size: 4.5rem;
      font-weight: 950;
      letter-spacing: -0.08em;
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(34,211,238,0.95));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 24px rgba(34,211,238,0.20));
      position:relative;
      z-index:2;
      display:inline-block;
      padding: 6px 14px;
    }
    .splash-loader{
      margin-top: 26px;
      position:relative;
      z-index:2;
    }
    .splash-line{
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      position:relative;
    }
    .splash-line span{
      position:absolute; inset:0;
      width:45%;
      background: linear-gradient(90deg, rgba(34,211,238,0), rgba(34,211,238,1), rgba(99,102,241,1), rgba(34,211,238,0));
      animation: splashScan 1.15s ease-in-out infinite;
      filter: drop-shadow(0 0 14px rgba(34,211,238,0.35));
    }
    @keyframes splashScan{
      0%{ transform: translateX(-70%); }
      100%{ transform: translateX(170%); }
    }

    /* Header */
    header{
      position:fixed; top:0; left:0; right:0; z-index:50;
      padding: 18px 18px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      background: rgba(10,10,12,0.62);
      height: var(--headerH);
      box-sizing:border-box;
      padding-top: calc(14px + env(safe-area-inset-top));
    }

    .tab-content{ display:none; animation:fadeInContent 0.45s ease-out; }
    .tab-content.active{ display:block; }
    @keyframes fadeInContent{ from{opacity:0; transform:translateY(6px) scale(0.985);} to{opacity:1; transform:translateY(0) scale(1);} }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      font-size:11px; font-weight:900;
      color:rgba(255,255,255,0.82);
      white-space:nowrap;
      user-select:none;
    }
    .pill.cyan{ border-color:rgba(34,211,238,0.25); background:rgba(34,211,238,0.10); color:rgba(34,211,238,0.95); }
    .pill.warn{ border-color:rgba(251,191,36,0.25); background:rgba(251,191,36,0.10); color:rgba(251,191,36,0.95); }
    .pill.good{ border-color:rgba(34,197,94,0.25); background:rgba(34,197,94,0.10); color:rgba(34,197,94,0.95); }

    main{
      padding-top: calc(var(--headerH) + 18px + env(safe-area-inset-top));
      padding-bottom: calc(var(--dockH) + env(safe-area-inset-bottom) + 28px);
    }

    .carousel{
      display:flex;
      gap:18px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 0 22px 18px;
      margin: 0 -22px;
      touch-action: pan-x pan-y;
    }
    .carousel::before,.carousel::after{ content:''; flex:0 0 22px; }
    .carousel > .slide{
      scroll-snap-align:center;
      flex: 0 0 calc(100% - 120px);
      min-height: auto;
      transition: opacity .22s ease, transform .22s ease, filter .22s ease;
    }
    .slide.peek{ opacity:.60; transform:scale(.965); filter:blur(.6px); }
    .slide.focus{ opacity:1; transform:scale(1); filter:none; }
    @media (min-width: 860px){
      .carousel > .slide{ flex:0 0 calc(100% - 160px); }
      .slide.peek{ opacity:.62; transform:scale(.97); filter:blur(.45px); }
    }

    .slideCard{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      border-radius:32px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }

    .rightPanel{ border-radius:26px; padding:18px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); }
    .stepper{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 14px; border-radius:22px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
    }
    .stepperLabel{ font-size:10px; font-weight:900; letter-spacing:.18em; text-transform:uppercase; color:rgba(255,255,255,0.50); }
    .stepperValue{ font-size:22px; font-weight:950; color:white; }
    .stepperBtn{
      width:48px; height:48px; border-radius:18px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      color:rgba(255,255,255,0.9);
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      transition: transform .08s ease;
    }
    .stepperBtn:active{ transform:scale(.98); }

    .bigBtn{
      width:100%; height:60px; border-radius:20px;
      font-weight:900; font-size:15px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .12s ease;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
    }
    .bigBtn:active{ transform:scale(0.985); }

    .setBtn{
      width:100%; height:66px; border-radius:20px;
      font-weight:950; font-size:18px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .12s ease;
      -webkit-tap-highlight-color:transparent;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      user-select:none;
      overflow:hidden;
    }
    .setBtn:active{ transform:scale(0.985); }
    .setBtn.done{ background:linear-gradient(135deg,var(--primary),var(--accent)); color:#000; box-shadow:0 18px 34px rgba(34,211,238,0.24); border:none; }
    .setBtn.locked{ opacity: .35; filter: saturate(.6); pointer-events: none; }

    .navDockWrap{ position:fixed; left:0; right:0; bottom:0; padding: 18px; z-index:60; }
    .nav-dock{
      background:rgba(10,10,12,0.78);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter:blur(22px);
      border-radius:34px;
      padding:10px;
      display:flex;
      justify-content:space-around;
      align-items:center;
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.7);
    }
    .nav-item{ position:relative; padding:12px 0; flex:1; display:flex; flex-direction:column; align-items:center; gap:5px; transition:all .25s; color:#777; -webkit-tap-highlight-color:transparent; user-select:none; }
    .nav-item.active{ color:var(--primary); transform:translateY(-3px); }
    .nav-item i{ font-size:1.25rem; }
    .nav-active-dot{ position:absolute; bottom:1px; width:4px; height:4px; background:var(--primary); border-radius:50%; box-shadow:0 0 12px var(--primary); opacity:0; transition:all .25s; }
    .nav-item.active .nav-active-dot{ opacity:1; transform:scale(1.6); }

    .navDockWrap{
      transition: transform .45s cubic-bezier(0.22, 1, 0.36, 1), opacity .35s ease;
      will-change: transform, opacity;
    }
    .navDockWrap.dock-hide{
      transform: translateY(120%);
      opacity: 0;
      pointer-events: none;
    }
    .navDockWrap.dock-show{
      transform: translateY(0%);
      opacity: 1;
      pointer-events: auto;
    }

    #timer-modal{ transition:all .65s ease; }
    #timer-sec{ letter-spacing:-0.08em; }

    #timer-hud{
      position:fixed;
      top: calc(var(--headerH) + 10px + env(safe-area-inset-top));
      right: 14px;
      z-index: 210;
      display:none;
    }
    #timer-hud.show{ display:block; }
    .hudCard{
      border-radius: 22px;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      background:rgba(10,10,12,0.72);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(22px);
      box-shadow:0 20px 40px rgba(0,0,0,0.55);
      min-width: 190px;
      user-select:none;
    }
    .hudTime{
      font-weight: 950;
      font-size: 22px;
      letter-spacing: -0.06em;
      color:white;
      line-height:1;
    }
    .hudLabel{ font-size: 9px; font-weight: 900; letter-spacing: .18em; text-transform: uppercase; color: rgba(255,255,255,0.45); }
    .hudBarWrap{
      width:100%;
      height:6px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      margin-top:8px;
    }
    .hudBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius:999px;
      box-shadow: 0 0 14px rgba(34,211,238,0.35);
    }
    .hudBtn{
      width:34px;height:34px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
    }
    .hudBtn:active{ transform:scale(.98); }

    /* Toast */
    #toast{ position:fixed; left:50%; bottom:130px; transform:translateX(-50%); z-index:250; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    /* ===== Account Sheet (로그인 UX) ===== */
    #account-sheet{
      position: fixed; inset: 0;
      z-index: 400;
      display: none;
      pointer-events: none;
    }
    #account-sheet.show{ display:block; pointer-events:auto; }
    .sheet-backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 1;
      pointer-events: auto;
    }
    .sheet{
      position:absolute; left:0; right:0; bottom:0;
      border-radius: 28px 28px 0 0;
      background: rgba(10,10,12,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 -24px 80px rgba(0,0,0,0.75);
      transform: translateY(100%);
      transition: transform .45s cubic-bezier(0.22,1,0.36,1);
      z-index: 2;
      padding: 16px 18px calc(env(safe-area-inset-bottom) + 16px);
      max-height: 86vh;
      overflow:hidden;
      isolation:isolate;
    }
    #account-sheet.show .sheet{ transform: translateY(0%); }
    .sheetHeader{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: 12px;
      padding-bottom: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .avatar{
      width:44px; height:44px; border-radius: 18px;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      overflow:hidden;
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .sheetClose{
      width:44px; height:44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.85);
      -webkit-tap-highlight-color:transparent;
    }
    .sheetClose:active{ transform: scale(.98); }
    .sheetBody{
      padding-top: 14px;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(86vh - 90px);
    }
    .sheetCard{
      border-radius: 22px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 14px 14px;
      margin-bottom: 12px;
    }
    .sheetLabel{
      font-size: 10px;
      letter-spacing: .20em;
      font-weight: 950;
      text-transform: uppercase;
      color: rgba(255,255,255,0.42);
    }

    .ctaGoogle{
      width:100%;
      height:60px;
      border-radius: 20px;
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      color:#000;
      box-shadow: 0 18px 34px rgba(34,211,238,0.22);
      -webkit-tap-highlight-color:transparent;
      transition: transform .12s ease;
    }
    .ctaGoogle:active{ transform: scale(.985); }
  </style>
</head>

<body>

  <!-- ✅ Splash -->
  <div id="splash-screen">
    <div class="splash-inner">
      <div class="shine"></div>
      <div class="splash-logo">DK Fit</div>
      <div class="splash-loader">
        <div class="splash-line"><span></span></div>
      </div>
    </div>
  </div>

  <!-- ✅ Account Sheet (로그인/계정 UX) -->
  <div id="account-sheet">
    <div class="sheet-backdrop" onclick="closeAccountSheet()"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div class="flex items-start gap-3">
          <div class="avatar" id="acc-avatar">
            <i class="fa-solid fa-user text-white/60"></i>
          </div>
          <div class="min-w-0">
            <div class="sheetLabel">Cloud Sync</div>
            <div id="acc-title" class="text-xl font-black text-white mt-1">로그인이 필요합니다</div>
            <div id="acc-sub" class="text-[11px] font-black text-white/45 mt-2 tracking-widest uppercase">Google 로그인</div>
          </div>
        </div>
        <button class="sheetClose" onclick="closeAccountSheet()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="sheetBody">
        <!-- Logged out view -->
        <div id="acc-loggedout">
          <div class="sheetCard">
            <div class="sheetLabel">기록 동기화</div>
            <p class="text-sm font-black text-white/75 mt-2 leading-relaxed">
              Google 계정으로 로그인하면 <b>모든 기록이 자동으로 저장</b>되고,
              다른 디바이스에서도 동일한 기록을 바로 볼 수 있어요.
            </p>
            <p class="text-[10px] font-black text-white/35 mt-3 tracking-[0.18em] uppercase">
              * 경로: /users/{uid} (본인만 접근 가능)
            </p>
          </div>

          <button class="ctaGoogle" onclick="googleLogin()">
            <i class="fa-brands fa-google"></i>
            Google로 계속
          </button>

          <div class="sheetCard mt-3">
            <div class="sheetLabel">안내</div>
            <p class="text-[12px] font-black text-white/60 leading-relaxed mt-2">
              • 로그인 전에도 로컬 기록은 유지됩니다.<br>
              • 로그인하면 <b>클라우드가 기준</b>이 되어 동기화됩니다.<br>
              • 로그아웃 시 로컬 기록도 안전하게 초기화됩니다.
            </p>
          </div>
        </div>

        <!-- Logged in view -->
        <div id="acc-loggedin" style="display:none;">
          <div class="sheetCard">
            <div class="sheetLabel">계정</div>
            <p id="acc-email" class="text-base font-black text-white/90 mt-2">-</p>
            <p id="acc-uid" class="text-[10px] font-black text-white/35 mt-3 tracking-[0.18em] uppercase">UID</p>
          </div>

          <div class="sheetCard">
            <div class="sheetLabel">동기화 상태</div>
            <div class="flex items-center justify-between mt-3">
              <div class="text-sm font-black text-white/75">자동 저장</div>
              <span id="sync-pill" class="pill good"><i class="fa-solid fa-check"></i> ON</span>
            </div>
            <div class="flex items-center justify-between mt-3">
              <div class="text-sm font-black text-white/60">마지막 저장</div>
              <div id="last-sync" class="text-[11px] font-black text-white/40 tracking-widest uppercase">-</div>
            </div>
            <div class="grid gap-3 mt-4">
              <button class="bigBtn" onclick="manualCloudPull()"><i class="fa-solid fa-cloud-arrow-down"></i> 클라우드에서 불러오기</button>
              <button class="bigBtn" onclick="manualCloudPush()"><i class="fa-solid fa-cloud-arrow-up"></i> 지금 클라우드 저장</button>
            </div>
            <p class="text-[10px] font-black text-white/35 mt-4 tracking-[0.18em] uppercase">
              * 동시 접속 시 “마지막 저장한 디바이스” 값이 우선됩니다.
            </p>
          </div>

          <button class="bigBtn" onclick="logoutFirebase()" style="border-color: rgba(239,68,68,0.25); background: rgba(239,68,68,0.10); color: rgba(239,68,68,0.95);">
            <i class="fa-solid fa-right-from-bracket"></i> 로그아웃 (로컬도 초기화)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="layoutWrap flex justify-between items-end">
      <div>
        <div class="flex items-center gap-2">
          <h2 id="stopwatch" class="text-3xl font-black font-mono tracking-tighter text-white">00:00</h2>

          <button onclick="toggleStopwatchPause()" class="pill cyan" style="padding:7px 12px;" title="총 운동시간 일시정지">
            <i id="pause-icon" class="fa-solid fa-pause"></i>
          </button>
        </div>

        <div class="flex items-center gap-2 mt-1">
          <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
          <p class="text-[9px] font-black text-gray-300 tracking-widest uppercase">ELITE MODE · DK</p>
        </div>

        <!-- ✅ Cloud UX -->
        <div class="flex items-center gap-2 mt-2">
          <button id="cloud-btn" class="pill warn" onclick="openAccountSheet()">
            <i class="fa-solid fa-cloud"></i>
            <span id="cloud-label">Cloud OFF</span>
          </button>
          <span id="cloud-mini" class="pill" style="display:none;">
            <i class="fa-solid fa-rotate"></i> Syncing…
          </span>
        </div>
      </div>

      <div class="flex flex-col items-end">
        <span id="progress-percent" class="text-[10px] font-black mb-0.5 text-cyan-300">0%</span>
        <span id="progress-text" class="text-[9px] font-black text-white/40 tracking-widest uppercase">현재 0% 완료!</span>
        <div class="w-28 h-1.5 bg-white/5 rounded-full overflow-hidden mt-2">
          <div id="progress-bar" class="h-full bg-cyan-400 shadow-[0_0_12px_#22d3ee] transition-all duration-700" style="width:0%"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Timer HUD -->
  <div id="timer-hud">
    <div class="hudCard">
      <div class="min-w-[70px]">
        <div class="hudLabel">REST</div>
        <div id="hud-time" class="hudTime">60</div>
        <div class="hudBarWrap"><div id="hud-bar" class="hudBar"></div></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="hudBtn" onclick="openTimerFromHUD()" title="타이머 보기"><i class="fa-solid fa-expand"></i></button>
        <button class="hudBtn" onclick="closeTimer(false)" title="스킵"><i class="fa-solid fa-forward"></i></button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main>
    <div class="layoutWrap px-4">

      <!-- Session -->
      <section id="tab-session" class="tab-content active">
        <div class="mb-4 mt-2 px-2 flex justify-between items-start">
          <div>
            <h1 id="view-day" class="text-5xl font-black italic text-white uppercase tracking-tighter">DAY</h1>
            <p id="view-title" class="text-gray-300 font-black mt-1 text-sm tracking-wide"></p>
            <p id="view-subcue" class="text-[10px] font-black text-white/50 mt-2 tracking-[0.18em] uppercase"></p>
          </div>
          <button onclick="resetToday()" class="pill" title="오늘 기록 초기화">
            <i class="fa-solid fa-rotate-left"></i> 오늘 초기화
          </button>
        </div>

        <div id="day-nav-wrap" class="mb-3">
          <div id="day-nav" class="flex justify-center gap-2 overflow-x-auto pb-2 scroll-hide"></div>
        </div>

        <div class="flex items-center justify-between px-2 mb-4">
          <div class="flex items-center gap-2">
            <span class="pill cyan" id="slide-indicator">1 / 1</span>
            <span class="pill" id="slide-name">운동</span>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="carouselPrev()" class="pill"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="carouselNext()" class="pill"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
        </div>

        <div id="session-carousel" class="carousel scroll-hide"></div>
      </section>

      <!-- Stats -->
      <section id="tab-stats" class="tab-content">
        <div class="mb-8 px-2">
          <h2 class="text-3xl font-black italic uppercase tracking-tight">분석</h2>
          <p class="text-[11px] font-black text-white/45 mt-2 tracking-[0.18em] uppercase">
            훈련의 편향/밸런스를 확인합니다
          </p>
        </div>

        <div class="glass rounded-[28px] p-8 mb-6">
          <canvas id="radarChart" class="max-h-[320px]"></canvas>
        </div>

        <div class="grid grid-cols-2 gap-5 mb-6">
          <div class="glass rounded-[28px] p-6">
            <p class="text-[9px] text-gray-400 font-black uppercase mb-2 tracking-widest">총 기록(세트)</p>
            <p id="stat-total-sets" class="text-4xl font-black text-white">0</p>
          </div>
          <div class="glass rounded-[28px] p-6">
            <p class="text-[9px] text-gray-400 font-black uppercase mb-2 tracking-widest">활동 일수</p>
            <p id="stat-week-count" class="text-4xl font-black text-indigo-300">0</p>
          </div>
        </div>

        <div class="glass rounded-[28px] p-6 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">휴식 타이머 알림</p>
              <p class="text-sm font-black text-white/70 mt-2">타이머 종료 시 소리/진동</p>
            </div>
            <button id="notif-toggle" class="pill cyan" onclick="toggleNotif()">ON</button>
          </div>
          <p class="text-[11px] font-black text-white/35 mt-3">
            * iOS는 무음모드에서 소리가 제한될 수 있습니다. iPad는 진동이 지원되지 않을 수 있습니다.
          </p>
        </div>

        <div class="grid gap-3">
          <button onclick="backupJSON()" class="bigBtn"><i class="fa-solid fa-download"></i> 백업(JSON)</button>
          <button onclick="resetAll()" class="bigBtn" style="border-color: rgba(255,255,255,0.18);"><i class="fa-solid fa-triangle-exclamation"></i> 전체 초기화</button>
        </div>

      </section>

      <!-- History -->
      <section id="tab-history" class="tab-content">
        <div class="mb-6 px-2 flex justify-between items-end">
          <h2 class="text-3xl font-black italic uppercase">기록</h2>
          <div class="flex items-center gap-4 glass rounded-2xl px-5 py-2.5">
            <button onclick="changeMonth(-1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-left text-xs"></i></button>
            <span id="calendar-month" class="text-xs font-black w-20 text-center tracking-widest">2026.01</span>
            <button onclick="changeMonth(1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-right text-xs"></i></button>
          </div>
        </div>

        <div class="historyLayout">
          <div>
            <div class="glass rounded-[28px] p-6 mb-4 shadow-2xl">
              <div class="grid grid-cols-7 text-center text-[9px] font-black text-gray-500 mb-5 uppercase tracking-[0.2em]">
                <div class="text-red-600">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-600">토</div>
              </div>
              <div id="calendar-body" class="grid grid-cols-7 gap-3"></div>
            </div>

            <button onclick="resetSelectedDate()" class="pill w-full justify-center">
              <i class="fa-solid fa-eraser"></i> 선택 날짜 초기화
            </button>
          </div>

          <div>
            <div id="history-detail" class="space-y-6"></div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Bottom Dock -->
  <div class="navDockWrap">
    <div class="layoutWrap">
      <nav class="nav-dock" style="margin-bottom: calc(env(safe-area-inset-bottom) + 6px);">
        <button onclick="showTab('session', this)" class="nav-item active">
          <i class="fa-solid fa-bolt-lightning"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">훈련</span>
          <div class="nav-active-dot"></div>
        </button>
        <button onclick="showTab('stats', this)" class="nav-item">
          <i class="fa-solid fa-chart-simple"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">분석</span>
          <div class="nav-active-dot"></div>
        </button>
        <button onclick="showTab('history', this)" class="nav-item">
          <i class="fa-solid fa-calendar-days"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">기록</span>
          <div class="nav-active-dot"></div>
        </button>
      </nav>
    </div>
  </div>

  <!-- REST TIMER MODAL -->
  <div id="timer-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden opacity-0">
    <div class="absolute inset-0 bg-black/95 backdrop-blur-2xl"></div>
    <div class="relative text-center">
      <div class="miniHint mb-3 text-[10px] font-black tracking-[0.2em] uppercase text-white/35">휴식</div>
      <div id="timer-sec" class="text-[14rem] font-black text-white italic tracking-tighter leading-none mb-6 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]">00</div>

      <div class="flex items-center justify-center gap-3">
        <button onclick="adjustRest(-10)" class="glass px-7 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">-10</button>
        <button onclick="minimizeTimer()" class="glass px-10 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">최소화</button>
        <button onclick="adjustRest(10)" class="glass px-7 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">+10</button>
      </div>

      <div class="mt-4 flex items-center justify-center gap-3">
        <button onclick="closeTimer(false)" class="pill"><i class="fa-solid fa-forward"></i> 스킵</button>
      </div>

      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/40 mt-6">최소 방해 · 최대 집중</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="pill cyan"></div>

  <!-- =========================================================
    ✅ Firebase (Modular v9) — Google Login ONLY
  ========================================================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIrxl_GDVJYzLZxuSzUt9cLBUCfkUoCaw",
      authDomain: "dk-pit.firebaseapp.com",
      projectId: "dk-pit",
      storageBucket: "dk-pit.firebasestorage.app",
      messagingSenderId: "835447327032",
      appId: "1:835447327032:web:6101fd173f5214926359cd"
    };

    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);
    const googleProvider = new GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: "select_account" });

    // =========================
    // ✅ Cloud Sync Layer
    // =========================
    let currentUser = null;
    let userDocUnsub = null;
    let cloudEnabled = false;

    let cloudSaveTimer = null;
    let isApplyingRemote = false;

    const CLOUD_DEBOUNCE_MS = 450; // ✅ 모바일에서 더 즉시성 있게
    const MINI_SYNC_MS = 1200;

    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      if(window.__toastTimer) clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> el.classList.remove('show'), 1800);
    }

    // ✅ UI helpers
    const cloudBtn = document.getElementById("cloud-btn");
    const cloudLabel = document.getElementById("cloud-label");
    const cloudMini = document.getElementById("cloud-mini");
    const syncPill = document.getElementById("sync-pill");
    const lastSync = document.getElementById("last-sync");

    function setMiniSync(on){
      cloudMini.style.display = on ? "inline-flex" : "none";
      if(on){
        cloudMini.classList.add("cyan");
        setTimeout(()=> setMiniSync(false), MINI_SYNC_MS);
      }
    }

    function formatTime(ts){
      if(!ts) return "-";
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function setCloudBadge(state){
      // state: off | on | syncing | error
      cloudBtn.classList.remove("cyan","warn","good");
      if(state === "off"){
        cloudBtn.classList.add("warn");
        cloudLabel.textContent = "Cloud OFF";
      }else if(state === "on"){
        cloudBtn.classList.add("good");
        cloudLabel.textContent = "Cloud ON";
      }else if(state === "syncing"){
        cloudBtn.classList.add("cyan");
        cloudLabel.textContent = "Syncing…";
      }else{
        cloudBtn.classList.add("warn");
        cloudLabel.textContent = "Cloud ERROR";
      }
    }

    function userDocRef(uid){
      return doc(db, "users", uid);
    }

    function getLocalSnapshot(){
      return {
        version: "dk_fit_v12.2_cloud",
        updatedAt: Date.now(),
        logs: window.logs || [],
        customSets: window.customSets || {},
        customReps: window.customReps || {},
        progressByDate: window.progressByDate || {},
        settings: { restNotifEnabled: window.restNotifEnabled ?? true }
      };
    }

    function applyCloudSnapshot(payload){
      if(!payload) return;
      isApplyingRemote = true;

      window.logs = payload.logs || [];
      window.customSets = payload.customSets || {};
      window.customReps = payload.customReps || {};
      window.progressByDate = payload.progressByDate || {};

      if(payload.settings && typeof payload.settings.restNotifEnabled === "boolean"){
        window.restNotifEnabled = payload.settings.restNotifEnabled;
        localStorage.setItem(window.KEY_NOTIF, window.restNotifEnabled ? "1" : "0");
      }

      localStorage.setItem(window.KEY_LOGS, JSON.stringify(window.logs));
      localStorage.setItem(window.KEY_SETS, JSON.stringify(window.customSets));
      localStorage.setItem(window.KEY_REPS, JSON.stringify(window.customReps));
      localStorage.setItem(window.KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate));

      try{
        window.renderCarousel(true);
        window.updateProgressUI();
        window.renderCalendar();
        if(document.getElementById("notif-toggle")){
          const btn = document.getElementById("notif-toggle");
          btn.textContent = window.restNotifEnabled ? "ON" : "OFF";
          btn.classList.toggle("cyan", window.restNotifEnabled);
        }
      }catch(e){}

      isApplyingRemote = false;
    }

    async function pushToCloud(uid, reason="auto"){
      if(!uid) return;
      const ref = userDocRef(uid);
      const payload = getLocalSnapshot();

      // ✅ local timestamp keeps last-write-wins stable
      window.__localCloudUpdatedAt = payload.updatedAt;
      setMiniSync(true);
      setCloudBadge("syncing");

      await setDoc(ref, {
        uid,
        reason,
        updatedAt: payload.updatedAt,
        updatedAtServer: serverTimestamp(),
        payload
      }, { merge: true });

      if(lastSync) lastSync.textContent = formatTime(payload.updatedAt);
      setCloudBadge("on");
    }

    async function pullFromCloud(uid){
      const ref = userDocRef(uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await pushToCloud(uid, "first_create");
        toast("클라우드 생성 완료 ✅");
        return;
      }
      const data = snap.data();
      const payload = data?.payload || null;
      if(payload){
        applyCloudSnapshot(payload);
        if(lastSync) lastSync.textContent = formatTime(payload.updatedAt);
        toast("클라우드 불러옴 ✅");
      }else{
        toast("클라우드 데이터 없음");
      }
    }

    function scheduleCloudSave(reason="local_change"){
      if(!cloudEnabled || !currentUser?.uid) return;
      if(isApplyingRemote) return;

      if(cloudSaveTimer) clearTimeout(cloudSaveTimer);
      cloudSaveTimer = setTimeout(async ()=>{
        try{
          await pushToCloud(currentUser.uid, reason);
        }catch(e){
          console.error(e);
          toast("클라우드 저장 실패");
          setCloudBadge("error");
        }
      }, CLOUD_DEBOUNCE_MS);
    }

    function startRealtimeSync(uid){
      if(userDocUnsub) userDocUnsub();
      const ref = userDocRef(uid);

      userDocUnsub = onSnapshot(ref, (snap)=>{
        if(!snap.exists()) return;
        const data = snap.data();
        const payload = data?.payload;
        if(!payload) return;

        const localUpdatedAt = (window.__localCloudUpdatedAt || 0);
        const remoteUpdatedAt = payload.updatedAt || 0;

        // ✅ remote가 더 최신일 때만 적용
        if(isApplyingRemote) return;
        if(remoteUpdatedAt <= localUpdatedAt) return;

        window.__localCloudUpdatedAt = remoteUpdatedAt;
        applyCloudSnapshot(payload);
        if(lastSync) lastSync.textContent = formatTime(remoteUpdatedAt);
        toast("다른 기기 변경 동기화 ✅");
      }, (err)=>{
        console.error(err);
        setCloudBadge("error");
      });
    }

    // =========================
    // ✅ localStorage hook (키가 정의된 뒤에만 동작)
    // =========================
    function installLocalStorageHook(){
      if(localStorage.__dk_hooked) return;
      localStorage.__dk_hooked = true;

      const _setItem = localStorage.setItem.bind(localStorage);
      localStorage.setItem = function(k, v){
        _setItem(k, v);
        const watch = [window.KEY_LOGS, window.KEY_SETS, window.KEY_REPS, window.KEY_PROGRESS_BY_DATE, window.KEY_NOTIF].filter(Boolean);
        if(watch.includes(k)){
          scheduleCloudSave("localstorage_change");
        }
      };
    }

    // =========================
    // ✅ Account Sheet UX
    // =========================
    window.openAccountSheet = () => {
      document.getElementById("account-sheet").classList.add("show");
    };
    window.closeAccountSheet = () => {
      document.getElementById("account-sheet").classList.remove("show");
    };

    function setAccountSheetUI(user){
      const loggedOut = document.getElementById("acc-loggedout");
      const loggedIn  = document.getElementById("acc-loggedin");
      const title = document.getElementById("acc-title");
      const sub = document.getElementById("acc-sub");
      const email = document.getElementById("acc-email");
      const uid = document.getElementById("acc-uid");
      const avatar = document.getElementById("acc-avatar");

      if(!user){
        loggedOut.style.display = "block";
        loggedIn.style.display = "none";
        title.textContent = "로그인이 필요합니다";
        sub.textContent = "Google 로그인";
        avatar.innerHTML = `<i class="fa-solid fa-user text-white/60"></i>`;
        return;
      }

      loggedOut.style.display = "none";
      loggedIn.style.display = "block";
      title.textContent = "계정이 연결되었습니다";
      sub.textContent = "Cloud Sync ON";
      email.textContent = user.email || "Google Account";
      uid.textContent = `UID · ${user.uid}`;
      if(user.photoURL){
        avatar.innerHTML = `<img src="${user.photoURL}" alt="avatar">`;
      }else{
        avatar.innerHTML = `<i class="fa-solid fa-user text-white/60"></i>`;
      }
    }

    // =========================
    // ✅ Auth actions (Google only)
    // =========================
    window.googleLogin = async () => {
      try{
        setCloudBadge("syncing");
        await signInWithPopup(auth, googleProvider);
        window.closeAccountSheet();
      }catch(e){
        console.error(e);
        toast("Google 로그인 실패");
        setCloudBadge("error");
      }
    };

    // ✅ logout = Firebase signOut + local reset
    function clearAllLocalData(){
      // 모든 키를 제거 (로컬도 초기화)
      localStorage.removeItem(window.KEY_LOGS);
      localStorage.removeItem(window.KEY_SETS);
      localStorage.removeItem(window.KEY_REPS);
      localStorage.removeItem(window.KEY_PROGRESS_BY_DATE);
      localStorage.removeItem(window.KEY_SUMMARY_SHOWN);
      localStorage.removeItem(window.KEY_NOTIF);

      window.logs = [];
      window.customSets = {};
      window.customReps = {};
      window.progressByDate = {};
      window.restNotifEnabled = true;

      try{
        window.renderCarousel(true);
        window.updateProgressUI();
        window.renderCalendar();
        const btn = document.getElementById('notif-toggle');
        if(btn){
          btn.textContent = "ON";
          btn.classList.add("cyan");
        }
      }catch(e){}
    }

    window.logoutFirebase = async () => {
      try{
        await signOut(auth);
        clearAllLocalData();
        window.closeAccountSheet();
        toast("로그아웃 완료 · 로컬 초기화 ✅");
      }catch(e){
        console.error(e);
        toast("로그아웃 실패");
      }
    };

    window.manualCloudPull = async () => {
      if(!currentUser?.uid) return toast("로그인이 필요합니다");
      await pullFromCloud(currentUser.uid);
    };
    window.manualCloudPush = async () => {
      if(!currentUser?.uid) return toast("로그인이 필요합니다");
      await pushToCloud(currentUser.uid, "manual_push");
      toast("클라우드 저장 ✅");
    };

    // =========================
    // ✅ Auth state
    // =========================
    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;

      if(!user){
        cloudEnabled = false;
        setCloudBadge("off");
        setAccountSheetUI(null);

        if(userDocUnsub) userDocUnsub();
        userDocUnsub = null;
        return;
      }

      cloudEnabled = true;
      setCloudBadge("on");
      setAccountSheetUI(user);
      if(syncPill) syncPill.className = "pill good";
      if(syncPill) syncPill.innerHTML = `<i class="fa-solid fa-check"></i> ON`;

      toast(`로그인됨 ✅`);

      // ✅ hook 설치는 KEY_*가 정의된 후에 호출되어야 안정적 (앱 스크립트에서 호출)
      // 여기선 fallback으로 한 번 더 설치 시도
      installLocalStorageHook();

      // ✅ 1) 클라우드 -> 로컬 pull
      await pullFromCloud(user.uid);

      // ✅ 2) 실시간 동기화
      startRealtimeSync(user.uid);

      // ✅ 3) 로그인 직후 1회 push
      try{
        await pushToCloud(user.uid, "post_login_sync");
      }catch(e){}
    });

    // expose for app script
    window.__dk_installLocalStorageHook = installLocalStorageHook;
  </script>

  <!-- =========================================================
      ✅ 기존 DK Fit 앱 스크립트 (동작은 유지)
  ========================================================= -->
  <script>
    /* =========================================================
      DK Fit OS v12.2 (App Core)
    ========================================================= */

    /* ---------- DATA ---------- */
    let appData = null;
    let workoutData = null;
    let gifMap = null;
    let copy = null;
    let uiConfig = null;

    async function loadAppData(){
      const res = await fetch("./appData.json", {cache:"no-store"});
      if(!res.ok) throw new Error("Failed to load appData.json: " + res.status);
      appData = await res.json();
      workoutData = appData?.data?.workout || {};
      gifMap = appData?.data?.gifMap || [];
      copy = appData?.ui?.copy || {};
      uiConfig = appData?.ui?.config || {};
    }

    function t(path, fallback=""){
      try{
        const val = path.split('.').reduce((o,k)=>o?.[k], copy);
        return (val===undefined||val===null) ? fallback : val;
      }catch(e){ return fallback; }
    }

    function getGifByExerciseName(name){
      const n = (name || '').toLowerCase();
      for(const r of (gifMap || [])){
        if(r.kw_ko && n.includes(String(r.kw_ko).toLowerCase())) return r.gif;
        if(r.kw_en && n.includes(String(r.kw_en).toLowerCase())) return r.gif;
      }
      return '';
    }

    /* ---------- STORAGE KEYS ---------- */
    window.KEY_LOGS = 'dk_os_v122_logs';
    window.KEY_SETS = 'dk_os_v122_sets';
    window.KEY_REPS = 'dk_os_v122_reps';
    window.KEY_PROGRESS_BY_DATE = 'dk_os_v122_progress_by_date';
    window.KEY_SPLASH = 'dk_os_v122_splash_shown';
    window.KEY_SUMMARY_SHOWN = 'dk_os_v122_summary_shown';
    window.KEY_NOTIF = 'dk_os_v122_rest_notif';

    // ✅ localStorage hook 안전 설치 (Firebase script에서 제공)
    try{ window.__dk_installLocalStorageHook && window.__dk_installLocalStorageHook(); }catch(e){}

    /* ---------- LOAD ---------- */
    function safeParse(raw, fallback){ try { return raw ? JSON.parse(raw) : fallback; } catch(e){ return fallback; } }
    window.logs = safeParse(localStorage.getItem(KEY_LOGS), []);
    window.customSets = safeParse(localStorage.getItem(KEY_SETS), {});
    window.customReps = safeParse(localStorage.getItem(KEY_REPS), {});
    window.progressByDate = safeParse(localStorage.getItem(KEY_PROGRESS_BY_DATE), {});

    /* ---------- STATE ---------- */
    let timerInt = null;
    let currentDayIdx = new Date().getDay();
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];
    let restRemaining = 0;
    let restTotal = 0;
    let currentSlideIndex = 0;
    window.restNotifEnabled = (localStorage.getItem(KEY_NOTIF) ?? '1') === '1';

    let restStartedAt = null;
    let restCurrentLogKey = null;

    let audioCtx = null;
    function unlockAudio(){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === 'suspended'){
          audioCtx.resume();
        }
      }catch(e){}
    }

    let workoutStartAt = Date.now();
    let stopwatchPaused = false;
    let pauseStartedAt = null;
    let pausedTotalMs = 0;

    let wakeLock = null;
    async function requestWakeLock(){
      try{
        if('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
        }
      }catch(e){}
    }
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === 'visible') requestWakeLock();
    });

    /* ---------- UTILS ---------- */
    function haptic(ms=18){ if(navigator.vibrate) navigator.vibrate(ms); }
    function nowISO(){ return new Date().toISOString(); }
    function todayStr(){ return new Date().toISOString().split('T')[0]; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function exId(dayIdx, exIdx){ return `${dayIdx}-${exIdx}`; }

    /* ---------- SPLASH ---------- */
    function initIntro(){
      const shown = sessionStorage.getItem(KEY_SPLASH) === '1';
      const splash = document.getElementById('splash-screen');
      if(shown){ splash.style.display = 'none'; return; }

      setTimeout(() => {
        splash.style.opacity = '0';
        splash.style.transform = 'scale(1.08)';
        setTimeout(()=> splash.style.display='none', 900);
        sessionStorage.setItem(KEY_SPLASH, '1');
      }, 2200);
    }

    /* ---------- TOAST ---------- */
    let toastTimer=null;
    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.classList.remove('show'), 1800);
    }

    /* ---------- TABS ---------- */
    function showTab(name, btn){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${name}`).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const dayWrap = document.getElementById('day-nav-wrap');
      if(dayWrap) dayWrap.style.display = (name === 'session') ? 'block' : 'none';

      if(name === 'stats') renderStats();
      if(name === 'history') renderCalendar();

      window.scrollTo({top:0, behavior:'smooth'});
      showDockTemporarily();
    }

    /* ---------- DAY NAV ---------- */
    function updateDayNav(){
      const nav = document.getElementById('day-nav');
      nav.innerHTML = '';
      ['월','화','수','목','금','토','일'].forEach((d, i) => {
        const dm = (i === 6) ? 0 : i + 1;
        const b = document.createElement('button');
        b.className = `pill ${dm === currentDayIdx ? 'cyan' : ''}`;
        b.style.padding = "10px 14px";
        b.style.borderRadius = "18px";
        b.style.fontSize = "12px";
        b.innerText = d;
        b.onclick = () => changeDay(dm);
        nav.appendChild(b);
      });
    }

    /* ---------- DATE-BASED PROGRESS ---------- */
    function getProgressArr(date, exerciseId, setTotal){
      if(!window.progressByDate[date]) window.progressByDate[date] = {};
      let arr = window.progressByDate[date][exerciseId];
      if(!Array.isArray(arr)){
        arr = new Array(setTotal).fill(false);
        window.progressByDate[date][exerciseId] = arr;
        localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate));
        return arr;
      }
      if(arr.length !== setTotal){
        const next = new Array(setTotal).fill(false);
        for(let i=0;i<Math.min(arr.length,setTotal);i++) next[i]=!!arr[i];
        window.progressByDate[date][exerciseId] = next;
        localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate));
        return next;
      }
      return arr;
    }

    function computeProgressForDay(date, dayIdx){
      let total = 0, done = 0;
      workoutData[dayIdx].list.forEach((w, idx) => {
        const id = exId(dayIdx, idx);
        const setTotal = window.customSets[id] || w.set;
        total += setTotal;
        const arr = getProgressArr(date, id, setTotal);
        done += arr.filter(Boolean).length;
      });
      return { total, done, pct: Math.round((done/total)*100) || 0 };
    }

    window.updateProgressUI = function(){
      const p = computeProgressForDay(todayStr(), currentDayIdx);
      document.getElementById('progress-bar').style.width = p.pct + '%';
      document.getElementById('progress-percent').innerText = p.pct + '%';
      document.getElementById('progress-text').innerText = `현재 ${p.pct}% 완료!`;
    }

    /* ---------- STOPWATCH ---------- */
    function toggleStopwatchPause(){
      stopwatchPaused = !stopwatchPaused;
      const icon = document.getElementById('pause-icon');
      if(stopwatchPaused){
        pauseStartedAt = Date.now();
        icon.className = "fa-solid fa-play";
        toast("총 운동시간 일시정지");
      }else{
        if(pauseStartedAt){
          pausedTotalMs += (Date.now() - pauseStartedAt);
        }
        pauseStartedAt = null;
        icon.className = "fa-solid fa-pause";
        toast("총 운동시간 재시작");
      }
      haptic(14);
      showDockTemporarily();
    }

    function getWorkoutElapsedSec(){
      const now = Date.now();
      const paused = stopwatchPaused && pauseStartedAt ? (now - pauseStartedAt) : 0;
      const elapsedMs = (now - workoutStartAt) - pausedTotalMs - paused;
      return Math.max(0, Math.floor(elapsedMs / 1000));
    }

    /* ---------- CHANGE DAY ---------- */
    function changeDay(d){
      currentDayIdx = d;
      currentSlideIndex = 0;

      const data = workoutData[d];
      document.getElementById('view-day').innerText = data.day;
      document.getElementById('view-title').innerText = data.title;

      const cueMap = copy?.cueMap || {push:'',pull:'',leg:'',rest:''};
      document.getElementById('view-subcue').innerText = cueMap[data.type] || '훈련 모드';

      renderCarousel(true);
      window.updateProgressUI();
      updateDayNav();
      showDockTemporarily();
    }

    /* =========================================================
      ✅ CAROUSEL (간소화 + 원본 기능 유지)
    ========================================================= */
    window.renderCarousel = function(full=true){
      const date = todayStr();
      const data = workoutData[currentDayIdx];
      const carousel = document.getElementById('session-carousel');

      if(full){
        carousel.innerHTML = '';
        data.list.forEach((w, idx) => {
          const id = exId(currentDayIdx, idx);
          const gif = getGifByExerciseName(w.name);
          w.gif = gif || '';

          const setTotal = window.customSets[id] || w.set;
          const repTotal = window.customReps[id] || w.rep;
          const doneArr = getProgressArr(date, id, setTotal);
          const doneCount = doneArr.filter(Boolean).length;

          const slide = document.createElement('div');
          slide.className = 'slide';
          slide.setAttribute('data-slide', idx);
          slide.setAttribute('data-exid', id);

          slide.innerHTML = `
            <div class="glass slideCard p-6 md:p-7">
              <div>
                <div class="flex items-start justify-between gap-3">
                  <div class="min-w-0">
                    <h3 class="text-3xl md:text-4xl font-black italic text-white tracking-tight truncate">${w.name}</h3>
                    <div class="mt-3 flex items-center gap-2 flex-wrap">
                      <span class="pill cyan">${w.target}</span>
                      <span class="pill">휴식 ${w.rest}s</span>
                      <span class="pill" data-role="progress">진행 ${doneCount}/${setTotal}</span>
                    </div>
                  </div>
                  <button onclick="resetExercise('${id}')" class="pill" title="이 운동(오늘) 초기화">
                    <i class="fa-solid fa-rotate-left"></i>
                  </button>
                </div>

                ${gif ? `
                  <div class="mt-4 glass rounded-2xl overflow-hidden border border-white/10" onclick="window.openAccountSheet && 0">
                    <img src="${gif}" style="width:100%; max-height:240px; object-fit:contain; background:rgba(255,255,255,0.03);" loading="lazy"
                      onerror="this.parentElement.style.display='none';"/>
                  </div>
                `:``}

                <div class="mt-5 grid md:grid-cols-2 gap-4">
                  <div class="space-y-3">
                    <div class="glass rounded-2xl p-4 border-white/5">
                      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45 mb-2">핵심 큐</p>
                      <p class="text-base md:text-lg font-black text-white/80 leading-relaxed">${w.cue || w.tip || ''}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                      <div class="bg-white/[0.02] p-4 rounded-2xl border border-white/5">
                        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-indigo-300 mb-2">호흡</p>
                        <p class="text-[13px] font-bold text-white/70">${w.breath}</p>
                      </div>
                      <div class="bg-white/[0.02] p-4 rounded-2xl border border-white/5">
                        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-indigo-300 mb-2">의식</p>
                        <p class="text-[13px] font-bold text-white/70">${w.mind}</p>
                      </div>

                      <div class="bg-cyan-400/[0.04] p-4 rounded-2xl border border-cyan-400/10 col-span-2">
                        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-cyan-300 mb-2">엘리트 가이드</p>
                        <p class="text-[13px] font-bold text-white/75">${w.tip} · <span class="text-white/45">${w.guide}</span></p>
                      </div>
                    </div>
                  </div>

                  <div class="rightPanel space-y-3">
                    <div class="glass rounded-2xl p-4 border-white/5">
                      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">세트/횟수 설정</p>
                      <p class="text-[11px] mt-2 font-bold text-white/45">* 세트 버튼을 눌러 체크합니다</p>
                    </div>

                    <div class="stepper">
                      <div>
                        <div class="stepperLabel">SET</div>
                        <div class="stepperValue" data-role="setTotal">${setTotal}</div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button class="stepperBtn" onclick="adjust('set','${id}',-1)"><i class="fa-solid fa-minus"></i></button>
                        <button class="stepperBtn" onclick="adjust('set','${id}',1)"><i class="fa-solid fa-plus"></i></button>
                      </div>
                    </div>

                    <div class="stepper">
                      <div>
                        <div class="stepperLabel">REP</div>
                        <div class="stepperValue" data-role="repTotal">${repTotal}</div>
                      </div>
                      <div class="flex items-center gap-2">
                        <button class="stepperBtn" onclick="adjust('rep','${id}',-1)"><i class="fa-solid fa-minus"></i></button>
                        <button class="stepperBtn" onclick="adjust('rep','${id}',1)"><i class="fa-solid fa-plus"></i></button>
                      </div>
                    </div>

                    <button class="bigBtn" onclick="resetSetRepToDefault('${id}')">
                      <i class="fa-solid fa-wand-magic-sparkles"></i>
                      세트/횟수 기본값
                    </button>

                    <div class="grid grid-cols-2 gap-3" data-role="setGrid">
                      ${renderSetButtonsHTML(id, w, date)}
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-5 flex items-center justify-between gap-2 flex-wrap">
                <div class="flex items-center gap-2">
                  <span class="pill cyan">${idx+1} / ${data.list.length}</span>
                  <span class="pill">${w.name}</span>
                </div>
                <div class="flex items-center gap-2">
                  <button class="pill" onclick="carouselPrev()"><i class="fa-solid fa-chevron-left"></i> 이전</button>
                  <button class="pill cyan" onclick="carouselNext()">다음 <i class="fa-solid fa-chevron-right"></i></button>
                </div>
              </div>
            </div>
          `;
          carousel.appendChild(slide);
        });

        bindSetButtons();
        bindCarouselEvents();
        updateSlideHUD();
        requestAnimationFrame(()=> scrollToSlide(currentSlideIndex,false));
      }else{
        const slide = carousel.querySelector(`.slide[data-slide="${currentSlideIndex}"]`);
        if(!slide) return;

        const w = data.list[currentSlideIndex];
        const exid = slide.getAttribute('data-exid');
        const setTotal = window.customSets[exid] || w.set;
        const doneArr = getProgressArr(date, exid, setTotal);
        const doneCount = doneArr.filter(Boolean).length;

        const progressTag = slide.querySelector('[data-role="progress"]');
        if(progressTag) progressTag.textContent = `진행 ${doneCount}/${setTotal}`;

        const setGrid = slide.querySelector('[data-role="setGrid"]');
        if(setGrid){
          setGrid.innerHTML = renderSetButtonsHTML(exid, w, date);
        }
        const setValue = slide.querySelector('[data-role="setTotal"]');
        if(setValue) setValue.textContent = setTotal;

        bindSetButtons();
      }
    }

    function renderSetButtonsHTML(id, w, date){
      const setTotal = window.customSets[id] || w.set;
      const doneArr = getProgressArr(date, id, setTotal);

      return Array.from({length:setTotal}).map((_, s)=>{
        const done = !!doneArr[s];
        const nextIndex = doneArr.indexOf(false);
        const isLocked = (!done && nextIndex !== -1 && s !== nextIndex);

        return `<button class="setBtn ${done?'done':''} ${isLocked?'locked':''}"
          ${isLocked ? 'disabled' : ''}
          data-date="${date}" data-ex="${id}" data-set="${s}">
          ${done ? `<i class='fa-solid fa-check'></i>` : ''}
          ${s+1} 세트
        </button>`;
      }).join('');
    }

    function bindCarouselEvents(){
      const carousel = document.getElementById('session-carousel');
      carousel.onscroll = () => {
        const slides = Array.from(carousel.children);
        if(!slides.length) return;
        const slideWidth = slides[0].getBoundingClientRect().width + 18;
        const idx = Math.round(carousel.scrollLeft / slideWidth);
        if(idx !== currentSlideIndex){
          currentSlideIndex = clamp(idx, 0, slides.length-1);
          updateSlideHUD();
        }
        showDockTemporarily();
      };
    }

    function updateSlideHUD(){
      const data = workoutData[currentDayIdx];
      const total = data.list.length;
      const idx = clamp(currentSlideIndex, 0, total-1);
      document.getElementById('slide-indicator').innerText = `${idx+1} / ${total}`;
      document.getElementById('slide-name').innerText = data.list[idx]?.name || '운동';

      const carousel = document.getElementById('session-carousel');
      Array.from(carousel.children).forEach((el, i)=>{
        el.classList.toggle('focus', i === idx);
        el.classList.toggle('peek', i !== idx);
      });
    }

    function scrollToSlide(idx, smooth=true){
      const carousel = document.getElementById('session-carousel');
      const slides = Array.from(carousel.children);
      if(!slides.length) return;
      idx = clamp(idx, 0, slides.length-1);
      const slideWidth = slides[0].getBoundingClientRect().width + 18;
      carousel.scrollTo({ left: slideWidth * idx, behavior: smooth ? 'smooth' : 'auto' });
    }

    function carouselNext(){
      const data = workoutData[currentDayIdx];
      currentSlideIndex = clamp(currentSlideIndex + 1, 0, data.list.length-1);
      scrollToSlide(currentSlideIndex, true);
      updateSlideHUD();
      haptic(10);
      showDockTemporarily();
    }

    function carouselPrev(){
      const data = workoutData[currentDayIdx];
      currentSlideIndex = clamp(currentSlideIndex - 1, 0, data.list.length-1);
      scrollToSlide(currentSlideIndex, true);
      updateSlideHUD();
      haptic(10);
      showDockTemporarily();
    }

    function bindSetButtons(){
      const buttons = document.querySelectorAll('.setBtn[data-ex]');
      buttons.forEach(btn => {
        const date = btn.getAttribute('data-date');
        const ex = btn.getAttribute('data-ex');
        const setIndex = Number(btn.getAttribute('data-set'));
        btn.onclick = () => toggleSetComplete(date, ex, setIndex);
      });
    }

    // ✅ 기록 toggle -> localStorage 변화 -> Firebase debounce 저장
    function toggleSetComplete(date, exerciseId, setIndex){
      unlockAudio();
      showDockTemporarily();

      const [dayIdx, exIdx] = exerciseId.split('-').map(Number);
      const w = workoutData[dayIdx]?.list?.[exIdx];
      if(!w) return;

      const setTotal = window.customSets[exerciseId] || w.set;
      const doneArr = getProgressArr(date, exerciseId, setTotal);
      const nextIndex = doneArr.indexOf(false);

      if(!doneArr[setIndex] && nextIndex !== -1 && setIndex !== nextIndex){
        haptic(10);
        toast("다음 세트를 먼저 완료하세요");
        return;
      }

      const repTotal = window.customReps[exerciseId] || w.rep;
      doneArr[setIndex] = !doneArr[setIndex];
      window.progressByDate[date][exerciseId] = doneArr;
      localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate));

      const setNo = setIndex + 1;
      const logKey = `${date}|${exerciseId}|${setNo}`;

      if(doneArr[setIndex]){
        if(!window.logs.some(l => l.logKey === logKey)){
          window.logs.push({
            id: Date.now(),
            logKey,
            date,
            ts: nowISO(),
            exerciseId,
            name: w.name,
            set: setNo,
            plannedSetTotal: setTotal,
            plannedRep: repTotal,
            repActual: repTotal, // ✅ modal 제거 대신 기본값 바로 기록
            rpe: null,
            restPlanned: w.rest,
            restUsed: w.rest,
            type: workoutData[currentDayIdx].type
          });
          localStorage.setItem(KEY_LOGS, JSON.stringify(window.logs));
        }

        // ✅ 타이머 즉시
        const restSec = w.rest || 0;
        if(restSec > 0) startTimer(restSec, logKey);

        window.renderCarousel(false);
        window.updateProgressUI();
        renderCalendar();

        haptic(16);
      }else{
        window.logs = window.logs.filter(l => l.logKey !== logKey);
        localStorage.setItem(KEY_LOGS, JSON.stringify(window.logs));

        window.renderCarousel(false);
        window.updateProgressUI();
        renderCalendar();
        haptic(12);
      }
    }

    function adjust(type, key, val){
      showDockTemporarily();

      const [d, idx] = key.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      if(!w) return;

      if(type === 'set'){
        const cur = window.customSets[key] || w.set;
        const next = clamp(cur + val, 1, 12);
        window.customSets[key] = next;
        localStorage.setItem(KEY_SETS, JSON.stringify(window.customSets));
        getProgressArr(todayStr(), key, next);
      }else{
        const cur = window.customReps[key] || w.rep;
        window.customReps[key] = clamp(cur + val, 1, 100);
        localStorage.setItem(KEY_REPS, JSON.stringify(window.customReps));
      }

      window.renderCarousel(false);
      window.updateProgressUI();
      toast("설정 저장됨");
      haptic(10);
    }

    function resetSetRepToDefault(exerciseId){
      showDockTemporarily();

      const [d, idx] = exerciseId.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      if(!w) return;

      if(window.customSets[exerciseId] !== undefined) delete window.customSets[exerciseId];
      if(window.customReps[exerciseId] !== undefined) delete window.customReps[exerciseId];
      localStorage.setItem(KEY_SETS, JSON.stringify(window.customSets));
      localStorage.setItem(KEY_REPS, JSON.stringify(window.customReps));

      getProgressArr(todayStr(), exerciseId, w.set);
      window.renderCarousel(false);
      window.updateProgressUI();
      toast("기본값으로 복원");
      haptic(18);
    }

    function resetExercise(exerciseId){
      showDockTemporarily();
      if(!confirm("이 운동의 오늘 기록을 초기화할까요?")) return;
      const date = todayStr();

      window.logs = window.logs.filter(l => !(l.date === date && l.exerciseId === exerciseId));
      localStorage.setItem(KEY_LOGS, JSON.stringify(window.logs));

      const [d, idx] = exerciseId.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      const setTotal = window.customSets[exerciseId] || w.set;
      if(window.progressByDate[date] && window.progressByDate[date][exerciseId]){
        window.progressByDate[date][exerciseId] = new Array(setTotal).fill(false);
        localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate));
      }

      window.renderCarousel(false);
      window.updateProgressUI();
      renderCalendar();
      toast("운동 초기화 완료");
      haptic(22);
    }

    function resetToday(){
      showDockTemporarily();
      if(!confirm('오늘 진행/기록을 모두 초기화할까요?')) return;
      const date = todayStr();

      window.logs = window.logs.filter(l => l.date !== date);
      localStorage.setItem(KEY_LOGS, JSON.stringify(window.logs));

      if(window.progressByDate[date]){ delete window.progressByDate[date]; localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate)); }

      window.renderCarousel(true);
      window.updateProgressUI();
      renderCalendar();
      toast("오늘 초기화 완료");
      haptic(25);
    }

    function showHUD(on){
      const hud = document.getElementById('timer-hud');
      if(!hud) return;
      hud.classList.toggle('show', !!on);
    }

    function updateHUD(){
      const timeEl = document.getElementById('hud-time');
      const bar = document.getElementById('hud-bar');
      if(!timeEl || !bar) return;
      timeEl.textContent = String(restRemaining).padStart(2,'0');
      const pct = restTotal ? Math.round(((restTotal - restRemaining)/restTotal)*100) : 0;
      bar.style.width = pct + '%';
    }

    function startTimer(sec, logKey=null){
      restRemaining = sec;
      restTotal = sec;
      restStartedAt = Date.now();
      restCurrentLogKey = logKey;

      const modal = document.getElementById('timer-modal');
      const display = document.getElementById('timer-sec');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=> modal.classList.add('opacity-100'));
      display.innerText = restRemaining;

      showHUD(true);
      updateHUD();

      clearInterval(timerInt);
      timerInt = setInterval(() => {
        restRemaining--;
        display.innerText = restRemaining;
        updateHUD();
        if(restRemaining <= 0) closeTimer(true);
      }, 1000);
    }

    function minimizeTimer(){
      showDockTemporarily();
      const modal = document.getElementById('timer-modal');
      modal.classList.remove('opacity-100');
      setTimeout(()=> modal.classList.add('hidden'), 450);
      showHUD(true);
      toast("타이머 최소화");
      haptic(10);
    }

    function openTimerFromHUD(){
      showDockTemporarily();
      const modal = document.getElementById('timer-modal');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=> modal.classList.add('opacity-100'));
      haptic(10);
    }

    function adjustRest(delta){
      showDockTemporarily();
      if(!timerInt) return;
      restRemaining = clamp(restRemaining + delta, 5, 600);
      restTotal = Math.max(restTotal, restRemaining);
      document.getElementById('timer-sec').innerText = restRemaining;
      updateHUD();
      haptic(10);
    }

    function closeTimer(finished=false){
      clearInterval(timerInt);
      timerInt = null;

      const modal = document.getElementById('timer-modal');
      modal.classList.remove('opacity-100');
      setTimeout(()=> modal.classList.add('hidden'), 450);

      showHUD(false);

      if(restStartedAt && restCurrentLogKey){
        const used = clamp(Math.round((Date.now() - restStartedAt) / 1000), 0, restTotal);
        const idx = window.logs.findIndex(l => l.logKey === restCurrentLogKey);
        if(idx !== -1){
          window.logs[idx].restUsed = used;
          localStorage.setItem(KEY_LOGS, JSON.stringify(window.logs));
        }
      }
      restStartedAt = null;
      restCurrentLogKey = null;

      if(finished){
        haptic(30);
        toast("휴식 끝! 다음 세트 ✅");
      }
    }

    function toggleNotif(){
      showDockTemporarily();
      window.restNotifEnabled = !window.restNotifEnabled;
      localStorage.setItem(KEY_NOTIF, window.restNotifEnabled ? '1' : '0');
      const btn = document.getElementById('notif-toggle');
      if(btn){
        btn.textContent = window.restNotifEnabled ? 'ON' : 'OFF';
        btn.classList.toggle('cyan', window.restNotifEnabled);
      }
      toast(window.restNotifEnabled ? "알림 ON" : "알림 OFF");
      haptic(14);
    }

    function renderCalendar(){
      document.getElementById('calendar-month').innerText = `${currentYear}.${String(currentMonth + 1).padStart(2,'0')}`;
      const first = new Date(currentYear, currentMonth, 1).getDay();
      const last = new Date(currentYear, currentMonth + 1, 0).getDate();
      const body = document.getElementById('calendar-body');
      body.innerHTML = '';

      for(let i=0;i<first;i++) body.innerHTML += '<div></div>';

      for(let d=1; d<=last; d++){
        const dStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hasLog = window.logs.some(l => l.date === dStr);

        const el = document.createElement('div');
        el.className = `calendar-day cursor-pointer ${dStr===todayStr()?'today':''} ${hasLog?'has-log':''}`;
        if(dStr === selectedDate) el.classList.add('selected');
        el.innerText = d;
        el.onclick = () => { selectedDate = dStr; renderCalendar(); showDockTemporarily(); };
        body.appendChild(el);
      }
      renderHistoryDetail();
    }

    function renderHistoryDetail(){
      const area = document.getElementById('history-detail');
      const dayLogs = window.logs
        .filter(l => l.date === selectedDate)
        .sort((a,b)=> (a.exerciseId > b.exerciseId ? 1 : -1) || (a.set - b.set));

      area.innerHTML = `<p class="text-[10px] font-black text-gray-400 tracking-widest uppercase px-2">${selectedDate} 리포트</p>`;

      if(dayLogs.length === 0){
        area.innerHTML += `<div class="glass rounded-[28px] p-12 text-center text-gray-500 italic text-xs">기록이 없습니다</div>`;
        return;
      }

      const totalSets = dayLogs.length;
      const avgRest = Math.round(dayLogs.reduce((a,c)=> a + (c.restUsed ?? c.restPlanned ?? 0), 0) / totalSets);

      area.innerHTML += `
        <div class="glass rounded-[28px] p-6 mb-2">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">요약</p>
              <h4 class="text-2xl font-black italic text-white mt-2">${Math.max(1, Math.round((avgRest + 45) * totalSets / 60))}분</h4>
              <p class="text-[10px] font-black text-white/35 tracking-[0.18em] uppercase mt-2">
                총 ${totalSets}세트 · 평균 휴식 ${avgRest}s
              </p>
            </div>
            <div class="text-right">
              <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/35">완료 운동</p>
              <p class="text-3xl font-black text-cyan-300 mt-2">${new Set(dayLogs.map(l=>l.exerciseId)).size}</p>
            </div>
          </div>
        </div>
      `;

      const groups = dayLogs.reduce((acc, o) => {
        if(!acc[o.exerciseId]) acc[o.exerciseId] = [];
        acc[o.exerciseId].push(o);
        return acc;
      }, {});

      Object.entries(groups).forEach(([exerciseId, data]) => {
        area.innerHTML += `
          <div class="glass rounded-[28px] p-6 border-l-4 border-cyan-400">
            <h4 class="font-black text-white italic">${data[0].name}</h4>
            <div class="mt-5 grid grid-cols-2 gap-3">
              ${data.map(row => `
                <div class="glass rounded-2xl p-4">
                  <div class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">${row.set} SET</div>
                  <div class="text-3xl font-black text-white mt-2">${row.repActual ?? row.plannedRep ?? "-"}</div>
                  <div class="text-[10px] font-black tracking-[0.18em] uppercase text-white/35 mt-2">REST ${(row.restUsed ?? row.restPlanned ?? "-")}s</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
    }

    function changeMonth(dir){
      showDockTemporarily();
      currentMonth += dir;
      if(currentMonth < 0){ currentMonth = 11; currentYear--; }
      if(currentMonth > 11){ currentMonth = 0; currentYear++; }
      renderCalendar();
    }

    function resetSelectedDate(){
      showDockTemporarily();
      if(!confirm('선택한 날짜의 기록을 초기화할까요?')) return;
      const date = selectedDate;
      window.logs = window.logs.filter(l => l.date !== date);
      localStorage.setItem(KEY_LOGS, JSON.stringify(window.logs));
      if(window.progressByDate[date]){ delete window.progressByDate[date]; localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(window.progressByDate)); }
      toast("선택 날짜 초기화");
      renderCalendar();
      haptic(25);
    }

    function renderStats(){
      const counts = { push:0, pull:0, leg:0, rest:0 };
      window.logs.forEach(l => counts[l.type] !== undefined && counts[l.type]++);

      document.getElementById('stat-total-sets').innerText = window.logs.length;
      document.getElementById('stat-week-count').innerText = new Set(window.logs.map(l => l.date)).size;

      const ctx = document.getElementById('radarChart').getContext('2d');
      if(window.myRadar) window.myRadar.destroy();

      window.myRadar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['PUSH','PULL','LEGS','REST'],
          datasets: [{
            data: [counts.push, counts.pull, counts.leg, counts.rest],
            backgroundColor: 'rgba(34,211,238,0.10)',
            borderColor: '#22d3ee',
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          scales: {
            r: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              angleLines: { color: 'rgba(255,255,255,0.05)' },
              pointLabels: { color: '#777', font: { weight: '800' } },
              ticks: { display: false }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function backupJSON(){
      showDockTemporarily();
      const payload = { version: 'v12.2', exportedAt: nowISO(), logs: window.logs, customSets: window.customSets, customReps: window.customReps, progressByDate: window.progressByDate };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `dk_fit_backup_${todayStr()}.json`;
      a.click();
      toast("백업 다운로드");
      haptic(18);
    }

    function resetAll(){
      showDockTemporarily();
      if(!confirm('⚠️ 모든 데이터(기록/설정/진행)를 초기화할까요?')) return;
      localStorage.removeItem(KEY_LOGS);
      localStorage.removeItem(KEY_SETS);
      localStorage.removeItem(KEY_REPS);
      localStorage.removeItem(KEY_PROGRESS_BY_DATE);
      localStorage.removeItem(KEY_SUMMARY_SHOWN);
      localStorage.removeItem(KEY_NOTIF);
      window.logs = []; window.customSets = {}; window.customReps = {}; window.progressByDate = {};
      window.restNotifEnabled = true;
      window.renderCarousel(true);
      window.updateProgressUI();
      renderCalendar();
      toast("전체 초기화 완료");
      haptic(30);
    }

    let dockTimer = null;
    function showDockTemporarily(){
      const dock = document.querySelector('.navDockWrap');
      if(!dock) return;

      dock.classList.remove('dock-hide');
      dock.classList.add('dock-show');

      if(dockTimer) clearTimeout(dockTimer);
      dockTimer = setTimeout(()=>{
        dock.classList.remove('dock-show');
        dock.classList.add('dock-hide');
      }, 1700);
    }

    ['scroll','touchstart','touchmove','click'].forEach(ev=>{
      window.addEventListener(ev, showDockTemporarily, {passive:true});
    });

    window.onload = async () => {
      await loadAppData();
      initIntro();
      await requestWakeLock();

      updateDayNav();
      changeDay(new Date().getDay());
      renderCalendar();

      const btn = document.getElementById('notif-toggle');
      if(btn){
        btn.textContent = window.restNotifEnabled ? 'ON' : 'OFF';
        btn.classList.toggle('cyan', window.restNotifEnabled);
      }

      setInterval(()=> {
        const totalSec = getWorkoutElapsedSec();
        const m = Math.floor(totalSec/60).toString().padStart(2,'0');
        const s = (totalSec%60).toString().padStart(2,'0');
        document.getElementById('stopwatch').innerText = `${m}:${s}`;
      }, 500);

      setTimeout(()=> {
        const dock = document.querySelector('.navDockWrap');
        dock && dock.classList.add('dock-hide');
      }, 1200);
    };
  </script>

</body>
</html>

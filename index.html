<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>DK MASTER OS v12.0 (History Pro + Weekly Compare + Rep Input + LiquidGlass Intro)</title>

  <!-- âœ… PWA / iOS Standalone -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DK Fit">
  <meta name="theme-color" content="#050507">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800;900&display=swap');

    :root{
      --primary:#22d3ee;
      --accent:#6366f1;
      --bg:#050507;
      --card:rgba(255,255,255,0.04);
      --dockH: 110px;
      --headerH: 92px;
    }

    html,body{ height:100%; }

    html{
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    body{
      font-family:'Pretendard',sans-serif;
      background-color:var(--bg);
      color:#e4e4e7;
      margin:0;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior: none;
      background-image:
        radial-gradient(1200px 700px at 15% -10%, rgba(34,211,238,0.18), transparent 55%),
        radial-gradient(1200px 700px at 100% 10%, rgba(99,102,241,0.22), transparent 55%),
        radial-gradient(900px 600px at 15% 110%, rgba(12,74,110,0.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      background-attachment: fixed;
    }

    ::-webkit-scrollbar{ display:none; }
    .scroll-hide{ -ms-overflow-style:none; scrollbar-width:none; }

    .glass{
      background:var(--card);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      border:1px solid rgba(255,255,255,0.10);
    }

    .layoutWrap{
      width:100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* =========================================================
       âœ… NEW Intro â€” Liquid Glass (Apple style)
    ========================================================= */
    #splash-screen{
      position:fixed; inset:0; z-index:10000;
      display:flex; align-items:center; justify-content:center;
      background:#050507;
      overflow:hidden;
      transition: opacity 1s cubic-bezier(0.65,0,0.35,1), transform 1s cubic-bezier(0.65,0,0.35,1);
    }

    /* Liquid blob background */
    #splash-screen::before{
      content:"";
      position:absolute;
      width: 110vmax;
      height: 110vmax;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background:
        radial-gradient(circle at 30% 30%, rgba(34,211,238,0.55), transparent 40%),
        radial-gradient(circle at 70% 60%, rgba(99,102,241,0.55), transparent 45%),
        radial-gradient(circle at 55% 20%, rgba(255,255,255,0.12), transparent 30%),
        radial-gradient(circle at 40% 80%, rgba(12,74,110,0.55), transparent 50%);
      filter: blur(12px);
      opacity: .9;
      animation: blobMove 7s ease-in-out infinite alternate;
    }

    @keyframes blobMove{
      0%{ transform: translate(-52%, -48%) scale(1); }
      100%{ transform: translate(-48%, -52%) scale(1.12); }
    }

    /* subtle noise */
    #splash-screen::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E");
      opacity:.12;
      mix-blend-mode: overlay;
      pointer-events:none;
    }

    #splash-screen .splash-card{
      position:relative;
      z-index:2;
      width:min(520px, calc(100vw - 48px));
      border-radius: 34px;
      padding: 42px 26px 34px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 40px 120px rgba(0,0,0,0.60);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      text-align:center;
      transform: translateY(14px) scale(.98);
      opacity:0;
      animation: splashIn 1.1s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes splashIn{
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .splash-logo{
      font-size: 4.2rem;
      font-weight: 950;
      letter-spacing: -0.09em;
      line-height: 1.0;
      background: linear-gradient(120deg, rgba(255,255,255,1), rgba(34,211,238,0.95), rgba(99,102,241,0.9));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 26px rgba(34,211,238,0.20));
      user-select:none;
    }

    .splash-pulse{
      margin-top: 18px;
      height: 4px;
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,0.08);
      position:relative;
    }
    .splash-pulse span{
      position:absolute; inset:0;
      width:45%;
      background: linear-gradient(90deg, rgba(34,211,238,0.0), rgba(34,211,238,1), rgba(99,102,241,1), rgba(34,211,238,0.0));
      animation: pulseScan 1.35s ease-in-out infinite;
      filter: drop-shadow(0 0 14px rgba(34,211,238,0.35));
    }
    @keyframes pulseScan{
      0%{ transform: translateX(-70%); }
      100%{ transform: translateX(170%); }
    }
    .splash-mini{
      margin-top: 16px;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.45);
    }

    /* Header */
    header{
      position:fixed; top:0; left:0; right:0; z-index:50;
      padding: 18px 18px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      background: rgba(10,10,12,0.62);
      height: var(--headerH);
      box-sizing:border-box;
      padding-top: calc(14px + env(safe-area-inset-top));
    }

    .tab-content{ display:none; animation:fadeInContent 0.45s ease-out; }
    .tab-content.active{ display:block; }
    @keyframes fadeInContent{ from{opacity:0; transform:translateY(6px) scale(0.985);} to{opacity:1; transform:translateY(0) scale(1);} }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      font-size:11px; font-weight:900;
      color:rgba(255,255,255,0.82);
      white-space:nowrap;
      user-select:none;
    }
    .pill.cyan{ border-color:rgba(34,211,238,0.25); background:rgba(34,211,238,0.10); color:rgba(34,211,238,0.95); }

    main{
      padding-top: calc(var(--headerH) + 18px + env(safe-area-inset-top));
      padding-bottom: calc(var(--dockH) + env(safe-area-inset-bottom) + 28px);
    }

    /* Carousel */
    .carousel{
      display:flex;
      gap:18px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 0 22px 18px;
      margin: 0 -22px;
      touch-action: pan-x pan-y;
    }
    .carousel::before,.carousel::after{ content:''; flex:0 0 22px; }

    .carousel > .slide{
      scroll-snap-align:center;
      flex: 0 0 calc(100% - 120px);
      min-height: auto;
      transition: opacity .22s ease, transform .22s ease, filter .22s ease;
    }
    .slide.peek{ opacity:.60; transform:scale(.965); filter:blur(.6px); }
    .slide.focus{ opacity:1; transform:scale(1); filter:none; }

    @media (min-width: 860px){
      .carousel > .slide{ flex:0 0 calc(100% - 160px); }
      .slide.peek{ opacity:.62; transform:scale(.97); filter:blur(.45px); }
    }

    .slideCard{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      border-radius:32px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }

    .rightPanel{ border-radius:26px; padding:18px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); }

    .stepper{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 14px; border-radius:22px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
    }
    .stepperLabel{ font-size:10px; font-weight:900; letter-spacing:.18em; text-transform:uppercase; color:rgba(255,255,255,0.50); }
    .stepperValue{ font-size:22px; font-weight:950; color:white; }

    .stepperBtn{
      width:48px; height:48px; border-radius:18px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      color:rgba(255,255,255,0.9);
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      transition: transform .08s ease;
    }
    .stepperBtn:active{ transform:scale(.98); }

    .bigBtn{
      width:100%; height:60px; border-radius:20px;
      font-weight:900; font-size:15px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .10s ease;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
    }
    .bigBtn:active{ transform:scale(0.985); }

    .setBtn{
      width:100%; height:66px; border-radius:20px;
      font-weight:950; font-size:18px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .10s ease, background .2s ease, opacity .2s ease;
      -webkit-tap-highlight-color:transparent;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      user-select:none;
      overflow:hidden;
    }
    .setBtn:active{ transform:scale(0.985); }
    .setBtn.done{ background:linear-gradient(135deg,var(--primary),var(--accent)); color:#000; box-shadow:0 18px 34px rgba(34,211,238,0.24); border:none; }
    .setBtn.locked{
      opacity: .35;
      filter: saturate(.6);
      pointer-events: none;
    }

    /* Dock */
    .navDockWrap{ position:fixed; left:0; right:0; bottom:0; padding: 18px; z-index:60; }
    .nav-dock{
      background:rgba(10,10,12,0.78);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter:blur(22px);
      border-radius:34px;
      padding:10px;
      display:flex;
      justify-content:space-around;
      align-items:center;
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.7);
    }
    .nav-item{ position:relative; padding:12px 0; flex:1; display:flex; flex-direction:column; align-items:center; gap:5px; transition:all .25s; color:#777; -webkit-tap-highlight-color:transparent; user-select:none; }
    .nav-item.active{ color:var(--primary); transform:translateY(-3px); }
    .nav-item i{ font-size:1.25rem; }
    .nav-active-dot{ position:absolute; bottom:1px; width:4px; height:4px; background:var(--primary); border-radius:50%; box-shadow:0 0 12px var(--primary); opacity:0; transition:all .25s; }
    .nav-item.active .nav-active-dot{ opacity:1; transform:scale(1.6); }

    .navDockWrap{
      transition: transform .45s cubic-bezier(0.22, 1, 0.36, 1), opacity .35s ease;
      will-change: transform, opacity;
    }
    .navDockWrap.dock-hide{
      transform: translateY(120%);
      opacity: 0;
      pointer-events: none;
    }
    .navDockWrap.dock-show{
      transform: translateY(0%);
      opacity: 1;
      pointer-events: auto;
    }

    /* Day chips */
    .day-chip{
      width:44px; height:44px;
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      flex:0 0 auto;
      user-select:none;
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }
    .day-chip.active{
      background:var(--primary);
      color:#000;
      border-color:rgba(34,211,238,0.25);
      box-shadow:0 10px 24px rgba(34,211,238,0.25);
    }

    /* Timer Modal */
    #timer-modal{ transition:all .65s ease; }
    #timer-sec{ letter-spacing:-0.08em; }

    /* Timer HUD */
    #timer-hud{
      position:fixed;
      top: calc(var(--headerH) + 10px + env(safe-area-inset-top));
      right: 14px;
      z-index: 210;
      display:none;
    }
    #timer-hud.show{ display:block; }
    .hudCard{
      border-radius: 22px;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      background:rgba(10,10,12,0.72);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(22px);
      box-shadow:0 20px 40px rgba(0,0,0,0.55);
      min-width: 170px;
      user-select:none;
    }
    .hudTime{
      font-weight: 950;
      font-size: 22px;
      letter-spacing: -0.06em;
      color:white;
      line-height:1;
    }
    .hudLabel{ font-size: 9px; font-weight: 900; letter-spacing: .18em; text-transform: uppercase; color: rgba(255,255,255,0.45); }
    .hudBarWrap{
      width:100%;
      height:6px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      margin-top:8px;
    }
    .hudBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius:999px;
      box-shadow: 0 0 14px rgba(34,211,238,0.35);
    }
    .hudBtn{
      width:34px;height:34px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
    }
    .hudBtn:active{ transform:scale(.98); }

    /* Summary modal */
    #summary-modal{ position:fixed; inset:0; z-index:220; display:none; align-items:center; justify-content:center; }
    #summary-modal.show{ display:flex; }

    /* Toast */
    #toast{ position:fixed; left:50%; bottom:130px; transform:translateX(-50%); z-index:250; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    /* History layout */
    .historyLayout{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media(min-width: 900px){
      .historyLayout{
        grid-template-columns: 360px 1fr;
      }
    }

    /* Calendar */
    .calendar-day{ aspect-ratio:1; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:13px; position:relative; transition:all .18s; font-weight:800; color:rgba(255,255,255,0.75); background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); user-select:none;}
    .has-log::after{ content:''; width:6px; height:6px; background:rgba(34,211,238,0.90); border-radius:50%; position:absolute; bottom:8px; box-shadow:0 0 12px rgba(34,211,238,0.35); }
    .calendar-day.selected{ background:rgba(34,211,238,0.14); border:1px solid rgba(34,211,238,0.35); box-shadow:0 0 0 2px rgba(34,211,238,0.18), 0 0 30px rgba(34,211,238,0.12); color:#eaffff; font-weight:900; transform:translateY(-2px); }
    .calendar-day.today{ border:1px solid rgba(255,255,255,0.12); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); color:rgba(255,255,255,0.95); font-weight:900; }

    /* =========================================================
       âœ… Bottom Sheet (ìš´ë™ ìƒì„¸) - GIF size adjusted
    ========================================================= */
    #detail-sheet{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none;
      pointer-events: none;
    }
    #detail-sheet.show{
      display: block;
      pointer-events: auto;
    }
    .sheet-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 1;
      pointer-events: auto;
    }
    .sheet{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      border-radius: 26px 26px 0 0;
      background: rgba(10,10,12,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 -24px 80px rgba(0,0,0,0.75);
      transform: translateY(100%);
      transition: transform .45s cubic-bezier(0.22,1,0.36,1);
      z-index: 2;
      pointer-events: auto;
      padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
      isolation: isolate;
      max-height: 88vh;
      overflow: hidden;
    }
    #detail-sheet.show .sheet{
      transform: translateY(0%);
    }
    .sheetHeader{
      padding: 16px 18px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sheetTitle{
      font-weight: 950;
      font-size: 18px;
      letter-spacing: -0.03em;
      color: white;
    }
    .sheetSub{
      margin-top: 4px;
      font-size: 10px;
      letter-spacing: .22em;
      font-weight: 900;
      text-transform: uppercase;
      color: rgba(255,255,255,0.40);
    }
    .sheetClose{
      width:44px; height:44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.85);
      z-index: 3;
      pointer-events: auto;
      -webkit-tap-highlight-color:transparent;
    }
    .sheetClose:active{ transform: scale(.98); }

    .sheetBody{
      padding: 16px 18px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(88vh - 90px);
    }

    .sheetTabs{
      display:flex;
      gap:10px;
      padding: 0 0 14px;
      overflow-x:auto;
    }
    .sheetTab{
      flex: 0 0 auto;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.75);
      -webkit-tap-highlight-color:transparent;
    }
    .sheetTab.active{
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color:#000;
      border: none;
      box-shadow: 0 14px 32px rgba(34,211,238,0.18);
    }

    .sheetBox{
      border-radius: 22px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 14px 14px;
      margin-bottom: 12px;
    }
    .sheetLabel{
      font-size: 10px;
      letter-spacing: .20em;
      font-weight: 950;
      text-transform: uppercase;
      color: rgba(255,255,255,0.42);
    }
    .sheetText{
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.55;
      font-weight: 800;
      color: rgba(255,255,255,0.88);
      letter-spacing: -0.01em;
    }
    .sheetHint{
      margin-top: 10px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,0.45);
      line-height: 1.4;
    }

    /* âœ… FIX: ìƒì„¸ GIF ë„ˆë¬´ í° ë¬¸ì œ í•´ê²° */
    .sheetGif{
      width: 100%;
      max-height: 220px; /* âœ… ì ì • í¬ê¸° */
      border-radius: 18px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 22px 55px rgba(0,0,0,0.65);
      display:block;
      object-fit: contain;
      background: rgba(255,255,255,0.03);
    }

    /* Card GIF square */
    .cardGifSquareWrap{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 22px 55px rgba(0,0,0,0.55);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    .cardGifSquareWrap:active{ transform: scale(0.99); }
    .cardGifSquare{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: rgba(0,0,0,0.15);
    }

    /* âœ… REP Input Modal */
    #rep-modal{
      position:fixed;
      inset:0;
      z-index: 9998;
      display:none;
      align-items:center;
      justify-content:center;
    }
    #rep-modal.show{ display:flex; }
    .repCard{
      width:min(520px, calc(100vw - 44px));
      border-radius: 28px;
      padding: 20px;
      background: rgba(12,12,14,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 40px 120px rgba(0,0,0,0.70);
      backdrop-filter: blur(24px);
    }
    .repBtn{
      height:54px;
      border-radius: 18px;
      font-weight: 950;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .08s ease;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .repBtn:active{ transform:scale(.985); }
    .repBtn.primary{
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color:#000;
      border:none;
      box-shadow: 0 18px 34px rgba(34,211,238,0.18);
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .layoutWrap{ padding-left: 0; padding-right: 0; }
      main .layoutWrap.px-4{ padding-left: 14px !important; padding-right: 14px !important; }

      header{
        padding: 14px 14px 10px !important;
        height: 88px;
        padding-top: calc(10px + env(safe-area-inset-top)) !important;
      }
      :root{ --headerH: 88px; --dockH: 92px; }

      #view-day{
        font-size: 1.38rem !important;
        letter-spacing: -0.02em !important;
      }
      #view-title{
        font-size: 0.95rem !important;
        margin-top: 2px !important;
        opacity: 0.9;
      }
      #view-subcue{
        margin-top: 6px !important;
        font-size: 9px !important;
      }

      #progress-percent{
        font-size: 16px !important;
        font-weight: 950 !important;
        margin-bottom: 6px !important;
        letter-spacing: -0.02em;
      }
      header .w-28{
        width: 140px !important;
        height: 8px !important;
      }

      .slideCard{ border-radius: 24px; }
      .slideCard .p-6{ padding: 14px !important; }
      .slideCard h3{ font-size: 1.55rem !important; }

      .slideCard .md\:grid-cols-2{ grid-template-columns: 1fr !important; }

      .rightPanel{
        padding: 14px !important;
        border-radius: 22px !important;
      }

      .stepperBtn{
        width: 44px !important;
        height: 44px !important;
        border-radius: 16px !important;
      }
      .stepperValue{ font-size: 20px !important; }

      .rightPanel .grid.grid-cols-2{
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
      }
      .setBtn{
        height: 54px !important;
        font-size: 15px !important;
        border-radius: 18px !important;
      }

      .carousel > .slide{
        flex: 0 0 calc(100% - 70px) !important;
      }

      .navDockWrap{ padding: 14px !important; }
      .nav-dock{ border-radius: 30px !important; padding: 9px !important; }
      .nav-item{ padding: 10px 0 !important; }
      .nav-item i{ font-size: 1.15rem !important; }
    }
  </style>
</head>

<body>

  <!-- âœ… Splash (Liquid Glass) -->
  <div id="splash-screen">
    <div class="splash-card">
      <div class="splash-logo">DK Fit</div>
      <div class="splash-pulse"><span></span></div>
      <div class="splash-mini">READY</div>
    </div>
  </div>

  <!-- âœ… Bottom Sheet (ìš´ë™ ìƒì„¸) -->
  <div id="detail-sheet">
    <div class="sheet-backdrop" onclick="closeDetailSheet()"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div>
          <div class="sheetTitle" id="sheet-title">ìš´ë™ ìƒì„¸</div>
          <div class="sheetSub" id="sheet-sub">DETAIL</div>
        </div>
        <button class="sheetClose" onclick="closeDetailSheet()" aria-label="ë‹«ê¸°">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="sheetBody">
        <div class="sheetTabs" id="sheet-tabs"></div>
        <div id="sheet-body"></div>
      </div>
    </div>
  </div>

  <!-- âœ… REP Input Modal -->
  <div id="rep-modal">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-xl" onclick="closeRepModal(false)"></div>
    <div class="repCard relative">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-[10px] font-black tracking-[0.2em] uppercase text-white/45">REP ì…ë ¥</p>
          <h3 id="rep-title" class="text-2xl font-black italic text-white mt-1">ìš´ë™</h3>
          <p id="rep-sub" class="text-[11px] font-black text-white/45 mt-2 tracking-[0.18em] uppercase">SET</p>
        </div>
        <button class="pill" onclick="closeRepModal(false)">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="mt-5 glass rounded-2xl p-4">
        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">ê¸°ë³¸ REP</p>
        <div class="flex items-end justify-between mt-3">
          <div class="text-5xl font-black italic text-white" id="rep-base">0</div>
          <div class="text-right">
            <div class="text-[10px] font-black text-white/45 tracking-[0.18em] uppercase">ì¶”ì²œ ì…ë ¥</div>
            <div class="text-[12px] font-black text-white/70 mt-1">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°”ë¡œ ê¸°ë¡</div>
          </div>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button class="repBtn" onclick="repQuick(-5)"><i class="fa-solid fa-minus"></i> -5</button>
        <button class="repBtn" onclick="repQuick(+5)"><i class="fa-solid fa-plus"></i> +5</button>
        <button class="repBtn" onclick="repQuick(-3)"><i class="fa-solid fa-minus"></i> -3</button>
        <button class="repBtn" onclick="repQuick(+3)"><i class="fa-solid fa-plus"></i> +3</button>
        <button class="repBtn" onclick="repQuick(-2)"><i class="fa-solid fa-minus"></i> -2</button>
        <button class="repBtn" onclick="repQuick(+2)"><i class="fa-solid fa-plus"></i> +2</button>
        <button class="repBtn" onclick="repQuick(-1)"><i class="fa-solid fa-minus"></i> -1</button>
        <button class="repBtn" onclick="repQuick(+1)"><i class="fa-solid fa-plus"></i> +1</button>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button class="repBtn primary" onclick="repSkip()">
          <i class="fa-solid fa-forward"></i> ìŠ¤í‚µ(ê¸°ë³¸ REP)
        </button>
        <button class="repBtn" onclick="closeRepModal(false)">
          <i class="fa-solid fa-ban"></i> ì·¨ì†Œ
        </button>
      </div>

      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/35 mt-5">
        * ê¸°ë¡ í›„ ì§€ë‚œì£¼ ë™ì¼ ìš”ì¼/ë™ì¼ ìš´ë™ê³¼ ë¹„êµ ê²°ê³¼ê°€ í† ìŠ¤íŠ¸ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
      </p>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="layoutWrap flex justify-between items-end">
      <div>
        <div class="flex items-end gap-3">
          <h2 id="stopwatch" class="text-3xl font-black font-mono tracking-tighter text-white">00:00</h2>
          <button id="sw-toggle" class="pill cyan" onclick="toggleStopwatch()">
            <i class="fa-solid fa-pause"></i> ì¼ì‹œì •ì§€
          </button>
        </div>
        <div class="flex items-center gap-2 mt-1">
          <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
          <p class="text-[9px] font-black text-gray-300 tracking-widest uppercase">ì—˜ë¦¬íŠ¸ ëª¨ë“œ Â· DK</p>
        </div>
      </div>
      <div class="flex flex-col items-end">
        <span id="progress-percent" class="text-[10px] font-black mb-1.5 text-cyan-300">0%</span>
        <div class="w-28 h-1.5 bg-white/5 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-cyan-400 shadow-[0_0_12px_#22d3ee] transition-all duration-700" style="width:0%"></div>
        </div>
        <div id="progress-text" class="text-[10px] font-black text-white/55 mt-2 tracking-[0.18em] uppercase">
          0% ì™„ë£Œ!
        </div>
      </div>
    </div>
  </header>

  <!-- Timer HUD -->
  <div id="timer-hud">
    <div class="hudCard">
      <div class="min-w-[70px]">
        <div class="hudLabel">REST</div>
        <div id="hud-time" class="hudTime">60</div>
        <div class="hudBarWrap"><div id="hud-bar" class="hudBar"></div></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="hudBtn" onclick="openTimerFromHUD()" title="íƒ€ì´ë¨¸ ë³´ê¸°"><i class="fa-solid fa-expand"></i></button>
        <button class="hudBtn" onclick="closeTimer(false)" title="ìŠ¤í‚µ"><i class="fa-solid fa-forward"></i></button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main>
    <div class="layoutWrap px-4">

      <!-- Session -->
      <section id="tab-session" class="tab-content active">
        <div class="mb-4 mt-2 px-2 flex justify-between items-start">
          <div>
            <h1 id="view-day" class="text-5xl font-black italic text-white uppercase tracking-tighter">DAY</h1>
            <p id="view-title" class="text-gray-300 font-black mt-1 text-sm tracking-wide"></p>
            <p id="view-subcue" class="text-[10px] font-black text-white/50 mt-2 tracking-[0.18em] uppercase"></p>
          </div>
          <button onclick="resetToday()" class="pill" title="ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”">
            <i class="fa-solid fa-rotate-left"></i> ì˜¤ëŠ˜ ì´ˆê¸°í™”
          </button>
        </div>

        <div id="day-nav-wrap" class="mb-3">
          <div id="day-nav" class="flex justify-center gap-2 overflow-x-auto pb-2 scroll-hide"></div>
        </div>

        <div class="flex items-center justify-between px-2 mb-4">
          <div class="flex items-center gap-2">
            <span class="pill cyan" id="slide-indicator">1 / 1</span>
            <span class="pill" id="slide-name">ìš´ë™</span>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="carouselPrev()" class="pill"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="carouselNext()" class="pill"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
        </div>

        <div id="session-carousel" class="carousel scroll-hide"></div>
      </section>

      <!-- Stats -->
      <section id="tab-stats" class="tab-content">
        <div class="mb-8 px-2">
          <h2 class="text-3xl font-black italic uppercase tracking-tight">ë¶„ì„</h2>
          <p class="text-[11px] font-black text-white/45 mt-2 tracking-[0.18em] uppercase">
            í›ˆë ¨ì˜ í¸í–¥/ë°¸ëŸ°ìŠ¤ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
          </p>
        </div>

        <div class="glass rounded-[28px] p-8 mb-6">
          <canvas id="radarChart" class="max-h-[320px]"></canvas>
        </div>

        <div class="grid grid-cols-2 gap-5 mb-6">
          <div class="glass rounded-[28px] p-6">
            <p class="text-[9px] text-gray-400 font-black uppercase mb-2 tracking-widest">ì´ ê¸°ë¡(ì„¸íŠ¸)</p>
            <p id="stat-total-sets" class="text-4xl font-black text-white">0</p>
          </div>
          <div class="glass rounded-[28px] p-6">
            <p class="text-[9px] text-gray-400 font-black uppercase mb-2 tracking-widest">í™œë™ ì¼ìˆ˜</p>
            <p id="stat-week-count" class="text-4xl font-black text-indigo-300">0</p>
          </div>
        </div>

        <div class="glass rounded-[28px] p-6 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">íœ´ì‹ íƒ€ì´ë¨¸ ì•Œë¦¼</p>
              <p class="text-sm font-black text-white/70 mt-2">íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì†Œë¦¬/ì§„ë™</p>
            </div>
            <button id="notif-toggle" class="pill cyan" onclick="toggleNotif()">ON</button>
          </div>
          <p class="text-[11px] font-black text-white/35 mt-3">
            * iOSëŠ” ë¬´ìŒëª¨ë“œì—ì„œ ì†Œë¦¬ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. iPadëŠ” ì§„ë™ì´ ì§€ì›ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div class="grid gap-3">
          <button onclick="backupJSON()" class="bigBtn"><i class="fa-solid fa-download"></i> ë°±ì—…(JSON)</button>
          <button onclick="resetAll()" class="bigBtn" style="border-color: rgba(255,255,255,0.18);"><i class="fa-solid fa-triangle-exclamation"></i> ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </section>

      <!-- History -->
      <section id="tab-history" class="tab-content">
        <div class="mb-6 px-2 flex justify-between items-end">
          <h2 class="text-3xl font-black italic uppercase">ê¸°ë¡</h2>
          <div class="flex items-center gap-4 glass rounded-2xl px-5 py-2.5">
            <button onclick="changeMonth(-1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-left text-xs"></i></button>
            <span id="calendar-month" class="text-xs font-black w-20 text-center tracking-widest">2026.01</span>
            <button onclick="changeMonth(1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-right text-xs"></i></button>
          </div>
        </div>

        <div class="historyLayout">
          <div>
            <div class="glass rounded-[28px] p-6 mb-4 shadow-2xl">
              <div class="grid grid-cols-7 text-center text-[9px] font-black text-gray-500 mb-5 uppercase tracking-[0.2em]">
                <div class="text-red-600">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-600">í† </div>
              </div>
              <div id="calendar-body" class="grid grid-cols-7 gap-3"></div>
            </div>

            <button onclick="resetSelectedDate()" class="pill w-full justify-center">
              <i class="fa-solid fa-eraser"></i> ì„ íƒ ë‚ ì§œ ì´ˆê¸°í™”
            </button>
          </div>

          <div>
            <div id="history-detail" class="space-y-6"></div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Bottom Dock -->
  <div class="navDockWrap">
    <div class="layoutWrap">
      <nav class="nav-dock" style="margin-bottom: calc(env(safe-area-inset-bottom) + 6px);">
        <button onclick="showTab('session', this)" class="nav-item active">
          <i class="fa-solid fa-bolt-lightning"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">í›ˆë ¨</span>
          <div class="nav-active-dot"></div>
        </button>
        <button onclick="showTab('stats', this)" class="nav-item">
          <i class="fa-solid fa-chart-simple"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">ë¶„ì„</span>
          <div class="nav-active-dot"></div>
        </button>
        <button onclick="showTab('history', this)" class="nav-item">
          <i class="fa-solid fa-calendar-days"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">ê¸°ë¡</span>
          <div class="nav-active-dot"></div>
        </button>
      </nav>
    </div>
  </div>

  <!-- REST TIMER MODAL -->
  <div id="timer-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden opacity-0">
    <div class="absolute inset-0 bg-black/95 backdrop-blur-2xl"></div>
    <div class="relative text-center">
      <div class="miniHint mb-3 text-[10px] font-black tracking-[0.2em] uppercase text-white/35">íœ´ì‹</div>
      <div id="timer-sec" class="text-[14rem] font-black text-white italic tracking-tighter leading-none mb-6 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]">00</div>

      <div class="flex items-center justify-center gap-3">
        <button onclick="adjustRest(-10)" class="glass px-7 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">-10</button>
        <button onclick="minimizeTimer()" class="glass px-10 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">ìµœì†Œí™”</button>
        <button onclick="adjustRest(10)" class="glass px-7 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">+10</button>
      </div>

      <div class="mt-4 flex items-center justify-center gap-3">
        <button onclick="closeTimer(false)" class="pill"><i class="fa-solid fa-forward"></i> ìŠ¤í‚µ</button>
      </div>

      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/40 mt-6">ìµœì†Œ ë°©í•´ Â· ìµœëŒ€ ì§‘ì¤‘</p>
    </div>
  </div>

  <!-- SUMMARY MODAL -->
  <div id="summary-modal">
    <div class="absolute inset-0 bg-black/85 backdrop-blur-xl" onclick="closeSummary()"></div>
    <div class="relative glass rounded-[28px] p-7 w-[min(520px,calc(100vw-44px))]">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-[10px] font-black tracking-[0.2em] uppercase text-white/45">ì˜¤ëŠ˜ ìš”ì•½</p>
          <h3 class="text-2xl font-black italic text-white mt-1">ì™„ë£Œ ğŸ‰</h3>
        </div>
        <button class="pill" onclick="closeSummary()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <div class="glass rounded-2xl p-4">
          <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì™„ë£Œ ì„¸íŠ¸</p>
          <p id="sum-sets" class="text-3xl font-black text-white mt-2">0</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì™„ë£Œ ìš´ë™</p>
          <p id="sum-ex" class="text-3xl font-black text-white mt-2">0</p>
        </div>
        <div class="glass rounded-2xl p-4 col-span-2">
          <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì˜¤ëŠ˜ í•œë§ˆë””</p>
          <p id="sum-msg" class="text-base font-black text-white/80 mt-2">ì¢‹ì€ í›ˆë ¨ì´ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button class="bigBtn" onclick="closeSummary()" style="background:linear-gradient(135deg,var(--primary),var(--accent)); color:#000; border:none;">
          <i class="fa-solid fa-check"></i> í™•ì¸
        </button>
        <button class="bigBtn" onclick="showTab('history', document.querySelectorAll('.nav-item')[2]); closeSummary();">ê¸°ë¡ ë³´ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="pill cyan"></div>

  <script>
    /* =========================================================
      DK MASTER OS v12.0
      âœ… History Pro + Weekly Compare + Rep Input + Liquid Intro
      âœ… Set complete UI instantly updates
      âœ… Rep input modal w/ quick +/- buttons + skip
      âœ… Better alert sound (no blink)
      âœ… Progress text: "xx% ì™„ë£Œ!"
      âœ… StopWatch pause/resume
      âœ… Keep screen awake (Wake Lock API best-effort)
    ========================================================= */

    /* ---------- Wake Lock (Keep Screen On) ---------- */
    let wakeLock = null;
    async function requestWakeLock(){
      try{
        if('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', ()=> {});
          toast('í™”ë©´ êº¼ì§ ë°©ì§€ ON');
        }
      }catch(e){}
    }
    async function releaseWakeLock(){
      try{ if(wakeLock){ await wakeLock.release(); wakeLock=null; } }catch(e){}
    }
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible'){
        requestWakeLock();
      }else{
        releaseWakeLock();
      }
    });

    /* ---------- GIF ë§¤ì¹­ í—¬í¼ ---------- */
    function getGifByExerciseName(name){
      const n = (name || '').toLowerCase();
      if(n.includes('ìŠ¤ì¿¼íŠ¸') || n.includes('squat')) return 'AIR_SQT.gif';
      if(n.includes('ì¹œì—…') || n.includes('chin')) return 'CHIN_UP.gif';
      if(n.includes('ì‚¬ì´ë“œ ë ˆì´ì¦ˆ') || n.includes('side raise') || n.includes('ë ˆí„°ëŸ´') || n.includes('lateral')) return 'DB_LAT_RAISE.gif';
      if(n.includes('ë”¥ìŠ¤') || n.includes('dips')) return 'DIPS.gif';
      if(n.includes('ì¸ë²„í‹°ë“œ ë¡œìš°') || n.includes('inverted row') || n.includes('invt')) return 'INVT_ROW.gif';
      if(n.includes('ëŸ°ì§€') || n.includes('lunge')) return 'LUNGE.gif';
      if(n.includes('íŒŒì´í¬ í‘¸ì‰¬ì—…') || n.includes('pike')) return 'PIKE_PUSH_UP.gif';
      if(n.includes('í”Œë­í¬') || n.includes('plank')) return 'PLANK.gif';
      if(n.includes('í’€ì—…') || n.includes('pull up') || n.includes('pullup') || n.includes('ì™€ì´ë“œ í’€ì—…') || n.includes('ë‚´ë¡œìš° í’€ì—…')) return 'PULL_UP.gif';
      if(n.includes('í‘¸ì‰¬ì—…') || n.includes('push up') || n.includes('pushup') || n.includes('ë””í´ë¼ì¸')) return 'PUSH_UP.gif';
      return '';
    }

    /* ---------- DATA ---------- */
    const workoutData = {
      1: { day: "ì›”ìš”ì¼", type: "push", title: "ê°€ìŠ´ & ì‚¼ë‘", list: [
        { name: "ì²´ìŠ¤íŠ¸ ë”¥ìŠ¤", set: 4, rep: 10, rest: 90, breath: "ë‚´ë ¤ê°ˆ ë•Œ í¡ê¸° / ì˜¬ë¼ì˜¬ ë•Œ í˜¸ê¸°", target: "ê°€ìŠ´ í•˜ë¶€", mind: "ë°”ë‹¥ì„ ê°€ìŠ´ìœ¼ë¡œ ë°€ì–´ë‚´ê¸°", tip: "ìƒì²´ 15ë„ ìˆ™ì´ê¸°", guide: "ë°œì„ ëŒ€ê³  ë¬´ê²Œ ì¡°ì ˆ ê°€ëŠ¥", cue: "ì‹œì„  ë°”ë‹¥ 1~2m + íŒ” 95%ë§Œ í´ ê¸´ì¥ ìœ ì§€" },
        { name: "ìŠ¤íƒ ë‹¤ë“œ í‘¸ì‰¬ì—…", set: 4, rep: 15, rest: 75, breath: "ë‚´ë¦´ ë•Œ í¡ê¸° / ë°€ ë•Œ í˜¸ê¸°", target: "ê°€ìŠ´ ì „ì²´", mind: "ì§€ë©´ì„ ê°€ìŠ´ìœ¼ë¡œ ëˆ„ë¥´ê¸°", tip: "ì†ë°”ë‹¥ ì „ì²´ ì ‘ì§€", guide: "ë¬´ë¦ ëŒ€ê³  ìˆ˜í–‰ ê°€ëŠ¥", cue: "ê²¨ë“œë‘ì´ë¥¼ ë¶™ì´ë©° ë°€ì–´ ì˜¬ë¦¬ê¸°" },
        { name: "ë‚´ë¡œìš° ë”¥ìŠ¤", set: 3, rep: 10, rest: 60, breath: "íŒ” í¼ ë•Œ í˜¸ê¸°", target: "ì‚¼ë‘ê·¼", mind: "íŒ” ë’·ë©´ì˜ í˜ìœ¼ë¡œ ì ê¸ˆ", tip: "ìƒì²´ ìˆ˜ì§ ìœ ì§€", guide: "íŒ”ê¿ˆì¹˜ë¥¼ ëª¸ì— ë°€ì°©", cue: "ìƒì²´ ìˆ˜ì§ + íŒ”ê¿ˆì¹˜ ë’¤ë¡œ ëª¨ìœ¼ê¸°" }
      ]},
      2: { day: "í™”ìš”ì¼", type: "pull", title: "ë“± ë‘ê»˜", list: [
        { name: "í’€ì—… (ë°´ë“œ)", set: 4, rep: 8, rest: 120, breath: "ë‹¹ê¸¸ ë•Œ í˜¸ê¸°", target: "ê´‘ë°° ë°”ê¹¥", mind: "íŒ”ê¿ˆì¹˜ë¥¼ ì˜†êµ¬ë¦¬ë¡œ ê½‚ê¸°", tip: "ìˆ„ë” íŒ¨í‚¹ í•„ìˆ˜", guide: "ë°´ë“œ ê°•ë„ ì¡°ì ˆ", cue: "ìˆ„ë”íŒ¨í‚¹ â†’ íŒ”ê¿ˆì¹˜ë¡œ ì˜†êµ¬ë¦¬ ì°ê¸°" },
        { name: "ì¸ë²„í‹°ë“œ ë¡œìš°", set: 4, rep: 12, rest: 90, breath: "ë‹¹ê¸¸ ë•Œ í˜¸ê¸°", target: "ë“± ì¤‘ì•™", mind: "ë‚ ê°œë¼ˆë¥¼ ë’¤ë¡œ ëª¨ìœ¼ê¸°", tip: "ê°€ìŠ´ì„ ë°”ë¡œ ë§ˆì¤‘", guide: "ë°œ ìœ„ì¹˜ë¡œ ë‚œì´ë„ ì¡°ì ˆ", cue: "ëª¸ ì¼ì§ì„  + ë‚ ê°œë¼ˆë¥¼ ë ˆëª¬ ì§œë“¯ ì¡°ì´ê¸°" },
        { name: "ì¹œì—… (ë°´ë“œ)", set: 3, rep: 8, rest: 90, breath: "ì˜¬ë¼ê°ˆ ë•Œ í˜¸ê¸°", target: "ë“± & ì´ë‘", mind: "ê°€ìŠ´ì„ ë´‰ì— ë¶™ì´ê¸°", tip: "ê°€ìŠ´ ë†’ì´ê¹Œì§€ ì˜¬ë¦¬ê¸°", guide: "ì–¸ë”ê·¸ë¦½ ì‚¬ìš©", cue: "ê°€ìŠ´ì„ ë´‰ ìª½ìœ¼ë¡œ ì ‘ì–´ ë„£ê¸°" }
      ]},
      3: { day: "ìˆ˜ìš”ì¼", type: "push", title: "ì¸¡ë©´ ì–´ê¹¨", list: [
        { name: "ì‚¬ì´ë“œ ë ˆì´ì¦ˆ", set: 5, rep: 20, rest: 60, breath: "ì˜¬ë¦´ ë•Œ í˜¸ê¸°", target: "ì¸¡ë©´ ì‚¼ê°ê·¼", mind: "íŒ”ê¿ˆì¹˜ë¥¼ ì–‘ì˜†ìœ¼ë¡œ ë˜ì§", tip: "ë‚ ê°œë¼ˆ ê³ ì •", guide: "ì €ì¤‘ëŸ‰ ê³ ë°˜ë³µ ê¶Œì¥", cue: "ìœ„ê°€ ì•„ë‹ˆë¼ â€˜ë©€ë¦¬ ë˜ì§„ë‹¤â€™" }
      ]},
      4: { day: "ëª©ìš”ì¼", type: "push", title: "ì–´ê¹¨ & ì‚¼ë‘", list: [
        { name: "íŒŒì´í¬ í‘¸ì‰¬ì—…", set: 4, rep: 10, rest: 90, breath: "ë°€ ë•Œ í˜¸ê¸°", target: "ì „ë©´ ì–´ê¹¨", mind: "ì–´ê¹¨ë¡œ ì²œì¥ ë°€ê¸°", tip: "ì—‰ë©ì´ ë†’ì´ ìœ ì§€", guide: "ë¨¸ë¦¬ë¥¼ ì†ë³´ë‹¤ ì•ìœ¼ë¡œ", cue: "ì •ìˆ˜ë¦¬ê°€ ë°”ë‹¥ì— ë‹¿ë“¯ ë‚´ë ¤ê°”ë‹¤ê°€ ë¡œì¼“ì²˜ëŸ¼ ë°€ê¸°" },
        { name: "ë””í´ë¼ì¸ í‘¸ì‰¬ì—…", set: 4, rep: 12, rest: 90, breath: "ë°€ ë•Œ í˜¸ê¸°", target: "ìƒë¶€ ê°€ìŠ´", mind: "ìƒë¶€ ê°€ìŠ´ ì§‘ì¤‘", tip: "ë°œ ìœ„ì¹˜ ë†’ê²Œ", guide: "ê°€ìŠ´ ìœ„ìª½ì— ìê·¹ ì§‘ì¤‘", cue: "ì‡„ê³¨ ì•„ë˜ë¡œ ë°”ë‹¥ì„ ë¯¼ë‹¤" },
        { name: "ì‚¼ë‘ ë”¥ìŠ¤", set: 4, rep: 8, rest: 90, breath: "ë°€ ë•Œ í˜¸ê¸°", target: "ì‚¼ë‘ê·¼", mind: "ì‚¼ë‘ë¡œ í´ì„œ ì ê¸ˆ", tip: "íŒ”ê¿ˆì¹˜ ë’¤ë¡œ ëª¨ìœ¼ê¸°", guide: "ì˜ì ì‚¬ìš© ê°€ëŠ¥", cue: "íŒ”ê¿ˆì¹˜ ë²Œì–´ì§€ì§€ ì•Šê²Œ ë’¤ë¡œ ëª¨ì•„ ì‚¼ë‘ íƒ€ê²©" }
      ]},
      5: { day: "ê¸ˆìš”ì¼", type: "pull", title: "ë“± ë„“ì´", list: [
        { name: "ì™€ì´ë“œ í’€ì—…", set: 4, rep: 6, rest: 120, breath: "ì˜¬ë¼ê°ˆ ë•Œ í˜¸ê¸°", target: "ê´‘ë°° ì™¸ê³½", mind: "ë“±ì„ ë„“ê²Œ í¼ì¹˜ê¸°", tip: "ë„“ì€ ê·¸ë¦½ ì‚¬ìš©", guide: "ìƒë¶€ ê´‘ë°° ìê·¹ ì§‘ì¤‘", cue: "íŒ”ê¿ˆì¹˜ë¥¼ ì•„ë˜ë¡œ ì°ì–´ ê´‘ë°° ì˜†ì„  íƒ€ê²©" },
        { name: "ì¸ë²„í‹°ë“œ ë¡œìš°", set: 4, rep: 12, rest: 90, breath: "ë‹¹ê¸¸ ë•Œ í˜¸ê¸°", target: "ë“± ì•ˆì •ì„±", mind: "ëª¸ì„ ì¼ì§ì„ ìœ¼ë¡œ", tip: "í…œí¬ ì¼ì •í•˜ê²Œ", guide: "ì½”ì–´ ë‹¨ë‹¨íˆ ê³ ì •", cue: "ë‘”ê·¼/ë³µë¶€ ê³ ì • + ë‚ ê°œë¼ˆ ì¡°ì´ê¸°" },
        { name: "ë‚´ë¡œìš° í’€ì—…", set: 3, rep: 8, rest: 90, breath: "ì˜¬ë¼ê°ˆ ë•Œ í˜¸ê¸°", target: "ë“± ì¤‘ì•™", mind: "ë´‰ì— ê°€ìŠ´ í„°ì¹˜", tip: "1ì´ˆê°„ ì •ì§€", guide: "ì¢ì€ ê·¸ë¦½ ì‚¬ìš©", cue: "ê°€ìŠ´ì„ ë´‰ì— ìµœëŒ€í•œ ë¶™ì´ê¸°" }
      ]},
      6: { day: "í† ìš”ì¼", type: "leg", title: "í•˜ì²´ & ì½”ì–´", list: [
        { name: "ìŠ¤ì¿¼íŠ¸", set: 4, rep: 20, rest: 60, breath: "ì˜¬ë¼ì˜¬ ë•Œ í˜¸ê¸°", target: "í—ˆë²…ì§€/ë‘”ê·¼", mind: "ë°œë°”ë‹¥ ì§€ë©´ ë°€ê¸°", tip: "í—ˆë¦¬ ì¤‘ë¦½ ìœ ì§€", guide: "ë’¤ê¿ˆì¹˜ ê³ ì •", cue: "ë‚®ì€ ì˜ìì— ì•‰ì•˜ë‹¤ê°€ ì§€êµ¬ë¥¼ ë¯¼ë‹¤" },
        { name: "ëŸ°ì§€", set: 3, rep: 10, rest: 60, breath: "ì˜¬ë¼ì˜¬ ë•Œ í˜¸ê¸°", target: "ì—‰ë©ì´", mind: "ë’¤ê¿ˆì¹˜ì— í˜ ì „ë‹¬", tip: "ìƒì²´ ì‚´ì§ ìˆ™ì´ê¸°", guide: "ë¬´ë¦ ì•ˆì •ì„± ìœ ì˜", cue: "ì•ë°œ ë’¤ê¿ˆì¹˜ë¡œ ê°•ë ¥í•˜ê²Œ ë°€ê¸°" },
        { name: "í”Œë­í¬", set: 3, rep: 60, rest: 60, breath: "ì¼ì •í•˜ê²Œ ìœ ì§€", target: "ì½”ì–´", mind: "ë°°ë¥¼ ì•ˆìœ¼ë¡œ ë‹¹ê¸°ê¸°", tip: "ì—‰ë©ì´ ìˆ˜ì¶•", guide: "ì¼ì§ì„  ìœ ì§€", cue: "ê°•ì²  íŒìì²˜ëŸ¼ ë²„í‹°ê¸°" }
      ]},
      0: { day: "ì¼ìš”ì¼", type: "rest", title: "íšŒë³µ", list: [
        { name: "ìŠ¤íŠ¸ë ˆì¹­", set: 1, rep: 15, rest: 0, breath: "ê¹Šê³  ê¸¸ê²Œ", target: "ì „ì‹  ì´ì™„", mind: "ê·¼ìœ¡ ì´ì™„ ëŠë¼ê¸°", tip: "ì–´ê¹¨/ê´‘ë°° ì§‘ì¤‘", guide: "ì¶©ë¶„í•œ ìˆ˜ë©´ ê¶Œì¥", cue: "ë¶€ë“œëŸ½ê²Œ ê¸¸ê²Œ, ê°•ë„ë³´ë‹¤ í˜¸í¡" }
      ]}
    };

    /* ---------- STORAGE KEYS ---------- */
    const KEY_LOGS = 'dk_os_v12_logs';
    const KEY_SETS = 'dk_os_v12_sets';
    const KEY_REPS = 'dk_os_v12_reps';
    const KEY_PROGRESS_BY_DATE = 'dk_os_v12_progress_by_date';
    const KEY_SPLASH = 'dk_os_v12_splash_shown';
    const KEY_SUMMARY_SHOWN = 'dk_os_v12_summary_shown';
    const KEY_NOTIF = 'dk_os_v12_rest_notif';
    const KEY_SW = 'dk_os_v12_stopwatch_sessions'; // per date session minutes

    /* ---------- LOAD ---------- */
    function safeParse(raw, fallback){ try { return raw ? JSON.parse(raw) : fallback; } catch(e){ return fallback; } }
    let logs = safeParse(localStorage.getItem(KEY_LOGS), []);
    let customSets = safeParse(localStorage.getItem(KEY_SETS), {});
    let customReps = safeParse(localStorage.getItem(KEY_REPS), {});
    let progressByDate = safeParse(localStorage.getItem(KEY_PROGRESS_BY_DATE), {});
    let stopwatchSessions = safeParse(localStorage.getItem(KEY_SW), {}); // {date: seconds}

    /* ---------- STATE ---------- */
    let timerInt = null;
    let currentDayIdx = new Date().getDay();
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];
    let restRemaining = 0;
    let restTotal = 0;
    let currentSlideIndex = 0;
    let restNotifEnabled = (localStorage.getItem(KEY_NOTIF) ?? '1') === '1';

    let restStartedAt = null;
    let restCurrentLogKey = null;

    /* stopwatch */
    let swRunning = true;
    let swStartTs = Date.now();
    let swAccum = stopwatchSessions[todayStr()] || 0; // seconds

    /* REP modal state */
    let repModalState = null; // { logKey, baseRep, dayIdx, exIdx, setNo }

    /* Audio context */
    let audioCtx = null;
    function unlockAudio(){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === 'suspended') audioCtx.resume();
      }catch(e){}
    }

    /* ---------- UTILS ---------- */
    function haptic(ms=18){ if(navigator.vibrate) navigator.vibrate(ms); }
    function nowISO(){ return new Date().toISOString(); }
    function todayStr(){ return new Date().toISOString().split('T')[0]; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function exId(dayIdx, exIdx){ return `${dayIdx}-${exIdx}`; }
    function secondsToMMSS(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = String(Math.floor(sec/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    /* ---------- SPLASH ---------- */
    function initIntro(){
      const shown = sessionStorage.getItem(KEY_SPLASH) === '1';
      const splash = document.getElementById('splash-screen');
      if(shown){ splash.style.display = 'none'; return; }

      setTimeout(() => {
        splash.style.opacity = '0';
        splash.style.transform = 'scale(1.08)';
        setTimeout(()=> splash.style.display='none', 1000);
        sessionStorage.setItem(KEY_SPLASH, '1');
      }, 1600);
    }

    /* ---------- TOAST ---------- */
    let toastTimer=null;
    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.classList.remove('show'), 1700);
    }

    /* ---------- SUMMARY MODAL ---------- */
    function openSummary(stats){
      document.getElementById('sum-sets').textContent = stats.sets;
      document.getElementById('sum-ex').textContent = stats.exercises;
      document.getElementById('sum-msg').textContent = stats.msg;
      document.getElementById('summary-modal').classList.add('show');
    }
    function closeSummary(){
      document.getElementById('summary-modal').classList.remove('show');
    }

    /* ---------- TABS ---------- */
    function showTab(name, btn){
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${name}`).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const dayWrap = document.getElementById('day-nav-wrap');
      if(dayWrap) dayWrap.style.display = (name === 'session') ? 'block' : 'none';

      if(name === 'stats') renderStats();
      if(name === 'history') renderCalendar();

      window.scrollTo({top:0, behavior:'smooth'});
      showDockTemporarily();
    }

    /* ---------- DAY NAV ---------- */
    function updateDayNav(){
      const nav = document.getElementById('day-nav');
      nav.innerHTML = '';
      ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'].forEach((d, i) => {
        const dm = (i === 6) ? 0 : i + 1;
        const b = document.createElement('button');
        b.className = `day-chip ${dm === currentDayIdx ? 'active' : ''}`;
        b.innerText = d;
        b.onclick = () => changeDay(dm);
        nav.appendChild(b);
      });
    }

    /* ---------- DATE-BASED PROGRESS ---------- */
    function getProgressArr(date, exerciseId, setTotal){
      if(!progressByDate[date]) progressByDate[date] = {};
      let arr = progressByDate[date][exerciseId];
      if(!Array.isArray(arr)){
        arr = new Array(setTotal).fill(false);
        progressByDate[date][exerciseId] = arr;
        localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(progressByDate));
        return arr;
      }
      if(arr.length !== setTotal){
        const next = new Array(setTotal).fill(false);
        for(let i=0;i<Math.min(arr.length,setTotal);i++) next[i]=!!arr[i];
        progressByDate[date][exerciseId] = next;
        localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(progressByDate));
        return next;
      }
      return arr;
    }

    function computeProgressForDay(date, dayIdx){
      let total = 0, done = 0;
      workoutData[dayIdx].list.forEach((w, idx) => {
        const id = exId(dayIdx, idx);
        const setTotal = customSets[id] || w.set;
        total += setTotal;
        const arr = getProgressArr(date, id, setTotal);
        done += arr.filter(Boolean).length;
      });
      return { total, done, pct: Math.round((done/total)*100) || 0 };
    }

    function updateProgressUI(){
      const p = computeProgressForDay(todayStr(), currentDayIdx);
      document.getElementById('progress-bar').style.width = p.pct + '%';
      document.getElementById('progress-percent').innerText = p.pct + '%';
      document.getElementById('progress-text').innerText = `${p.pct}% ì™„ë£Œ!`;
      if(p.pct === 100) maybeShowSummary();
    }

    function maybeShowSummary(){
      const date = todayStr();
      const key = `${date}|${currentDayIdx}`;
      if(localStorage.getItem(KEY_SUMMARY_SHOWN) === key) return;

      const stats = getTodaySummaryStats();
      localStorage.setItem(KEY_SUMMARY_SHOWN, key);
      openSummary(stats);
      haptic(30);
    }

    function getTodaySummaryStats(){
      const date = todayStr();
      const data = workoutData[currentDayIdx];
      let setsDone = 0;
      let exDone = 0;
      data.list.forEach((w, idx)=>{
        const id = exId(currentDayIdx, idx);
        const setTotal = customSets[id] || w.set;
        const arr = getProgressArr(date, id, setTotal);
        const done = arr.filter(Boolean).length;
        setsDone += done;
        if(done === setTotal) exDone++;
      });
      const msgPool = [
        "ì˜¤ëŠ˜ë„ ì™„ë²½í–ˆë‹¤. ë‚´ì¼ì€ ë” ê°•í•´ì§„ë‹¤.",
        "í¼ì´ ì˜¬ë¼ì™”ë‹¤. ë‹¤ìŒ ì£¼ëŠ” ê¸°ë¡ ê°±ì‹ .",
        "ì§‘ì¤‘ë ¥ì´ ë¯¸ì³¤ë‹¤. ì»¨ë””ì…˜ ìµœê³ .",
        "ê·œì¹™ì€ ë°°ì‹ í•˜ì§€ ì•ŠëŠ”ë‹¤. ê³„ì† ê°„ë‹¤.",
        "ì˜¤ëŠ˜ì€ ì„±ê³µ. ë‹¤ìŒì€ ì§„ì§œ ë ˆë²¨ì—…."
      ];
      return {
        sets: setsDone,
        exercises: exDone,
        msg: msgPool[Math.floor(Math.random()*msgPool.length)]
      };
    }

    /* ---------- CHANGE DAY ---------- */
    function changeDay(d){
      currentDayIdx = d;
      currentSlideIndex = 0;

      const data = workoutData[d];
      document.getElementById('view-day').innerText = data.day;
      document.getElementById('view-title').innerText = data.title;

      const cueMap = {
        push: "í‘¸ì‰¬ ë°ì´ â€” í…œí¬ ì œì–´ & ì½”ì–´ ê³ ì •",
        pull: "í’€ ë°ì´ â€” ìˆ„ë” íŒ¨í‚¹ & ê´‘ë°° ìˆ˜ì¶•",
        leg:  "í•˜ì²´ ë°ì´ â€” ë°œ ì „ì²´ë¡œ ë°€ê¸°",
        rest: "íšŒë³µ â€” í˜¸í¡ & ë¦¬ì…‹"
      };
      document.getElementById('view-subcue').innerText = cueMap[data.type] || "í›ˆë ¨ ëª¨ë“œ";

      renderCarousel();
      updateProgressUI();
      updateDayNav();

      showDockTemporarily();
    }

    /* =========================================================
      âœ… Bottom Sheet
    ========================================================= */
    let mobileActive = { w:null };

    function openDetailSheet(w){
      mobileActive.w = w;

      document.getElementById('sheet-title').textContent = w.name;
      document.getElementById('sheet-sub').textContent = `${w.target || 'DETAIL'}`;

      const tabs = [
        { key:'cue',   label:'í•µì‹¬ í',    text: expandCue(w) },
        { key:'breath',label:'í˜¸í¡',      text: expandBreath(w) },
        { key:'mind',  label:'ì˜ì‹',      text: expandMind(w) },
        { key:'elite', label:'ì—˜ë¦¬íŠ¸ ê°€ì´ë“œ', text: expandElite(w) },
      ];

      const tabWrap = document.getElementById('sheet-tabs');
      tabWrap.innerHTML = '';

      tabs.forEach((t, i)=>{
        const b = document.createElement('button');
        b.className = `sheetTab ${i===0?'active':''}`;
        b.textContent = t.label;
        b.onclick = ()=> setSheetTab(t, b);
        tabWrap.appendChild(b);
      });

      setSheetTab(tabs[0], tabWrap.querySelector('.sheetTab'));

      const sheetWrap = document.getElementById('detail-sheet');
      sheetWrap.classList.add('show');
      haptic(14);
      showDockTemporarily();
    }

    function closeDetailSheet(){
      const sheetWrap = document.getElementById('detail-sheet');
      sheetWrap.classList.remove('show');
      haptic(10);
    }

    function setSheetTab(tab, btn){
      document.querySelectorAll('.sheetTab').forEach(x=> x.classList.remove('active'));
      btn.classList.add('active');

      const w = mobileActive.w;

      const gifBlock = (w.gif) ? `
        <div class="sheetBox">
          <div class="sheetLabel">ë™ì‘ ê°€ì´ë“œ</div>
          <img src="${w.gif}" class="sheetGif" loading="lazy" alt="exercise guide"
               onerror="this.style.display='none';" />
          <div class="sheetHint">* GIFëŠ” ë™ì‘ íë¦„ë§Œ ì°¸ê³ í•˜ì„¸ìš”. í¼ì´ ìš°ì„ ì…ë‹ˆë‹¤.</div>
        </div>
      ` : '';

      const body = document.getElementById('sheet-body');
      body.innerHTML = `
        ${gifBlock}
        <div class="sheetBox">
          <div class="sheetLabel">${tab.label}</div>
          <div class="sheetText">${tab.text}</div>
          <div class="sheetHint">* ì²˜ìŒì—” <b>ì²œì²œíˆ</b>, ì •í™•í•˜ê²Œ. ë‹¤ìŒ ë‹¨ê³„ëŠ” â€œë²”ìœ„â€ì™€ â€œí˜¸í¡â€ ìœ ì§€.</div>
        </div>
      `;
    }

    function expandCue(w){
      const base = (w.cue || w.tip || '').trim();
      return `
        ${base ? `â€¢ ${base}<br><br>` : ''}
        <b>ì´ˆë³´ì ê¸°ì¤€ í•µì‹¬ì€ â€œí¼ì´ ë¬´ë„ˆì§€ì§€ ì•ŠëŠ” ë²”ìœ„â€</b>ì…ë‹ˆë‹¤.<br>
        1) íƒ€ê²Ÿì„ ëŠë¼ê³ <br>
        2) í”ë“¤ë¦¬ë©´ ì†ë„ â†“<br>
        3) ë°˜ë™ ì—†ì´ ì •í™•íˆ<br><br>
        âœ… <b>ì²´í¬ í¬ì¸íŠ¸</b><br>
        â€¢ ì–´ê¹¨ê°€ ì˜¬ë¼ê°€ë©´ â†’ ì–´ê¹¨ ë‚´ë¦¬ê³  ê°€ìŠ´ ì—´ê¸°<br>
        â€¢ í—ˆë¦¬ê°€ êº¾ì´ë©´ â†’ ì½”ì–´ ê³ ì •<br>
        â€¢ ë°˜ë™ ìƒê¸°ë©´ â†’ ì†ë„ 20% ì¤„ì´ê¸°
      `.trim();
    }
    function expandBreath(w){
      return `
        <b>í˜¸í¡ì€ â€œí˜ì„ ì“°ëŠ” ìˆœê°„ì— ë‚´ì‰¬ê¸°â€</b>ê°€ ì›ì¹™ì…ë‹ˆë‹¤.<br><br>
        â€¢ ê¸°ë³¸: <b>${w.breath}</b><br><br>
        âœ… <b>ìš”ë ¹</b><br>
        1) ë‚´ë ¤ê°ˆ ë•Œ â†’ ì½”ë¡œ í¡ê¸°<br>
        2) ì˜¬ë¼ì˜¬ ë•Œ â†’ ì…ìœ¼ë¡œ í˜¸ê¸°<br><br>
        âœ… í˜¸í¡ì´ ë¬´ë„ˆì§€ë©´ ìì„¸ë„ ë¬´ë„ˆì§‘ë‹ˆë‹¤.
      `.trim();
    }
    function expandMind(w){
      return `
        <b>${w.mind}</b><br><br>
        âœ… <b>í”í•œ ì‹¤ìˆ˜</b><br>
        â€¢ íŒ”ë¡œë§Œ í•¨ â†’ íƒ€ê²Ÿ ëª» ì¡ìŒ<br>
        â€¢ ë„ˆë¬´ ë¹ ë¦„ â†’ ë°˜ë™<br><br>
        âœ… <b>ë°”ë¡œ ì ìš©</b><br>
        1) íƒ€ê²Ÿ ìˆ˜ì¶•/ëŠ˜ì–´ë‚¨ ëŠë‚Œ<br>
        2) ì¤‘ê°„ì— 0.5ì´ˆ ì •ì§€<br>
        3) íƒ€ê²Ÿì´ ë°”ë€Œë©´ ì†ë„ â†“
      `.trim();
    }
    function expandElite(w){
      return `
        <b>${w.tip}</b><br>
        <span style="opacity:.75;">${w.guide || ''}</span><br><br>
        âœ… <b>ì²´í¬ë¦¬ìŠ¤íŠ¸</b><br>
        1) í”ë“¤ë¦¼ ì—†ìŒ<br>
        2) ì „ êµ¬ê°„ ê¸´ì¥ ìœ ì§€<br>
        3) ë§ˆì§€ë§‰ 2íšŒëŠ” ì»¨íŠ¸ë¡¤<br><br>
        âœ… ê°•í™” ë£¨í‹´<br>
        â€¢ ë§ˆì§€ë§‰ 3íšŒ í…œí¬ ëŠë¦¬ê²Œ(2ì´ˆ ë‚´ë ¤ê°)
      `.trim();
    }

    /* =========================================================
      âœ… REP Modal Logic
    ========================================================= */
    function openRepModal({logKey, name, setNo, baseRep}){
      repModalState = {logKey, baseRep};

      document.getElementById('rep-title').textContent = name;
      document.getElementById('rep-sub').textContent = `${setNo} SET`;
      document.getElementById('rep-base').textContent = baseRep;

      const modal = document.getElementById('rep-modal');
      modal.classList.add('show');
      haptic(12);
      showDockTemporarily();
    }

    function closeRepModal(save=false){
      const modal = document.getElementById('rep-modal');
      modal.classList.remove('show');
      repModalState = null;
      showDockTemporarily();
    }

    function repQuick(delta){
      if(!repModalState) return;
      const value = clamp(repModalState.baseRep + delta, 0, 999);
      saveRepToLog(repModalState.logKey, value);
      closeRepModal(true);
    }

    function repSkip(){
      if(!repModalState) return;
      saveRepToLog(repModalState.logKey, repModalState.baseRep);
      closeRepModal(true);
    }

    function saveRepToLog(logKey, repValue){
      const idx = logs.findIndex(l => l.logKey === logKey);
      if(idx === -1) return;
      logs[idx].repActual = repValue;
      localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
      toast(`REP ${repValue} ê¸°ë¡ë¨`);

      // âœ… Weekly compare toast
      weeklyCompareToast(logs[idx]);

      haptic(16);
    }

    /* =========================================================
      âœ… Weekly compare (last week same weekday + same exercise)
    ========================================================= */
    function getLastWeekDateStr(dateStr){
      const d = new Date(dateStr);
      d.setDate(d.getDate() - 7);
      return d.toISOString().split('T')[0];
    }

    function findLastWeekSameExerciseLog(curLog){
      const lastDate = getLastWeekDateStr(curLog.date);
      const last = logs.filter(l =>
        l.date === lastDate &&
        l.exerciseId === curLog.exerciseId &&
        l.set === curLog.set
      )[0];
      return last || null;
    }

    function weeklyCompareToast(curLog){
      const prev = findLastWeekSameExerciseLog(curLog);
      if(!prev || prev.repActual == null || curLog.repActual == null) return;

      const diff = curLog.repActual - prev.repActual;
      if(diff > 0){
        toast(`ğŸ”¥ ì§€ë‚œì£¼ ëŒ€ë¹„ +${diff} REP`);
      }else if(diff < 0){
        toast(`âš¡ ì§€ë‚œì£¼ ëŒ€ë¹„ ${diff} REP`);
      }else{
        toast(`âœ… ì§€ë‚œì£¼ì™€ ë™ì¼ REP`);
      }
    }

    /* =========================================================
      âœ… CAROUSEL
    ========================================================= */
    function renderCarousel(){
      const date = todayStr();
      const data = workoutData[currentDayIdx];
      const carousel = document.getElementById('session-carousel');
      carousel.innerHTML = '';

      data.list.forEach((w, idx) => {
        const id = exId(currentDayIdx, idx);

        w.gif = getGifByExerciseName(w.name) || '';

        const setTotal = customSets[id] || w.set;
        const repTotal = customReps[id] || w.rep;
        const doneArr = getProgressArr(date, id, setTotal);
        const doneCount = doneArr.filter(Boolean).length;

        const slide = document.createElement('div');
        slide.className = 'slide';
        slide.setAttribute('data-slide', idx);

        const detailAction = w.gif ? `
          <span class="pill cyan">
            <i class="fa-solid fa-hand-pointer"></i> GIF í„°ì¹˜ë¡œ ìƒì„¸ ë³´ê¸°
          </span>
        ` : `
          <button class="pill cyan" onclick='openDetailSheet(${JSON.stringify(w).replace(/'/g,"&#39;")})'>
            <i class="fa-solid fa-circle-info"></i> ìš´ë™ ìƒì„¸ ë³´ê¸°
          </button>
        `;

        slide.innerHTML = `
          <div class="glass slideCard p-6 md:p-7">
            <div>
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <h3 class="text-3xl md:text-4xl font-black italic text-white tracking-tight truncate">${w.name}</h3>
                  <div class="mt-3 flex items-center gap-2 flex-wrap">
                    <span class="pill cyan">${w.target}</span>
                    <span class="pill">íœ´ì‹ ${w.rest}s</span>
                    <span class="pill">ì§„í–‰ ${doneCount}/${setTotal}</span>
                  </div>
                </div>
                <button onclick="resetExercise('${id}')" class="pill" title="ì´ ìš´ë™(ì˜¤ëŠ˜) ì´ˆê¸°í™”">
                  <i class="fa-solid fa-rotate-left"></i>
                </button>
              </div>

              <div class="mt-4 flex items-center justify-between gap-2">
                ${detailAction}
              </div>

              <div class="mt-5 grid md:grid-cols-2 gap-4">
                <div class="space-y-3">
                  <div class="glass rounded-2xl p-4 border-white/5">
                    <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45 mb-2">í•µì‹¬ í</p>
                    <p class="text-base md:text-lg font-black text-white/80 leading-relaxed">${w.cue || w.tip || ''}</p>
                  </div>

                  <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/[0.02] p-4 rounded-2xl border border-white/5">
                      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-indigo-300 mb-2">í˜¸í¡</p>
                      <p class="text-[13px] font-bold text-white/70">${w.breath}</p>
                    </div>
                    <div class="bg-white/[0.02] p-4 rounded-2xl border border-white/5">
                      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-indigo-300 mb-2">ì˜ì‹</p>
                      <p class="text-[13px] font-bold text-white/70">${w.mind}</p>
                    </div>

                    <div class="bg-cyan-400/[0.04] p-4 rounded-2xl border border-cyan-400/10 col-span-2">
                      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-cyan-300 mb-2">ì—˜ë¦¬íŠ¸ ê°€ì´ë“œ</p>
                      <p class="text-[13px] font-bold text-white/75">${w.tip} Â· <span class="text-white/45">${w.guide}</span></p>
                    </div>

                    ${w.gif ? `
                      <div class="mt-2 col-span-2">
                        <div class="cardGifSquareWrap" onclick='openDetailSheet(${JSON.stringify(w).replace(/'/g,"&#39;")})'>
                          <img src="${w.gif}" class="cardGifSquare" loading="lazy" alt="exercise guide"
                               onerror="this.parentElement.style.display='none';" />
                        </div>
                        <div class="mt-2 text-[10px] font-black tracking-[0.18em] uppercase text-white/35">
                          GIF í„°ì¹˜í•˜ë©´ ìš´ë™ ìƒì„¸ë³´ê¸°
                        </div>
                      </div>
                    ` : ''}
                  </div>
                </div>

                <div class="rightPanel space-y-3">
                  <div class="glass rounded-2xl p-4 border-white/5">
                    <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">ì„¸íŠ¸/íšŸìˆ˜ ì„¤ì •</p>
                    <p class="text-[11px] mt-2 font-bold text-white/45">* ì„¸íŠ¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²´í¬í•©ë‹ˆë‹¤</p>
                  </div>

                  <div class="stepper">
                    <div>
                      <div class="stepperLabel">SET</div>
                      <div class="stepperValue" id="setv-${id}">${setTotal}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="stepperBtn" onclick="adjust('set','${id}',-1)"><i class="fa-solid fa-minus"></i></button>
                      <button class="stepperBtn" onclick="adjust('set','${id}',1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                  </div>

                  <div class="stepper">
                    <div>
                      <div class="stepperLabel">REP</div>
                      <div class="stepperValue" id="repv-${id}">${repTotal}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="stepperBtn" onclick="adjust('rep','${id}',-1)"><i class="fa-solid fa-minus"></i></button>
                      <button class="stepperBtn" onclick="adjust('rep','${id}',1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                  </div>

                  <button class="bigBtn" onclick="resetSetRepToDefault('${id}')">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    ì„¸íŠ¸/íšŸìˆ˜ ê¸°ë³¸ê°’
                  </button>

                  <div class="grid grid-cols-2 gap-3" id="setgrid-${id}">
                    ${Array.from({length:setTotal}).map((_, s)=>{
                      const done = !!doneArr[s];
                      const nextIndex = doneArr.indexOf(false);
                      const isLocked = (!done && nextIndex !== -1 && s !== nextIndex);

                      return `<button class="setBtn ${done?'done':''} ${isLocked?'locked':''}"
                        ${isLocked ? 'disabled' : ''}
                        data-date="${date}" data-ex="${id}" data-set="${s}">
                        ${done ? `<i class='fa-solid fa-check'></i>` : ''}
                        ${s+1} ì„¸íŠ¸
                      </button>`;
                    }).join('')}
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-5 flex items-center justify-between gap-2 flex-wrap">
              <div class="flex items-center gap-2">
                <span class="pill cyan">${idx+1} / ${data.list.length}</span>
                <span class="pill">${w.name}</span>
              </div>
              <div class="flex items-center gap-2">
                <button class="pill" onclick="carouselPrev()"><i class="fa-solid fa-chevron-left"></i> ì´ì „</button>
                <button class="pill cyan" onclick="carouselNext()">ë‹¤ìŒ <i class="fa-solid fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        `;

        carousel.appendChild(slide);
      });

      bindSetButtons();
      bindCarouselEvents();
      updateSlideHUD();
      requestAnimationFrame(()=> scrollToSlide(currentSlideIndex,false));
    }

    function bindCarouselEvents(){
      const carousel = document.getElementById('session-carousel');
      carousel.onscroll = () => {
        const slides = Array.from(carousel.children);
        if(!slides.length) return;
        const slideWidth = slides[0].getBoundingClientRect().width + 18;
        const idx = Math.round(carousel.scrollLeft / slideWidth);
        if(idx !== currentSlideIndex){
          currentSlideIndex = clamp(idx, 0, slides.length-1);
          updateSlideHUD();
        }
        showDockTemporarily();
      };
    }

    function updateSlideHUD(){
      const data = workoutData[currentDayIdx];
      const total = data.list.length;
      const idx = clamp(currentSlideIndex, 0, total-1);
      document.getElementById('slide-indicator').innerText = `${idx+1} / ${total}`;
      document.getElementById('slide-name').innerText = data.list[idx]?.name || 'ìš´ë™';

      const carousel = document.getElementById('session-carousel');
      Array.from(carousel.children).forEach((el, i)=>{
        el.classList.toggle('focus', i === idx);
        el.classList.toggle('peek', i !== idx);
      });
    }

    function scrollToSlide(idx, smooth=true){
      const carousel = document.getElementById('session-carousel');
      const slides = Array.from(carousel.children);
      if(!slides.length) return;
      idx = clamp(idx, 0, slides.length-1);
      const slideWidth = slides[0].getBoundingClientRect().width + 18;
      carousel.scrollTo({ left: slideWidth * idx, behavior: smooth ? 'smooth' : 'auto' });
    }

    function carouselNext(){
      const data = workoutData[currentDayIdx];
      currentSlideIndex = clamp(currentSlideIndex + 1, 0, data.list.length-1);
      scrollToSlide(currentSlideIndex, true);
      updateSlideHUD();
      haptic(10);
      showDockTemporarily();
    }

    function carouselPrev(){
      const data = workoutData[currentDayIdx];
      currentSlideIndex = clamp(currentSlideIndex - 1, 0, data.list.length-1);
      scrollToSlide(currentSlideIndex, true);
      updateSlideHUD();
      haptic(10);
      showDockTemporarily();
    }

    /* âœ… IMPORTANT FIX:
       ì„¸íŠ¸ ë²„íŠ¼ í´ë¦­ì´ ì¦‰ì‹œ íŒŒë€ìƒ‰ ë°˜ì˜ë˜ë„ë¡
       ë Œë” ì „ì²´ ì¬ìƒì„± ì—†ì´ DOMë§Œ ì—…ë°ì´íŠ¸
    */
    function bindSetButtons(){
      const buttons = document.querySelectorAll('.setBtn[data-ex]');
      buttons.forEach(btn => {
        btn.onclick = null;
        btn.addEventListener('click', () => {
          const date = btn.getAttribute('data-date');
          const ex = btn.getAttribute('data-ex');
          const setIndex = Number(btn.getAttribute('data-set'));
          toggleSetComplete(date, ex, setIndex, btn);
        });
      });
    }

    function updateSetGridLocking(date, exerciseId){
      const [dayIdx, exIdx] = exerciseId.split('-').map(Number);
      const w = workoutData[dayIdx]?.list?.[exIdx];
      if(!w) return;

      const setTotal = customSets[exerciseId] || w.set;
      const doneArr = getProgressArr(date, exerciseId, setTotal);
      const nextIndex = doneArr.indexOf(false);

      const grid = document.getElementById(`setgrid-${exerciseId}`);
      if(!grid) return;

      const btns = Array.from(grid.querySelectorAll('.setBtn'));
      btns.forEach((b, s)=>{
        const done = !!doneArr[s];
        const isLocked = (!done && nextIndex !== -1 && s !== nextIndex);

        b.classList.toggle('done', done);
        b.classList.toggle('locked', isLocked);
        b.disabled = isLocked;

        b.innerHTML = `${done ? `<i class='fa-solid fa-check'></i>` : ''}${s+1} ì„¸íŠ¸`;
      });
    }

    function toggleSetComplete(date, exerciseId, setIndex, domBtn){
      unlockAudio();
      showDockTemporarily();

      const [dayIdx, exIdx] = exerciseId.split('-').map(Number);
      const w = workoutData[dayIdx]?.list?.[exIdx];
      if(!w) return;

      const setTotal = customSets[exerciseId] || w.set;
      const doneArr = getProgressArr(date, exerciseId, setTotal);

      const nextIndex = doneArr.indexOf(false);
      if(!doneArr[setIndex] && nextIndex !== -1 && setIndex !== nextIndex){
        haptic(10);
        toast('ë‹¤ìŒ ì„¸íŠ¸ë¥¼ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”');
        return;
      }

      const repTotal = customReps[exerciseId] || w.rep;

      doneArr[setIndex] = !doneArr[setIndex];
      progressByDate[date][exerciseId] = doneArr;
      localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(progressByDate));

      const setNo = setIndex + 1;
      const logKey = `${date}|${exerciseId}|${setNo}`;

      if(doneArr[setIndex]){
        if(!logs.some(l => l.logKey === logKey)){
          logs.push({
            id: Date.now(),
            logKey,
            date,
            ts: nowISO(),
            exerciseId,
            name: w.name,
            set: setNo,
            plannedSetTotal: setTotal,
            plannedRep: repTotal,
            repActual: null,
            rpe: null,
            restPlanned: w.rest,
            restUsed: w.rest,
            type: workoutData[currentDayIdx].type
          });
          localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
        }

        // âœ… Rep modal open immediately
        openRepModal({logKey, name: w.name, setNo, baseRep: repTotal});

        if(w.rest > 0) startTimer(w.rest, logKey);

        haptic(16);
      }else{
        logs = logs.filter(l => l.logKey !== logKey);
        localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
        haptic(12);
      }

      // âœ… UI update instantly
      updateSetGridLocking(date, exerciseId);
      updateProgressUI();
    }

    function adjust(type, key, val){
      showDockTemporarily();

      const [d, idx] = key.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      if(!w) return;

      if(type === 'set'){
        const cur = customSets[key] || w.set;
        const next = clamp(cur + val, 1, 12);
        customSets[key] = next;
        localStorage.setItem(KEY_SETS, JSON.stringify(customSets));
        getProgressArr(todayStr(), key, next);

        // âœ… update only needed UI
        renderCarousel();
      }else{
        const cur = customReps[key] || w.rep;
        customReps[key] = clamp(cur + val, 1, 100);
        localStorage.setItem(KEY_REPS, JSON.stringify(customReps));
        renderCarousel();
      }

      updateProgressUI();
      toast('ì„¤ì • ì €ì¥ë¨');
    }

    function resetSetRepToDefault(exerciseId){
      showDockTemporarily();

      const [d, idx] = exerciseId.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      if(!w) return;

      if(customSets[exerciseId] !== undefined) delete customSets[exerciseId];
      if(customReps[exerciseId] !== undefined) delete customReps[exerciseId];
      localStorage.setItem(KEY_SETS, JSON.stringify(customSets));
      localStorage.setItem(KEY_REPS, JSON.stringify(customReps));

      getProgressArr(todayStr(), exerciseId, w.set);
      renderCarousel();
      updateProgressUI();
      toast('ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›');
      haptic(18);
    }

    function resetExercise(exerciseId){
      showDockTemporarily();
      if(!confirm('ì´ ìš´ë™ì˜ ì˜¤ëŠ˜ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      const date = todayStr();

      logs = logs.filter(l => !(l.date === date && l.exerciseId === exerciseId));
      localStorage.setItem(KEY_LOGS, JSON.stringify(logs));

      const [d, idx] = exerciseId.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      const setTotal = customSets[exerciseId] || w.set;
      if(progressByDate[date] && progressByDate[date][exerciseId]){
        progressByDate[date][exerciseId] = new Array(setTotal).fill(false);
        localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(progressByDate));
      }

      renderCarousel();
      updateProgressUI();
      toast('ìš´ë™ ì´ˆê¸°í™” ì™„ë£Œ');
      haptic(22);
    }

    function resetToday(){
      showDockTemporarily();
      if(!confirm('ì˜¤ëŠ˜ ì§„í–‰/ê¸°ë¡ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      const date = todayStr();

      logs = logs.filter(l => l.date !== date);
      localStorage.setItem(KEY_LOGS, JSON.stringify(logs));

      if(progressByDate[date]){ delete progressByDate[date]; localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(progressByDate)); }
      localStorage.removeItem(KEY_SUMMARY_SHOWN);

      // stopwatch reset
      stopwatchSessions[date] = 0;
      localStorage.setItem(KEY_SW, JSON.stringify(stopwatchSessions));
      swAccum = 0;
      swStartTs = Date.now();

      renderCarousel();
      updateProgressUI();
      toast('ì˜¤ëŠ˜ ì´ˆê¸°í™” ì™„ë£Œ');
      haptic(25);
    }

    /* =========================================================
      âœ… TIMER
    ========================================================= */
    function showHUD(on){
      const hud = document.getElementById('timer-hud');
      if(!hud) return;
      hud.classList.toggle('show', !!on);
    }

    function updateHUD(){
      const timeEl = document.getElementById('hud-time');
      const bar = document.getElementById('hud-bar');
      if(!timeEl || !bar) return;
      timeEl.textContent = String(restRemaining).padStart(2,'0');
      const pct = restTotal ? Math.round(((restTotal - restRemaining)/restTotal)*100) : 0;
      bar.style.width = pct + '%';
    }

    function startTimer(sec, logKey=null){
      restRemaining = sec;
      restTotal = sec;

      restStartedAt = Date.now();
      restCurrentLogKey = logKey;

      const modal = document.getElementById('timer-modal');
      const display = document.getElementById('timer-sec');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=> modal.classList.add('opacity-100'));
      display.innerText = restRemaining;

      showHUD(true);
      updateHUD();

      clearInterval(timerInt);
      timerInt = setInterval(() => {
        restRemaining--;
        display.innerText = restRemaining;
        updateHUD();
        if(restRemaining <= 0) closeTimer(true);
      }, 1000);
    }

    function minimizeTimer(){
      showDockTemporarily();
      const modal = document.getElementById('timer-modal');
      modal.classList.remove('opacity-100');
      setTimeout(()=> modal.classList.add('hidden'), 450);
      showHUD(true);
      toast('íƒ€ì´ë¨¸ ìµœì†Œí™”');
      haptic(10);
    }

    function openTimerFromHUD(){
      showDockTemporarily();
      const modal = document.getElementById('timer-modal');
      modal.classList.remove('hidden');
      requestAnimationFrame(()=> modal.classList.add('opacity-100'));
      haptic(10);
    }

    function adjustRest(delta){
      showDockTemporarily();
      if(!timerInt) return;
      restRemaining = clamp(restRemaining + delta, 5, 600);
      restTotal = Math.max(restTotal, restRemaining);
      document.getElementById('timer-sec').innerText = restRemaining;
      updateHUD();
      haptic(10);
    }

    function closeTimer(finished=false){
      clearInterval(timerInt);
      timerInt = null;

      const modal = document.getElementById('timer-modal');
      modal.classList.remove('opacity-100');
      setTimeout(()=> modal.classList.add('hidden'), 450);

      showHUD(false);

      if(restStartedAt && restCurrentLogKey){
        const used = clamp(Math.round((Date.now() - restStartedAt) / 1000), 0, restTotal);
        const idx = logs.findIndex(l => l.logKey === restCurrentLogKey);
        if(idx !== -1){
          logs[idx].restUsed = used;
          localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
        }
      }
      restStartedAt = null;
      restCurrentLogKey = null;

      if(finished){
        haptic(30);
        if(restNotifEnabled) restDoneNotify();
        toast("íœ´ì‹ ë! ë‹¤ìŒ ì„¸íŠ¸ âœ…");
      }
    }

    /* âœ… Better alert sound - more "notification-like" */
    function restDoneNotify(){
      try{ if(navigator.vibrate) navigator.vibrate([120,80,200,80,220]); }catch(e){}

      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === 'suspended') audioCtx.resume();

        const now = audioCtx.currentTime;

        // âœ… Soft + strong "ping" style
        const seq = [
          { t: 0.00, dur: 0.18, freq: 1318 }, // E6
          { t: 0.22, dur: 0.14, freq: 1047 }, // C6
          { t: 0.40, dur: 0.22, freq: 1568 }, // G6
        ];

        seq.forEach(p => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          const f = audioCtx.createBiquadFilter();
          f.type = 'lowpass';
          f.frequency.value = 6000;

          o.connect(f);
          f.connect(g);
          g.connect(audioCtx.destination);

          o.type = 'sine';

          o.frequency.setValueAtTime(p.freq, now + p.t);
          g.gain.setValueAtTime(0.0001, now + p.t);
          g.gain.exponentialRampToValueAtTime(0.22, now + p.t + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + p.t + p.dur);

          o.start(now + p.t);
          o.stop(now + p.t + p.dur);
        });

      }catch(e){}
    }

    function toggleNotif(){
      showDockTemporarily();
      restNotifEnabled = !restNotifEnabled;
      localStorage.setItem(KEY_NOTIF, restNotifEnabled ? '1' : '0');
      const btn = document.getElementById('notif-toggle');
      if(btn){
        btn.textContent = restNotifEnabled ? 'ON' : 'OFF';
        btn.classList.toggle('cyan', restNotifEnabled);
      }
      toast(restNotifEnabled ? 'ì•Œë¦¼ ON' : 'ì•Œë¦¼ OFF');
      haptic(14);
    }

    /* =========================================================
      âœ… STOPWATCH: pause/resume + save to localStorage by date
    ========================================================= */
    function tickStopwatch(){
      if(swRunning){
        const now = Date.now();
        const delta = Math.floor((now - swStartTs)/1000);
        const total = swAccum + delta;
        document.getElementById('stopwatch').innerText = secondsToMMSS(total);
      }else{
        document.getElementById('stopwatch').innerText = secondsToMMSS(swAccum);
      }
    }

    function persistStopwatch(){
      stopwatchSessions[todayStr()] = swAccum;
      localStorage.setItem(KEY_SW, JSON.stringify(stopwatchSessions));
    }

    function toggleStopwatch(){
      showDockTemporarily();
      const btn = document.getElementById('sw-toggle');
      if(swRunning){
        // pause
        const now = Date.now();
        const delta = Math.floor((now - swStartTs)/1000);
        swAccum += delta;
        swRunning = false;
        persistStopwatch();
        btn.innerHTML = `<i class="fa-solid fa-play"></i> ì¬ê°œ`;
        toast('ìš´ë™ ì‹œê°„ ì¼ì‹œì •ì§€');
      }else{
        // resume
        swStartTs = Date.now();
        swRunning = true;
        btn.innerHTML = `<i class="fa-solid fa-pause"></i> ì¼ì‹œì •ì§€`;
        toast('ìš´ë™ ì‹œê°„ ì¬ê°œ');
      }
      haptic(14);
    }

    setInterval(()=> {
      tickStopwatch();
    }, 500);

    /* =========================================================
      âœ… HISTORY PRO (Daily Summary + Collapsible exercises + Weekly compare)
    ========================================================= */
    function calcAutoWorkoutTime(dateStr){
      // estimate by sum(restUsed) + 40s per set (rough)
      const dayLogs = logs.filter(l => l.date === dateStr);
      if(dayLogs.length === 0) return 0;
      let restSum = 0;
      dayLogs.forEach(l => restSum += (l.restUsed ?? l.restPlanned ?? 0));
      const setWork = dayLogs.length * 40; // rough active time per set
      return restSum + setWork;
    }

    function getWorkoutTimeForDate(dateStr){
      const sw = stopwatchSessions[dateStr] || 0;
      if(sw > 0) return { sec: sw, source: 'STOPWATCH' };
      const auto = calcAutoWorkoutTime(dateStr);
      return { sec: auto, source: 'AUTO' };
    }

    function getDailyTotals(dateStr){
      const dayLogs = logs.filter(l => l.date === dateStr);
      const sets = dayLogs.length;
      const exercises = new Set(dayLogs.map(l => l.exerciseId)).size;
      const totalRep = dayLogs.reduce((a,l)=> a + (l.repActual ?? l.plannedRep ?? 0), 0);
      const restSum = dayLogs.reduce((a,l)=> a + (l.restUsed ?? l.restPlanned ?? 0), 0);
      const avgRest = sets ? Math.round(restSum/sets) : 0;
      return { sets, exercises, totalRep, restSum, avgRest, dayLogs };
    }

    function dailyWeeklyCompareSummary(dateStr){
      const last = getLastWeekDateStr(dateStr);
      const cur = getDailyTotals(dateStr);
      const prev = getDailyTotals(last);

      if(cur.sets === 0 || prev.sets === 0){
        return { ok:false, text:'ì§€ë‚œì£¼ ê¸°ë¡ ì—†ìŒ' };
      }

      const dRep = cur.totalRep - prev.totalRep;
      const dSets = cur.sets - prev.sets;
      const curTime = getWorkoutTimeForDate(dateStr).sec;
      const prevTime = getWorkoutTimeForDate(last).sec;
      const dTime = curTime - prevTime;

      const parts = [];
      parts.push(dRep === 0 ? `REP ë™ì¼` : (dRep>0 ? `+${dRep} REP ğŸ”¥` : `${dRep} REP âš¡`));
      parts.push(dSets === 0 ? `ì„¸íŠ¸ ë™ì¼` : (dSets>0 ? `+${dSets} ì„¸íŠ¸ âœ…` : `${dSets} ì„¸íŠ¸`));
      parts.push(dTime === 0 ? `ì‹œê°„ ë™ì¼` : (dTime>0 ? `+${Math.round(dTime/60)}m` : `${Math.round(dTime/60)}m`));

      return { ok:true, text: parts.join(' / ') };
    }

    function groupLogsByExercise(dayLogs){
      return dayLogs.reduce((acc, l)=>{
        if(!acc[l.exerciseId]) acc[l.exerciseId] = [];
        acc[l.exerciseId].push(l);
        return acc;
      }, {});
    }

    function exerciseWeeklyCompare(exerciseId, dateStr){
      const last = getLastWeekDateStr(dateStr);
      const cur = logs.filter(l => l.date === dateStr && l.exerciseId === exerciseId);
      const prev = logs.filter(l => l.date === last && l.exerciseId === exerciseId);
      if(cur.length === 0 || prev.length === 0) return null;

      const curRep = cur.reduce((a,l)=> a + (l.repActual ?? l.plannedRep ?? 0), 0);
      const prevRep = prev.reduce((a,l)=> a + (l.repActual ?? l.plannedRep ?? 0), 0);
      const diff = curRep - prevRep;

      if(diff > 0) return `ğŸ”¥ ì§€ë‚œì£¼ ëŒ€ë¹„ +${diff} REP`;
      if(diff < 0) return `âš¡ ì§€ë‚œì£¼ ëŒ€ë¹„ ${diff} REP`;
      return `âœ… ì§€ë‚œì£¼ì™€ ë™ì¼`;
    }

    function renderHistoryDetail(){
      const area = document.getElementById('history-detail');

      const { sets, exercises, totalRep, restSum, avgRest, dayLogs } = getDailyTotals(selectedDate);
      const wt = getWorkoutTimeForDate(selectedDate);
      const compare = dailyWeeklyCompareSummary(selectedDate);

      area.innerHTML = `
        <p class="text-[10px] font-black text-gray-400 tracking-widest uppercase px-2">${selectedDate} ë¦¬í¬íŠ¸</p>
      `;

      if(dayLogs.length === 0){
        area.innerHTML += `<div class="glass rounded-[28px] p-12 text-center text-gray-500 italic text-xs">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
        return;
      }

      // âœ… Daily Summary Card
      area.innerHTML += `
        <div class="glass rounded-[28px] p-6 border border-white/10">
          <div class="flex items-start justify-between gap-4">
            <div>
              <p class="text-[10px] font-black tracking-[0.2em] uppercase text-white/45">Daily Summary</p>
              <h3 class="text-2xl font-black italic text-white mt-1">${wt.source === 'STOPWATCH' ? 'ì´ ìš´ë™ì‹œê°„' : 'ì¶”ì • ìš´ë™ì‹œê°„'}</h3>
            </div>
            <span class="pill cyan">${secondsToMMSS(wt.sec)}</span>
          </div>

          <div class="mt-5 grid grid-cols-2 gap-3">
            <div class="glass rounded-2xl p-4">
              <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì´ ì„¸íŠ¸</p>
              <p class="text-3xl font-black text-white mt-2">${sets}</p>
            </div>
            <div class="glass rounded-2xl p-4">
              <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì´ ìš´ë™</p>
              <p class="text-3xl font-black text-white mt-2">${exercises}</p>
            </div>
            <div class="glass rounded-2xl p-4">
              <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì´ REP</p>
              <p class="text-3xl font-black text-white mt-2">${totalRep}</p>
            </div>
            <div class="glass rounded-2xl p-4">
              <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">í‰ê·  íœ´ì‹</p>
              <p class="text-3xl font-black text-white mt-2">${avgRest}s</p>
            </div>
            <div class="glass rounded-2xl p-4 col-span-2">
              <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì§€ë‚œì£¼ ë™ì¼ ìš”ì¼ ëŒ€ë¹„</p>
              <p class="text-base font-black text-white/80 mt-2">${compare.ok ? compare.text : compare.text}</p>
            </div>
          </div>
        </div>
      `;

      // âœ… Exercise cards (collapsible)
      const groups = groupLogsByExercise(dayLogs);

      Object.entries(groups).forEach(([exerciseId, data]) => {
        data.sort((a,b)=> a.set - b.set);

        const name = data[0].name;
        const plannedRep = data[0].plannedRep ?? "-";
        const totalSets = data.length;
        const repSum = data.reduce((a,l)=> a + (l.repActual ?? l.plannedRep ?? 0), 0);
        const compareText = exerciseWeeklyCompare(exerciseId, selectedDate);

        const tableRows = data.map(row => {
          const rep = (row.repActual ?? row.plannedRep ?? "-");
          const rest = (row.restUsed ?? row.restPlanned ?? "-");
          return `
            <tr class="log-row">
              <td><span class="pill">${row.set}</span></td>
              <td><span class="pill cyan">${rep}</span></td>
              <td><span class="pill">${rest}s</span></td>
            </tr>
          `;
        }).join('');

        area.innerHTML += `
          <div class="glass rounded-[28px] p-6 border-l-4 border-cyan-400">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h4 class="font-black text-white italic text-lg">${name}</h4>
                <div class="flex items-center gap-2 mt-3 flex-wrap">
                  <span class="pill cyan">${totalSets} ì„¸íŠ¸</span>
                  <span class="pill">ëª©í‘œ REP: ${plannedRep}</span>
                  <span class="pill">ì´ REP: ${repSum}</span>
                </div>
                ${compareText ? `<div class="mt-3 text-[12px] font-black text-white/70">${compareText}</div>` : `<div class="mt-3 text-[12px] font-black text-white/40">ì§€ë‚œì£¼ ê¸°ë¡ ì—†ìŒ</div>`}
              </div>

              <button class="pill" onclick="toggleExerciseTable('${exerciseId}')">
                <i class="fa-solid fa-chevron-down"></i> í¼ì¹˜ê¸°
              </button>
            </div>

            <div class="mt-5 hidden" id="table-${exerciseId}">
              <table class="log-table">
                <thead>
                  <tr>
                    <th style="width:60px;">ì„¸íŠ¸</th>
                    <th>REP</th>
                    <th style="width:90px;">REST</th>
                  </tr>
                </thead>
                <tbody>${tableRows}</tbody>
              </table>
            </div>
          </div>
        `;
      });
    }

    function toggleExerciseTable(exerciseId){
      const t = document.getElementById(`table-${exerciseId}`);
      if(!t) return;
      t.classList.toggle('hidden');
      showDockTemporarily();
    }

    /* ---------- CALENDAR ---------- */
    function renderCalendar(){
      document.getElementById('calendar-month').innerText = `${currentYear}.${String(currentMonth + 1).padStart(2,'0')}`;
      const first = new Date(currentYear, currentMonth, 1).getDay();
      const last = new Date(currentYear, currentMonth + 1, 0).getDate();
      const body = document.getElementById('calendar-body');
      body.innerHTML = '';

      for(let i=0;i<first;i++) body.innerHTML += '<div></div>';

      for(let d=1; d<=last; d++){
        const dStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hasLog = logs.some(l => l.date === dStr);

        const el = document.createElement('div');
        el.className = `calendar-day cursor-pointer ${dStr===todayStr()?'today':''} ${hasLog?'has-log':''}`;
        if(dStr === selectedDate) el.classList.add('selected');
        el.innerText = d;
        el.onclick = () => { selectedDate = dStr; renderCalendar(); showDockTemporarily(); };
        body.appendChild(el);
      }

      renderHistoryDetail();
    }

    function changeMonth(dir){
      showDockTemporarily();
      currentMonth += dir;
      if(currentMonth < 0){ currentMonth = 11; currentYear--; }
      if(currentMonth > 11){ currentMonth = 0; currentYear++; }
      renderCalendar();
    }

    function resetSelectedDate(){
      showDockTemporarily();
      if(!confirm('ì„ íƒí•œ ë‚ ì§œì˜ ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      const date = selectedDate;
      logs = logs.filter(l => l.date !== date);
      localStorage.setItem(KEY_LOGS, JSON.stringify(logs));
      if(progressByDate[date]){ delete progressByDate[date]; localStorage.setItem(KEY_PROGRESS_BY_DATE, JSON.stringify(progressByDate)); }
      stopwatchSessions[date] = 0;
      localStorage.setItem(KEY_SW, JSON.stringify(stopwatchSessions));

      toast('ì„ íƒ ë‚ ì§œ ì´ˆê¸°í™”');
      renderCalendar();
      haptic(25);
    }

    /* ---------- STATS ---------- */
    function renderStats(){
      const counts = { push:0, pull:0, leg:0, rest:0 };
      logs.forEach(l => counts[l.type] !== undefined && counts[l.type]++);

      document.getElementById('stat-total-sets').innerText = logs.length;
      document.getElementById('stat-week-count').innerText = new Set(logs.map(l => l.date)).size;

      const ctx = document.getElementById('radarChart').getContext('2d');
      if(window.myRadar) window.myRadar.destroy();

      window.myRadar = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['PUSH','PULL','LEGS','REST'],
          datasets: [{
            data: [counts.push, counts.pull, counts.leg, counts.rest],
            backgroundColor: 'rgba(34,211,238,0.10)',
            borderColor: '#22d3ee',
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          scales: {
            r: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              angleLines: { color: 'rgba(255,255,255,0.05)' },
              pointLabels: { color: '#777', font: { weight: '800' } },
              ticks: { display: false }
            }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    /* ---------- BACKUP / RESET ALL ---------- */
    function backupJSON(){
      showDockTemporarily();
      const payload = {
        version: 'v12.0',
        exportedAt: nowISO(),
        logs, customSets, customReps, progressByDate, stopwatchSessions
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `dk_master_os_backup_${todayStr()}.json`;
      a.click();
      toast('ë°±ì—… ë‹¤ìš´ë¡œë“œ');
      haptic(18);
    }

    function resetAll(){
      showDockTemporarily();
      if(!confirm('âš ï¸ ëª¨ë“  ë°ì´í„°(ê¸°ë¡/ì„¤ì •/ì§„í–‰)ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
      localStorage.removeItem(KEY_LOGS);
      localStorage.removeItem(KEY_SETS);
      localStorage.removeItem(KEY_REPS);
      localStorage.removeItem(KEY_PROGRESS_BY_DATE);
      localStorage.removeItem(KEY_SUMMARY_SHOWN);
      localStorage.removeItem(KEY_SW);
      logs = []; customSets = {}; customReps = {}; progressByDate = {}; stopwatchSessions = {};
      renderCarousel();
      updateProgressUI();
      renderCalendar();
      toast('ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
      haptic(30);
    }

    /* ---------- ZOOM PREVENT ---------- */
    (function preventZoom(){
      document.addEventListener('gesturestart', (e)=> e.preventDefault(), {passive:false});
      document.addEventListener('gesturechange', (e)=> e.preventDefault(), {passive:false});
      document.addEventListener('gestureend', (e)=> e.preventDefault(), {passive:false});

      let lastTouchEnd = 0;
      document.addEventListener('touchend', (e)=>{
        const now = Date.now();
        if(now - lastTouchEnd <= 260) e.preventDefault();
        lastTouchEnd = now;
      }, {passive:false});

      document.addEventListener('dblclick', (e)=> e.preventDefault(), {passive:false});
    })();

    /* âœ… Dock Auto Hide Controller */
    let dockTimer = null;
    function showDockTemporarily(){
      const dock = document.querySelector('.navDockWrap');
      if(!dock) return;

      dock.classList.remove('dock-hide');
      dock.classList.add('dock-show');

      if(dockTimer) clearTimeout(dockTimer);
      dockTimer = setTimeout(()=>{
        dock.classList.remove('dock-show');
        dock.classList.add('dock-hide');
      }, 1800);
    }

    ['scroll','touchstart','touchmove','click'].forEach(ev=>{
      window.addEventListener(ev, showDockTemporarily, {passive:true});
    });

    /* ---------- INIT ---------- */
    window.onload = () => {
      initIntro();
      updateDayNav();
      changeDay(new Date().getDay());
      renderCalendar();

      const btn = document.getElementById('notif-toggle');
      if(btn){
        btn.textContent = restNotifEnabled ? 'ON' : 'OFF';
        btn.classList.toggle('cyan', restNotifEnabled);
      }

      // wake lock best effort
      requestWakeLock();

      // persist stopwatch every 10 sec if running
      setInterval(()=>{
        if(swRunning){
          const now = Date.now();
          const delta = Math.floor((now - swStartTs)/1000);
          stopwatchSessions[todayStr()] = swAccum + delta;
          localStorage.setItem(KEY_SW, JSON.stringify(stopwatchSessions));
        }
      }, 10000);

      setTimeout(()=> {
        const dock = document.querySelector('.navDockWrap');
        dock && dock.classList.add('dock-hide');
      }, 1200);
    };

    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') closeTimer(false);
    });
  </script>
</body>
</html>

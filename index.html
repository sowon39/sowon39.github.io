<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>DK FIT NEXT ¬∑ Elite Fitness OS</title>

  <!-- PWA (optional) -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DK FIT">
  <meta name="theme-color" content="#050507">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- manifest.json / icons are optional -->
  <!-- <link rel="manifest" href="manifest.json"> -->
  <!-- <link rel="apple-touch-icon" href="icon-192.png"> -->

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800;900&display=swap');
    :root{
      --bg:#050507;
      --card: rgba(255,255,255,0.045);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.86);
      --muted: rgba(255,255,255,0.45);
      --primary:#22d3ee;
      --accent:#6366f1;
      --danger:#fb7185;
      --good:#34d399;

      --dockH: 106px;
      --headerH: 88px;
      --radius: 30px;
    }

    html,body{ height:100%; }
    html{
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }
    body{
      font-family:'Pretendard',system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior: none;

      /* Liquid Glass bg */
      background-image:
        radial-gradient(1200px 700px at 15% -10%, rgba(34,211,238,0.18), transparent 55%),
        radial-gradient(1200px 700px at 100% 10%, rgba(99,102,241,0.22), transparent 55%),
        radial-gradient(900px 600px at 15% 110%, rgba(12,74,110,0.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.035), rgba(255,255,255,0.00));
      background-attachment: fixed;
    }
    ::-webkit-scrollbar{ display:none; }
    .scroll-hide{ -ms-overflow-style:none; scrollbar-width:none; }

    /* glass */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 30px 90px rgba(0,0,0,0.55);
    }

    .layout{
      width:100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* =====================================
      Splash (Ultra modern)
    ===================================== */
    #splash{
      position:fixed; inset:0;
      z-index:10000;
      display:flex; align-items:center; justify-content:center;
      background:#050507;
      transition: all .85s cubic-bezier(.22,1,.36,1);
      overflow:hidden;
    }
    #splash::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(1200px 800px at 25% 0%, rgba(34,211,238,0.32), transparent 58%),
        radial-gradient(1000px 900px at 90% 15%, rgba(99,102,241,0.35), transparent 62%),
        radial-gradient(900px 600px at 15% 95%, rgba(34,211,238,0.22), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,1));
      filter:saturate(1.25);
      animation: floatBG 6s ease-in-out infinite alternate;
    }
    @keyframes floatBG{
      0%{ transform: translateY(0) scale(1); }
      100%{ transform: translateY(-22px) scale(1.05); }
    }
    #splash .card{
      width:min(560px, calc(100vw - 56px));
      padding: 56px 28px 44px;
      border-radius: 42px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(30px);
      box-shadow: 0 60px 190px rgba(0,0,0,0.7);
      text-align:center;
      position:relative;
      overflow:hidden;
      opacity:0;
      transform: translateY(14px) scale(.985);
      animation: splashIn 1.1s cubic-bezier(.2,.9,.2,1) forwards;
    }
    @keyframes splashIn{ to{ opacity:1; transform: translateY(0) scale(1);} }
    #splash .card .shine{
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.35), transparent 40%);
      filter: blur(10px);
      opacity:.35;
      animation: shineMove 3.2s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes shineMove{
      0%{ transform: translate(-10px, 10px); }
      100%{ transform: translate(18px, -18px); }
    }
    #splash .logo{
      font-size: 4.8rem;
      font-weight: 950;
      letter-spacing: -0.08em;
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(34,211,238,0.95));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 28px rgba(34,211,238,0.25));
      display:inline-block;
    }
    #splash .sub{
      margin-top: 12px;
      font-size: 10px;
      font-weight: 900;
      letter-spacing:.28em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.45);
    }
    #splash .loader{
      margin-top: 26px;
      height: 5px;
      background: rgba(255,255,255,0.10);
      border-radius: 999px;
      overflow:hidden;
      position:relative;
    }
    #splash .loader span{
      position:absolute; inset:0;
      width:42%;
      background: linear-gradient(90deg, rgba(34,211,238,0), rgba(34,211,238,1), rgba(99,102,241,1), rgba(34,211,238,0));
      filter: drop-shadow(0 0 14px rgba(34,211,238,0.35));
      animation: scan 1.15s ease-in-out infinite;
    }
    @keyframes scan{
      0%{ transform: translateX(-70%); }
      100%{ transform: translateX(170%); }
    }

    /* =====================================
      Header (modern minimal)
    ===================================== */
    header{
      position:fixed; left:0; right:0; top:0;
      z-index:80;
      height: var(--headerH);
      padding-top: calc(10px + env(safe-area-inset-top));
      padding-left: 16px;
      padding-right: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      background: rgba(10,10,12,0.62);
      box-sizing:border-box;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      font-size:11px;
      font-weight:900;
      color: rgba(255,255,255,0.80);
      user-select:none;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .pill.cyan{
      border-color: rgba(34,211,238,0.22);
      background: rgba(34,211,238,0.10);
      color: rgba(34,211,238,0.95);
      box-shadow: 0 12px 24px rgba(34,211,238,0.08);
    }
    .pill.danger{
      border-color: rgba(251,113,133,0.25);
      background: rgba(251,113,133,0.10);
      color: rgba(251,113,133,0.95);
    }

    main{
      padding-top: calc(var(--headerH) + 18px + env(safe-area-inset-top));
      padding-bottom: calc(var(--dockH) + env(safe-area-inset-bottom) + 28px);
    }

    /* =====================================
      Dock (Auto hide)
    ===================================== */
    .dockWrap{ position:fixed; left:0; right:0; bottom:0; z-index:95; padding: 16px; }
    .dock{
      border-radius: 36px;
      background: rgba(10,10,12,0.78);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(22px);
      box-shadow: 0 25px 60px rgba(0,0,0,0.72);
      padding: 10px;
      display:flex;
      justify-content: space-around;
      align-items:center;
    }
    .dockBtn{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      padding: 10px 0;
      color:#777;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .22s, color .22s;
      position:relative;
    }
    .dockBtn.active{
      color: var(--primary);
      transform: translateY(-3px);
    }
    .dockBtn i{ font-size: 1.2rem; }
    .dot{
      position:absolute;
      bottom: 3px;
      width: 4px; height: 4px;
      border-radius: 999px;
      background: var(--primary);
      box-shadow: 0 0 12px var(--primary);
      opacity:0;
      transform: scale(.6);
      transition: opacity .22s, transform .22s;
    }
    .dockBtn.active .dot{ opacity:1; transform: scale(1.6); }

    .dockWrap{
      transition: transform .45s cubic-bezier(0.22, 1, 0.36, 1), opacity .35s ease;
      will-change: transform, opacity;
    }
    .dockWrap.hide{
      transform: translateY(120%);
      opacity: 0;
      pointer-events: none;
    }
    .dockWrap.show{
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    /* =====================================
      Home / Cards
    ===================================== */
    .heroTitle{
      font-size: 44px;
      font-weight: 950;
      letter-spacing: -0.05em;
      line-height: 1;
      color:white;
    }
    .heroTitle em{
      font-style: italic;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 28px rgba(34,211,238,0.18);
    }

    .segBar{
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      overflow:hidden;
    }
    .segFill{
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      box-shadow: 0 0 16px rgba(34,211,238,0.35);
      transition: width .6s ease;
    }

    /* =====================================
      Workout carousel
    ===================================== */
    .carousel{
      display:flex;
      gap:18px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 0 22px 18px;
      margin: 0 -22px;
      touch-action: pan-x pan-y;
    }
    .carousel::before,.carousel::after{ content:''; flex:0 0 22px; }
    .slide{ scroll-snap-align:center; flex:0 0 calc(100% - 110px); transition: opacity .22s, transform .22s, filter .22s; }
    .slide.peek{ opacity:.60; transform: scale(.965); filter: blur(.6px); }
    .slide.focus{ opacity:1; transform: scale(1); filter:none; }

    @media(min-width: 860px){
      .slide{ flex:0 0 calc(100% - 160px); }
      .slide.peek{ opacity:.62; transform: scale(.97); filter: blur(.45px); }
    }

    .cardRound{ border-radius: var(--radius); overflow:hidden; }

    .setBtn{
      height: 62px;
      border-radius: 20px;
      font-weight: 950;
      font-size: 16px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s, opacity .12s;
    }
    .setBtn:active{ transform: scale(.985); }
    .setBtn.done{
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color:#000;
      border:none;
      box-shadow: 0 18px 34px rgba(34,211,238,0.24);
    }
    .setBtn.locked{
      opacity:.30;
      pointer-events:none;
      filter:saturate(.6);
    }

    .stepper{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px;
      border-radius: 22px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .stepperLabel{
      font-size:10px;
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,0.48);
    }
    .stepperValue{
      font-size: 22px;
      font-weight: 950;
      color:white;
      letter-spacing: -0.02em;
    }
    .stepperBtn{
      width:48px; height:48px;
      border-radius: 18px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.9);
      -webkit-tap-highlight-color: transparent;
      user-select:none;
      transition: transform .08s;
    }
    .stepperBtn:active{ transform: scale(.98); }

    /* =====================================
      Modals / sheets
    ===================================== */
    .modalWrap{
      position:fixed; inset:0; z-index:250;
      display:none;
      align-items:center; justify-content:center;
    }
    .modalWrap.show{ display:flex; }
    .modalBack{
      position:absolute; inset:0;
      background: rgba(0,0,0,0.78);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    .modalCard{
      width:min(560px, calc(100vw - 44px));
      border-radius: 30px;
      padding: 18px;
      background: rgba(10,10,12,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 40px 160px rgba(0,0,0,0.75);
      position:relative;
      z-index:2;
    }

    /* toast */
    #toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 128px;
      z-index:300;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s, transform .25s;
    }
    #toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }

    /* timer modal */
    #timerModal{
      position:fixed; inset:0; z-index:220;
      display:none;
      align-items:center; justify-content:center;
    }
    #timerModal.show{ display:flex; }
    #timerSec{
      font-size: 11rem;
      line-height: 1;
      font-weight: 950;
      letter-spacing: -0.08em;
      font-style: italic;
      color:white;
      text-shadow: 0 0 30px rgba(255,255,255,0.15);
    }

    /* Timer HUD */
    #timerHud{
      position:fixed;
      top: calc(var(--headerH) + 10px + env(safe-area-inset-top));
      right: 14px;
      z-index: 230;
      display:none;
    }
    #timerHud.show{ display:block; }
    .hudCard{
      border-radius: 24px;
      padding: 12px 14px;
      display:flex; gap:12px; align-items:center;
      background: rgba(10,10,12,0.75);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.60);
      min-width: 178px;
      user-select:none;
    }
    .hudLabel{
      font-size: 9px;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight: 900;
      color: rgba(255,255,255,0.45);
    }
    .hudTime{
      font-size: 22px;
      font-weight: 950;
      letter-spacing: -0.06em;
      color:white;
      line-height: 1;
    }
    .hudBarWrap{
      margin-top: 8px;
      height: 6px;
      background: rgba(255,255,255,0.10);
      border-radius: 999px;
      overflow:hidden;
    }
    .hudBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      box-shadow: 0 0 14px rgba(34,211,238,0.35);
      border-radius: 999px;
    }
    .hudBtn{
      width:34px; height:34px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.9);
      -webkit-tap-highlight-color: transparent;
    }
    .hudBtn:active{ transform: scale(.98); }

    /* calendar */
    .calendar-day{
      aspect-ratio: 1;
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 13px;
      font-weight: 900;
      color: rgba(255,255,255,0.75);
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      user-select:none;
      position:relative;
      transition: transform .14s, border .14s, box-shadow .14s;
    }
    .calendar-day:active{ transform: scale(.985); }
    .calendar-day.today{
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.95);
    }
    .calendar-day.has-log::after{
      content:"";
      width: 6px; height: 6px;
      background: rgba(34,211,238,0.95);
      border-radius: 999px;
      position:absolute;
      bottom: 8px;
      box-shadow: 0 0 12px rgba(34,211,238,0.35);
    }
    .calendar-day.selected{
      background: rgba(34,211,238,0.14);
      border: 1px solid rgba(34,211,238,0.35);
      box-shadow: 0 0 0 2px rgba(34,211,238,0.18), 0 0 32px rgba(34,211,238,0.12);
      transform: translateY(-2px);
      color: #eaffff;
    }

    /* mobile optimize */
    @media(max-width: 520px){
      :root{ --dockH: 94px; --headerH: 86px; --radius: 26px; }
      header{ padding-left: 14px; padding-right: 14px; }
      .heroTitle{ font-size: 40px; }
      #timerSec{ font-size: 9.3rem; }
      .slide{ flex:0 0 calc(100% - 70px); }
      .setBtn{ height: 54px; font-size: 15px; border-radius: 18px; }
      .stepperBtn{ width: 44px; height: 44px; border-radius: 16px; }
    }
  </style>
</head>

<body>

  <!-- Splash -->
  <div id="splash">
    <div class="card">
      <div class="shine"></div>
      <div class="logo">DK FIT</div>
      <div class="sub">Elite Fitness OS ¬∑ Next</div>
      <div class="loader"><span></span></div>
    </div>
  </div>

  <!-- HEADER -->
  <header>
    <div class="layout flex items-end justify-between gap-3">
      <div class="min-w-0">
        <div class="flex items-center gap-2">
          <div id="stopwatch" class="text-3xl font-black font-mono tracking-tighter text-white">00:00</div>
          <button class="pill cyan" onclick="toggleStopwatchPause()" title="Ï¥ù Ïö¥ÎèôÏãúÍ∞Ñ ÏùºÏãúÏ†ïÏßÄ">
            <i id="pauseIcon" class="fa-solid fa-pause"></i>
          </button>
        </div>
        <div class="flex items-center gap-2 mt-1">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span>
          <p class="text-[9px] font-black tracking-[0.26em] uppercase text-white/55">ELITE MODE ¬∑ DK</p>
        </div>
      </div>

      <div class="min-w-[150px]">
        <div class="flex items-center justify-end gap-2">
          <span id="progressPct" class="text-[10px] font-black text-cyan-300">0%</span>
          <span id="progressText" class="text-[9px] font-black tracking-[0.22em] uppercase text-white/40">ÌòÑÏû¨ 0% ÏôÑÎ£å!</span>
        </div>
        <div class="segBar mt-2">
          <div id="progressBar" class="segFill"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- TIMER HUD -->
  <div id="timerHud">
    <div class="hudCard">
      <div class="min-w-[72px]">
        <div class="hudLabel">REST</div>
        <div id="hudTime" class="hudTime">60</div>
        <div class="hudBarWrap"><div id="hudBar" class="hudBar"></div></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="hudBtn" onclick="openTimer()" title="ÌÉÄÏù¥Î®∏ Î≥¥Í∏∞"><i class="fa-solid fa-expand"></i></button>
        <button class="hudBtn" onclick="closeTimer(false)" title="Ïä§ÌÇµ"><i class="fa-solid fa-forward"></i></button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main>
    <div class="layout px-4">

      <!-- TAB: HOME -->
      <section id="tab-home" class="tab active">
        <div class="mt-2 px-2">
          <div class="flex items-start justify-between gap-4">
            <div class="min-w-0">
              <div class="heroTitle">
                <span id="homeDay">DAY</span>
                <em class="ml-1" id="homeType">PUSH</em>
              </div>
              <p class="mt-2 text-sm font-black text-white/75" id="homeTitle"></p>
              <p class="mt-3 text-[10px] font-black tracking-[0.22em] uppercase text-white/45" id="homeCue"></p>
            </div>

            <div class="flex flex-col items-end gap-2">
              <button class="pill" onclick="resetToday()" title="Ïò§Îäò ÏßÑÌñâ/Í∏∞Î°ù Ï¥àÍ∏∞Ìôî">
                <i class="fa-solid fa-rotate-left"></i> Ïò§Îäò Ï¥àÍ∏∞Ìôî
              </button>
              <button class="pill cyan" onclick="openQuickStart()" title="Îπ†Î•∏ ÏãúÏûë">
                <i class="fa-solid fa-bolt"></i> Quick Start
              </button>
            </div>
          </div>

          <!-- day chips -->
          <div class="mt-5 flex items-center justify-between gap-3">
            <div class="flex gap-2 overflow-x-auto scroll-hide py-1" id="dayChips"></div>
            <div class="flex items-center gap-2">
              <span class="pill cyan" id="slideIndicator">1 / 1</span>
              <button class="pill" onclick="prevSlide()"><i class="fa-solid fa-chevron-left"></i></button>
              <button class="pill" onclick="nextSlide()"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
          </div>
        </div>

        <!-- carousel -->
        <div class="mt-5" id="carousel" class="carousel scroll-hide"></div>
      </section>

      <!-- TAB: INSIGHTS -->
      <section id="tab-insights" class="tab hidden">
        <div class="mb-8 px-2">
          <h2 class="text-3xl font-black italic uppercase tracking-tight text-white">Insights</h2>
          <p class="text-[11px] font-black tracking-[0.22em] uppercase text-white/45 mt-2">
            Ïª®ÎîîÏÖò ¬∑ Î∞∏Îü∞Ïä§ ¬∑ ÎàÑÏ†Å Î≥ºÎ•®ÏùÑ ÏãúÍ∞ÅÌôîÌï©ÎãàÎã§
          </p>
        </div>

        <div class="glass cardRound p-7 mb-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">Muscle Balance</p>
              <p class="text-sm font-black text-white/70 mt-2">Push / Pull / Legs / Rest</p>
            </div>
            <button class="pill cyan" onclick="renderCharts(true)"><i class="fa-solid fa-rotate"></i> Refresh</button>
          </div>
          <div class="mt-6">
            <canvas id="radar" class="max-h-[320px]"></canvas>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-5 mb-6">
          <div class="glass cardRound p-6">
            <p class="text-[9px] font-black tracking-[0.22em] uppercase text-white/45 mb-2">Total Sets</p>
            <p id="statSets" class="text-4xl font-black text-white">0</p>
            <p class="text-[11px] font-black text-white/35 mt-3">ÎàÑÏ†Å Í∏∞Î°ù ÏÑ∏Ìä∏ Ïàò</p>
          </div>
          <div class="glass cardRound p-6">
            <p class="text-[9px] font-black tracking-[0.22em] uppercase text-white/45 mb-2">Active Days</p>
            <p id="statDays" class="text-4xl font-black text-indigo-300">0</p>
            <p class="text-[11px] font-black text-white/35 mt-3">Ïö¥ÎèôÌïú ÎÇ†Ïßú Ïàò</p>
          </div>
        </div>

        <div class="glass cardRound p-7 mb-6">
          <div class="flex items-start justify-between gap-4">
            <div>
              <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">Weekly Volume</p>
              <p class="text-sm font-black text-white/70 mt-2">ÏµúÍ∑º 7Ïùº ÏÑ∏Ìä∏ Ïàò</p>
            </div>
          </div>
          <div class="mt-6">
            <canvas id="weekly" class="max-h-[260px]"></canvas>
          </div>
        </div>

        <div class="glass cardRound p-6 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">Rest Notification</p>
              <p class="text-sm font-black text-white/70 mt-2">ÌÉÄÏù¥Î®∏ Ï¢ÖÎ£å Ïãú ÏÜåÎ¶¨/ÏßÑÎèô</p>
            </div>
            <button id="notifToggle" class="pill cyan" onclick="toggleNotif()">ON</button>
          </div>
          <p class="text-[11px] font-black text-white/35 mt-3">
            * iOS Î¨¥ÏùåÎ™®ÎìúÏóêÏÑúÎäî ÏÜåÎ¶¨Í∞Ä Ï†úÌïúÎê† Ïàò ÏûàÏäµÎãàÎã§.
          </p>
        </div>

        <div class="grid gap-3">
          <button class="pill w-full justify-center py-4" onclick="backupJSON()"><i class="fa-solid fa-download"></i> Î∞±ÏóÖ(JSON)</button>
          <button class="pill danger w-full justify-center py-4" onclick="exportCSV()"><i class="fa-solid fa-file-csv"></i> Í∏∞Î°ù CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
          <button class="pill danger w-full justify-center py-4" onclick="resetAll()"><i class="fa-solid fa-triangle-exclamation"></i> Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî</button>
        </div>
      </section>

      <!-- TAB: HISTORY -->
      <section id="tab-history" class="tab hidden">
        <div class="mb-6 px-2 flex items-end justify-between">
          <h2 class="text-3xl font-black italic uppercase text-white">History</h2>
          <div class="flex items-center gap-4 glass rounded-2xl px-5 py-2.5">
            <button onclick="changeMonth(-1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-left text-xs"></i></button>
            <span id="monthLabel" class="text-xs font-black w-20 text-center tracking-widest">2026.01</span>
            <button onclick="changeMonth(1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-right text-xs"></i></button>
          </div>
        </div>

        <div class="grid gap-4 md:grid-cols-[360px_1fr]">
          <div>
            <div class="glass cardRound p-6 shadow-2xl">
              <div class="grid grid-cols-7 text-center text-[9px] font-black text-gray-500 mb-5 uppercase tracking-[0.2em]">
                <div class="text-rose-500">Ïùº</div><div>Ïõî</div><div>Ìôî</div><div>Ïàò</div><div>Î™©</div><div>Í∏à</div><div class="text-indigo-400">ÌÜ†</div>
              </div>
              <div id="calendar" class="grid grid-cols-7 gap-3"></div>
            </div>

            <button class="pill w-full justify-center mt-4" onclick="resetSelectedDate()">
              <i class="fa-solid fa-eraser"></i> ÏÑ†ÌÉù ÎÇ†Ïßú Ï¥àÍ∏∞Ìôî
            </button>
          </div>

          <div id="historyDetail" class="space-y-5"></div>
        </div>
      </section>

    </div>
  </main>

  <!-- DOCK -->
  <div class="dockWrap show" id="dockWrap">
    <div class="layout">
      <nav class="dock" style="margin-bottom: calc(env(safe-area-inset-bottom) + 6px);">
        <button class="dockBtn active" onclick="showTab('home', this)">
          <i class="fa-solid fa-bolt-lightning"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">HOME</span>
          <div class="dot"></div>
        </button>
        <button class="dockBtn" onclick="showTab('insights', this)">
          <i class="fa-solid fa-chart-simple"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">INSIGHTS</span>
          <div class="dot"></div>
        </button>
        <button class="dockBtn" onclick="showTab('history', this)">
          <i class="fa-solid fa-calendar-days"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">HISTORY</span>
          <div class="dot"></div>
        </button>
      </nav>
    </div>
  </div>

  <!-- REP MODAL -->
  <div id="repModal" class="modalWrap">
    <div class="modalBack" onclick="closeRep(false)"></div>
    <div class="modalCard">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">REP ÏûÖÎ†•</p>
          <h3 id="repTitle" class="text-2xl font-black italic text-white mt-1">Ïö¥Îèô</h3>
          <p id="repSub" class="text-[10px] font-black tracking-[0.22em] uppercase text-white/35 mt-2">1 SET</p>
        </div>
        <button class="pill" onclick="closeRep(false)"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-5 glass rounded-2xl p-5">
        <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/40">Í∏∞Î≥∏ REP</p>
        <div class="flex items-end justify-between mt-2">
          <div id="repBase" class="text-5xl font-black text-white tracking-tighter">20</div>
          <div class="text-[10px] font-black tracking-[0.18em] uppercase text-white/35 text-right">
            Ï∂îÏ≤ú ÏûÖÎ†•<br>Î≤ÑÌäºÎßå ÌÅ¥Î¶≠
          </div>
        </div>
      </div>

      <div class="mt-4 glass rounded-2xl p-4">
        <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">AI Ï∂îÏ≤ú</p>
        <div id="repAI" class="mt-3 grid grid-cols-3 gap-2"></div>

        <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/35 mt-5">Ï∂îÏ≤ú Ïà´Ïûê</p>
        <div id="repGrid" class="mt-3 grid grid-cols-5 gap-2"></div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button class="pill w-full justify-center py-4" onclick="closeRep(false)">
          <i class="fa-solid fa-ban"></i> Ï∑®ÏÜå
        </button>
        <button class="pill cyan w-full justify-center py-4" onclick="repSkip()">
          <i class="fa-solid fa-check"></i> Í∏∞Î≥∏ REP Í∏∞Î°ù
        </button>
      </div>

      <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/30 mt-4">
        * ÏûÖÎ†• ÌõÑ ÏßÄÎÇúÏ£º ÎèôÏùº ÏöîÏùºÍ≥º ÎπÑÍµê Í≤∞Í≥ºÍ∞Ä ÌÜ†Ïä§Ìä∏Î°ú ÌëúÏãúÎê©ÎãàÎã§
      </p>
    </div>
  </div>

  <!-- TIMER MODAL -->
  <div id="timerModal">
    <div class="absolute inset-0 bg-black/95 backdrop-blur-2xl" onclick="minimizeTimer()"></div>
    <div class="relative text-center">
      <div class="text-[10px] font-black tracking-[0.24em] uppercase text-white/40 mb-3">REST</div>
      <div id="timerSec">60</div>

      <div class="mt-6 flex items-center justify-center gap-3">
        <button class="pill px-7 py-4" onclick="adjustRest(-10)">-10</button>
        <button class="pill cyan px-10 py-4" onclick="minimizeTimer()">MINIMIZE</button>
        <button class="pill px-7 py-4" onclick="adjustRest(10)">+10</button>
      </div>

      <div class="mt-4 flex items-center justify-center gap-3">
        <button class="pill" onclick="closeTimer(false)"><i class="fa-solid fa-forward"></i> Ïä§ÌÇµ</button>
      </div>

      <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/35 mt-6">ÏµúÏÜå Î∞©Ìï¥ ¬∑ ÏµúÎåÄ ÏßëÏ§ë</p>
    </div>
  </div>

  <!-- SUMMARY MODAL -->
  <div id="summaryModal" class="modalWrap">
    <div class="modalBack" onclick="closeSummary()"></div>
    <div class="modalCard">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">Ïò§Îäò ÏöîÏïΩ</p>
          <h3 class="text-2xl font-black italic text-white mt-1">ÏôÑÎ£å üéâ</h3>
        </div>
        <button class="pill" onclick="closeSummary()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <div class="glass rounded-2xl p-4">
          <p class="text-[9px] font-black tracking-[0.22em] uppercase text-white/40">ÏôÑÎ£å ÏÑ∏Ìä∏</p>
          <p id="sumSets" class="text-3xl font-black text-white mt-2">0</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <p class="text-[9px] font-black tracking-[0.22em] uppercase text-white/40">ÏôÑÎ£å Ïö¥Îèô</p>
          <p id="sumEx" class="text-3xl font-black text-white mt-2">0</p>
        </div>
        <div class="glass rounded-2xl p-4 col-span-2">
          <p class="text-[9px] font-black tracking-[0.22em] uppercase text-white/40">Ïò§Îäò ÌïúÎßàÎîî</p>
          <p id="sumMsg" class="text-base font-black text-white/85 mt-2">Ï¢ãÏùÄ ÌõàÎ†®Ïù¥ÏóàÏäµÎãàÎã§.</p>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button class="pill cyan w-full justify-center py-4" onclick="closeSummary()">
          <i class="fa-solid fa-check"></i> ÌôïÏù∏
        </button>
        <button class="pill w-full justify-center py-4" onclick="showTab('history', document.querySelectorAll('.dockBtn')[2]); closeSummary();">
          Í∏∞Î°ù Î≥¥Í∏∞
        </button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="pill cyan"></div>

  <script>
    /**
     * DK FIT NEXT
     * - ÏµúÏã† Fit App UI/UX
     * - Smart Set Flow (Set -> Rep modal -> Rest timer)
     * - Insights charts
     * - History calendar + daily report
     * - Minimal rerender + flicker-free
     */

    /* =========================
      DATA (You can expand)
    ========================= */
    const workoutData = {
      1: { day: "ÏõîÏöîÏùº", type: "push", title: "Í∞ÄÏä¥ & ÏÇºÎëê", list: [
        { name:"Ï≤¥Ïä§Ìä∏ Îî•Ïä§", set:4, rep:10, rest:90, target:"Í∞ÄÏä¥ ÌïòÎ∂Ä", cue:"ÏãúÏÑ† Î∞îÎã• 1~2m ¬∑ Ìåî 95%Îßå Ìé¥ Í∏¥Ïû• Ïú†ÏßÄ", breath:"ÎÇ¥Î†§Í∞à Îïå Ìù°Í∏∞ / Ïò¨ÎùºÏò¨ Îïå Ìò∏Í∏∞", mind:"Î∞îÎã•ÏùÑ Í∞ÄÏä¥ÏúºÎ°ú Î∞ÄÍ∏∞", tip:"ÏÉÅÏ≤¥ 15ÎèÑ ÏàôÏù¥Í∏∞", guide:"Î∞úÏùÑ ÎåÄÍ≥† Î¨¥Í≤å Ï°∞Ï†à Í∞ÄÎä•" },
        { name:"Ïä§ÌÉ†Îã§Îìú Ìë∏Ïâ¨ÏóÖ", set:4, rep:15, rest:75, target:"Í∞ÄÏä¥ Ï†ÑÏ≤¥", cue:"Í≤®ÎìúÎûëÏù¥Î•º Î∂ôÏù¥Î©∞ Î∞ÄÏñ¥ Ïò¨Î¶¨Í∏∞", breath:"ÎÇ¥Î¶¥ Îïå Ìù°Í∏∞ / Î∞Ä Îïå Ìò∏Í∏∞", mind:"ÏßÄÎ©¥ÏùÑ Í∞ÄÏä¥ÏúºÎ°ú ÎàÑÎ•¥Í∏∞", tip:"ÏÜêÎ∞îÎã• Ï†ÑÏ≤¥ Ï†ëÏßÄ", guide:"Î¨¥Î¶é ÎåÄÍ≥† ÏàòÌñâ Í∞ÄÎä•" },
        { name:"ÎÇ¥Î°úÏö∞ Îî•Ïä§", set:3, rep:10, rest:60, target:"ÏÇºÎëêÍ∑º", cue:"ÏÉÅÏ≤¥ ÏàòÏßÅ ¬∑ ÌåîÍøàÏπò Îí§Î°ú Î™®ÏúºÍ∏∞", breath:"Ìåî Ìéº Îïå Ìò∏Í∏∞", mind:"Ìåî Îí∑Î©¥ ÌûòÏúºÎ°ú Ïû†Í∏à", tip:"ÏÉÅÏ≤¥ ÏàòÏßÅ Ïú†ÏßÄ", guide:"ÌåîÍøàÏπò Î™∏Ïóê Î∞ÄÏ∞©" }
      ]},
      2: { day:"ÌôîÏöîÏùº", type:"pull", title:"Îì± ÎëêÍªò", list:[
        { name:"ÌíÄÏóÖ (Î∞¥Îìú)", set:4, rep:8, rest:120, target:"Í¥ëÎ∞∞ Î∞îÍπ•", cue:"ÏàÑÎçîÌå®ÌÇπ ‚Üí ÌåîÍøàÏπòÎ°ú ÏòÜÍµ¨Î¶¨ Ï∞çÍ∏∞", breath:"ÎãπÍ∏∏ Îïå Ìò∏Í∏∞", mind:"ÌåîÍøàÏπòÎ•º ÏòÜÍµ¨Î¶¨Î°ú ÍΩÇÍ∏∞", tip:"ÏàÑÎçî Ìå®ÌÇπ ÌïÑÏàò", guide:"Î∞¥Îìú Í∞ïÎèÑ Ï°∞Ï†à" },
        { name:"Ïù∏Î≤ÑÌã∞Îìú Î°úÏö∞", set:4, rep:12, rest:90, target:"Îì± Ï§ëÏïô", cue:"Î™∏ ÏùºÏßÅÏÑ† ¬∑ ÎÇ†Í∞úÎºà Î†àÎ™¨ ÏßúÎìØ", breath:"ÎãπÍ∏∏ Îïå Ìò∏Í∏∞", mind:"ÎÇ†Í∞úÎºàÎ•º Îí§Î°ú Î™®ÏúºÍ∏∞", tip:"Í∞ÄÏä¥ÏùÑ Î∞îÎ°ú ÎßàÏ§ë", guide:"Î∞ú ÏúÑÏπòÎ°ú ÎÇúÏù¥ÎèÑ Ï°∞Ï†à" },
        { name:"ÏπúÏóÖ (Î∞¥Îìú)", set:3, rep:8, rest:90, target:"Îì± & Ïù¥Îëê", cue:"Í∞ÄÏä¥ÏùÑ Î¥â Ï™ΩÏúºÎ°ú Ï†ëÏñ¥ ÎÑ£Í∏∞", breath:"Ïò¨ÎùºÍ∞à Îïå Ìò∏Í∏∞", mind:"Í∞ÄÏä¥ÏùÑ Î¥âÏóê Î∂ôÏù¥Í∏∞", tip:"Í∞ÄÏä¥ ÎÜíÏù¥ÍπåÏßÄ Ïò¨Î¶¨Í∏∞", guide:"Ïñ∏ÎçîÍ∑∏Î¶Ω ÏÇ¨Ïö©" }
      ]},
      3: { day:"ÏàòÏöîÏùº", type:"push", title:"Ï∏°Î©¥ Ïñ¥Íπ®", list:[
        { name:"ÏÇ¨Ïù¥Îìú Î†àÏù¥Ï¶à", set:5, rep:20, rest:60, target:"Ï∏°Î©¥ ÏÇºÍ∞ÅÍ∑º", cue:"ÏúÑÍ∞Ä ÏïÑÎãàÎùº ‚ÄòÎ©ÄÎ¶¨ ÎçòÏßÑÎã§‚Äô", breath:"Ïò¨Î¶¥ Îïå Ìò∏Í∏∞", mind:"ÌåîÍøàÏπòÎ•º ÏñëÏòÜÏúºÎ°ú ÎçòÏßê", tip:"ÎÇ†Í∞úÎºà Í≥†Ï†ï", guide:"Ï†ÄÏ§ëÎüâ Í≥†Î∞òÎ≥µ Í∂åÏû•" }
      ]},
      4: { day:"Î™©ÏöîÏùº", type:"push", title:"Ïñ¥Íπ® & ÏÇºÎëê", list:[
        { name:"ÌååÏù¥ÌÅ¨ Ìë∏Ïâ¨ÏóÖ", set:4, rep:10, rest:90, target:"Ï†ÑÎ©¥ Ïñ¥Íπ®", cue:"Ï†ïÏàòÎ¶¨Í∞Ä Î∞îÎã•Ïóê ÎãøÎìØ", breath:"Î∞Ä Îïå Ìò∏Í∏∞", mind:"Ïñ¥Íπ®Î°ú Ï≤úÏû• Î∞ÄÍ∏∞", tip:"ÏóâÎç©Ïù¥ ÎÜíÏù¥ Ïú†ÏßÄ", guide:"Î®∏Î¶¨Î•º ÏÜêÎ≥¥Îã§ ÏïûÏúºÎ°ú" },
        { name:"ÎîîÌÅ¥ÎùºÏù∏ Ìë∏Ïâ¨ÏóÖ", set:4, rep:12, rest:90, target:"ÏÉÅÎ∂Ä Í∞ÄÏä¥", cue:"ÏáÑÍ≥® ÏïÑÎûòÎ°ú Î∞îÎã•ÏùÑ ÎØºÎã§", breath:"Î∞Ä Îïå Ìò∏Í∏∞", mind:"ÏÉÅÎ∂Ä Í∞ÄÏä¥ ÏßëÏ§ë", tip:"Î∞ú ÏúÑÏπò ÎÜíÍ≤å", guide:"Í∞ÄÏä¥ ÏúÑÏ™Ω ÏûêÍ∑π ÏßëÏ§ë" },
        { name:"ÏÇºÎëê Îî•Ïä§", set:4, rep:8, rest:90, target:"ÏÇºÎëêÍ∑º", cue:"ÌåîÍøàÏπò Î≤åÏñ¥ÏßÄÏßÄ ÏïäÍ≤å", breath:"Î∞Ä Îïå Ìò∏Í∏∞", mind:"ÏÇºÎëêÎ°ú Ìé¥ÏÑú Ïû†Í∏à", tip:"ÌåîÍøàÏπò Îí§Î°ú Î™®ÏúºÍ∏∞", guide:"ÏùòÏûê ÏÇ¨Ïö© Í∞ÄÎä•" }
      ]},
      5: { day:"Í∏àÏöîÏùº", type:"pull", title:"Îì± ÎÑìÏù¥", list:[
        { name:"ÏôÄÏù¥Îìú ÌíÄÏóÖ", set:4, rep:6, rest:120, target:"Í¥ëÎ∞∞ Ïô∏Í≥Ω", cue:"ÌåîÍøàÏπòÎ•º ÏïÑÎûòÎ°ú Ï∞çÏñ¥ Í¥ëÎ∞∞", breath:"Ïò¨ÎùºÍ∞à Îïå Ìò∏Í∏∞", mind:"Îì±ÏùÑ ÎÑìÍ≤å ÌéºÏπòÍ∏∞", tip:"ÎÑìÏùÄ Í∑∏Î¶Ω ÏÇ¨Ïö©", guide:"ÏÉÅÎ∂Ä Í¥ëÎ∞∞ ÏßëÏ§ë" },
        { name:"Ïù∏Î≤ÑÌã∞Îìú Î°úÏö∞", set:4, rep:12, rest:90, target:"Îì± ÏïàÏ†ïÏÑ±", cue:"ÎëîÍ∑º/Î≥µÎ∂Ä Í≥†Ï†ï + ÎÇ†Í∞úÎºà Ï°∞Ïù¥Í∏∞", breath:"ÎãπÍ∏∏ Îïå Ìò∏Í∏∞", mind:"Î™∏ÏùÑ ÏùºÏßÅÏÑ†ÏúºÎ°ú", tip:"ÌÖúÌè¨ ÏùºÏ†ïÌïòÍ≤å", guide:"ÏΩîÏñ¥ Îã®Îã®Ìûà Í≥†Ï†ï" },
        { name:"ÎÇ¥Î°úÏö∞ ÌíÄÏóÖ", set:3, rep:8, rest:90, target:"Îì± Ï§ëÏïô", cue:"Í∞ÄÏä¥ÏùÑ Î¥âÏóê ÏµúÎåÄÌïú Î∂ôÏù¥Í∏∞", breath:"Ïò¨ÎùºÍ∞à Îïå Ìò∏Í∏∞", mind:"Î¥âÏóê Í∞ÄÏä¥ ÌÑ∞Ïπò", tip:"1Ï¥àÍ∞Ñ Ï†ïÏßÄ", guide:"Ï¢ÅÏùÄ Í∑∏Î¶Ω" }
      ]},
      6: { day:"ÌÜ†ÏöîÏùº", type:"leg", title:"ÌïòÏ≤¥ & ÏΩîÏñ¥", list:[
        { name:"Ïä§ÏøºÌä∏", set:4, rep:20, rest:60, target:"ÌóàÎ≤ÖÏßÄ/ÎëîÍ∑º", cue:"ÎÇÆÏùÄ ÏùòÏûêÏóê ÏïâÏïòÎã§Í∞Ä ÏßÄÍµ¨Î•º ÎØºÎã§", breath:"Ïò¨ÎùºÏò¨ Îïå Ìò∏Í∏∞", mind:"Î∞úÎ∞îÎã• ÏßÄÎ©¥ Î∞ÄÍ∏∞", tip:"ÌóàÎ¶¨ Ï§ëÎ¶Ω Ïú†ÏßÄ", guide:"Îí§ÍøàÏπò Í≥†Ï†ï" },
        { name:"Îü∞ÏßÄ", set:3, rep:10, rest:60, target:"ÏóâÎç©Ïù¥", cue:"ÏïûÎ∞ú Îí§ÍøàÏπòÎ°ú Í∞ïÎ†•ÌïòÍ≤å Î∞ÄÍ∏∞", breath:"Ïò¨ÎùºÏò¨ Îïå Ìò∏Í∏∞", mind:"Îí§ÍøàÏπò Ìûò Ï†ÑÎã¨", tip:"ÏÉÅÏ≤¥ ÏÇ¥Ïßù ÏàôÏù¥Í∏∞", guide:"Î¨¥Î¶é ÏïàÏ†ïÏÑ± Ïú†Ïùò" },
        { name:"ÌîåÎû≠ÌÅ¨", set:3, rep:60, rest:60, target:"ÏΩîÏñ¥", cue:"Í∞ïÏ≤† ÌåêÏûêÏ≤òÎüº Î≤ÑÌã∞Í∏∞", breath:"ÏùºÏ†ïÌïòÍ≤å Ïú†ÏßÄ", mind:"Î∞∞Î•º ÏïàÏúºÎ°ú ÎãπÍ∏∞Í∏∞", tip:"ÏóâÎç©Ïù¥ ÏàòÏ∂ï", guide:"ÏùºÏßÅÏÑ† Ïú†ÏßÄ" }
      ]},
      0: { day:"ÏùºÏöîÏùº", type:"rest", title:"ÌöåÎ≥µ", list:[
        { name:"Ïä§Ìä∏Î†àÏπ≠", set:1, rep:15, rest:0, target:"Ï†ÑÏã† Ïù¥ÏôÑ", cue:"Î∂ÄÎìúÎüΩÍ≤å Í∏∏Í≤å, Í∞ïÎèÑÎ≥¥Îã§ Ìò∏Ìù°", breath:"ÍπäÍ≥† Í∏∏Í≤å", mind:"Í∑ºÏú° Ïù¥ÏôÑ ÎäêÎÅºÍ∏∞", tip:"Ïñ¥Íπ®/Í¥ëÎ∞∞ ÏßëÏ§ë", guide:"Ï∂©Î∂ÑÌïú ÏàòÎ©¥ Í∂åÏû•" }
      ]}
    };

    /* =========================
      GIF mapping (optional)
    ========================= */
    function getGifByExerciseName(name){
      const n = (name||'').toLowerCase();
      if(n.includes('Ïä§ÏøºÌä∏')||n.includes('squat')) return 'AIR_SQT.gif';
      if(n.includes('ÏπúÏóÖ')||n.includes('chin')) return 'CHIN_UP.gif';
      if(n.includes('ÏÇ¨Ïù¥Îìú')||n.includes('lateral')||n.includes('raise')) return 'DB_LAT_RAISE.gif';
      if(n.includes('Îî•Ïä§')||n.includes('dips')) return 'DIPS.gif';
      if(n.includes('Ïù∏Î≤ÑÌã∞Îìú')||n.includes('inverted')) return 'INVT_ROW.gif';
      if(n.includes('Îü∞ÏßÄ')||n.includes('lunge')) return 'LUNGE.gif';
      if(n.includes('ÌååÏù¥ÌÅ¨')||n.includes('pike')) return 'PIKE_PUSH_UP.gif';
      if(n.includes('ÌîåÎû≠ÌÅ¨')||n.includes('plank')) return 'PLANK.gif';
      if(n.includes('ÌíÄÏóÖ')||n.includes('pull')) return 'PULL_UP.gif';
      if(n.includes('Ìë∏Ïâ¨ÏóÖ')||n.includes('push')) return 'PUSH_UP.gif';
      return '';
    }

    /* =========================
      Storage Keys
    ========================= */
    const KEY = {
      LOGS: 'dk_next_logs',
      SETS: 'dk_next_sets',
      REPS: 'dk_next_reps',
      PROGRESS: 'dk_next_progress',
      SPLASH: 'dk_next_splash',
      SUMMARY: 'dk_next_summary',
      NOTIF: 'dk_next_notif'
    };

    /* =========================
      Load
    ========================= */
    function safeParse(raw, fallback){ try{ return raw ? JSON.parse(raw) : fallback; }catch(e){ return fallback; } }
    let logs = safeParse(localStorage.getItem(KEY.LOGS), []);
    let customSets = safeParse(localStorage.getItem(KEY.SETS), {});
    let customReps = safeParse(localStorage.getItem(KEY.REPS), {});
    let progressByDate = safeParse(localStorage.getItem(KEY.PROGRESS), {});
    let restNotifEnabled = (localStorage.getItem(KEY.NOTIF) ?? '1') === '1';

    /* =========================
      State
    ========================= */
    let currentDayIdx = new Date().getDay();
    let slideIndex = 0;

    let selectedDate = new Date().toISOString().split('T')[0];
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();

    // Stopwatch
    let workoutStartAt = Date.now();
    let stopwatchPaused = false;
    let pauseStartedAt = null;
    let pausedTotalMs = 0;

    // Rest timer
    let timerInt = null;
    let restRemaining = 0;
    let restTotal = 0;
    let restStartedAt = null;
    let restCurrentLogKey = null;

    // Rep modal
    let repModalState = null;

    // Charts
    let radarChart = null;
    let weeklyChart = null;

    /* WakeLock */
    let wakeLock = null;

    /* Audio */
    let audioCtx = null;

    /* =========================
      Utils
    ========================= */
    const $ = (q)=> document.querySelector(q);
    const $$ = (q)=> Array.from(document.querySelectorAll(q));
    const clamp = (n,min,max)=> Math.max(min, Math.min(max, n));
    const todayStr = ()=> new Date().toISOString().split('T')[0];
    const nowISO = ()=> new Date().toISOString();
    const exId = (dayIdx, exIdx)=> `${dayIdx}-${exIdx}`;
    const haptic = (ms=18)=> { try{ navigator.vibrate && navigator.vibrate(ms);}catch(e){} };

    function toast(msg){
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> el.classList.remove('show'), 1850);
    }

    function showDock(){
      const d = $('#dockWrap');
      d.classList.remove('hide');
      d.classList.add('show');
      clearTimeout(showDock._t);
      showDock._t = setTimeout(()=> {
        d.classList.remove('show');
        d.classList.add('hide');
      }, 1700);
    }
    ['scroll','touchstart','touchmove','click'].forEach(ev=> window.addEventListener(ev, showDock, {passive:true}));

    /* =========================
      Splash
    ========================= */
    function initSplash(){
      const shown = sessionStorage.getItem(KEY.SPLASH) === '1';
      if(shown){ $('#splash').style.display='none'; return; }
      setTimeout(()=> {
        const s = $('#splash');
        s.style.opacity='0';
        s.style.transform='scale(1.08)';
        setTimeout(()=> s.style.display='none', 880);
        sessionStorage.setItem(KEY.SPLASH,'1');
      }, 1800);
    }

    /* =========================
      Wake Lock
    ========================= */
    async function requestWakeLock(){
      try{
        if('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
        }
      }catch(e){}
    }
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === 'visible') requestWakeLock();
    });

    /* =========================
      Audio unlock
    ========================= */
    function unlockAudio(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
      }catch(e){}
    }

    /* =========================
      Stopwatch
    ========================= */
    function toggleStopwatchPause(){
      stopwatchPaused = !stopwatchPaused;
      const icon = $('#pauseIcon');
      if(stopwatchPaused){
        pauseStartedAt = Date.now();
        icon.className = "fa-solid fa-play";
        toast("Ï¥ù Ïö¥ÎèôÏãúÍ∞Ñ ÏùºÏãúÏ†ïÏßÄ");
      }else{
        if(pauseStartedAt) pausedTotalMs += (Date.now() - pauseStartedAt);
        pauseStartedAt = null;
        icon.className = "fa-solid fa-pause";
        toast("Ï¥ù Ïö¥ÎèôÏãúÍ∞Ñ Ïû¨ÏãúÏûë");
      }
      haptic(14);
      showDock();
    }

    function getWorkoutElapsedSec(){
      const now = Date.now();
      const paused = stopwatchPaused && pauseStartedAt ? (now - pauseStartedAt) : 0;
      const elapsedMs = (now - workoutStartAt) - pausedTotalMs - paused;
      return Math.max(0, Math.floor(elapsedMs / 1000));
    }

    /* =========================
      Tabs
    ========================= */
    function showTab(name, btn){
      $$('.tab').forEach(t => t.classList.add('hidden'));
      $(`#tab-${name}`).classList.remove('hidden');

      $$('.dockBtn').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');

      if(name === 'insights') renderCharts();
      if(name === 'history') renderCalendar();

      window.scrollTo({top:0, behavior:'smooth'});
      showDock();
    }

    /* =========================
      Progress per date
    ========================= */
    function ensureProgressArr(date, exerciseId, setTotal){
      if(!progressByDate[date]) progressByDate[date] = {};
      let arr = progressByDate[date][exerciseId];
      if(!Array.isArray(arr)){
        arr = new Array(setTotal).fill(false);
        progressByDate[date][exerciseId] = arr;
        localStorage.setItem(KEY.PROGRESS, JSON.stringify(progressByDate));
        return arr;
      }
      if(arr.length !== setTotal){
        const next = new Array(setTotal).fill(false);
        for(let i=0;i<Math.min(arr.length, setTotal);i++) next[i]=!!arr[i];
        progressByDate[date][exerciseId] = next;
        localStorage.setItem(KEY.PROGRESS, JSON.stringify(progressByDate));
        return next;
      }
      return arr;
    }

    function computeProgress(date, dayIdx){
      let total=0, done=0;
      workoutData[dayIdx].list.forEach((w, idx)=>{
        const id = exId(dayIdx, idx);
        const setTotal = customSets[id] || w.set;
        total += setTotal;
        const arr = ensureProgressArr(date, id, setTotal);
        done += arr.filter(Boolean).length;
      });
      const pct = Math.round((done/total)*100) || 0;
      return { total, done, pct };
    }

    function updateProgressUI(){
      const p = computeProgress(todayStr(), currentDayIdx);
      $('#progressPct').textContent = p.pct + '%';
      $('#progressText').textContent = `ÌòÑÏû¨ ${p.pct}% ÏôÑÎ£å!`;
      $('#progressBar').style.width = p.pct + '%';

      if(p.pct === 100) maybeShowSummary();
    }

    function maybeShowSummary(){
      const date = todayStr();
      const key = `${date}|${currentDayIdx}`;
      if(localStorage.getItem(KEY.SUMMARY) === key) return;

      const stats = getTodaySummaryStats();
      localStorage.setItem(KEY.SUMMARY, key);

      $('#sumSets').textContent = stats.sets;
      $('#sumEx').textContent = stats.exercises;
      $('#sumMsg').textContent = stats.msg;
      $('#summaryModal').classList.add('show');
      haptic(30);
    }

    function closeSummary(){
      $('#summaryModal').classList.remove('show');
    }

    function getTodaySummaryStats(){
      const date = todayStr();
      const data = workoutData[currentDayIdx];
      let setsDone=0, exDone=0;
      data.list.forEach((w, idx)=>{
        const id = exId(currentDayIdx, idx);
        const setTotal = customSets[id] || w.set;
        const arr = ensureProgressArr(date, id, setTotal);
        const done = arr.filter(Boolean).length;
        setsDone += done;
        if(done === setTotal) exDone++;
      });
      const msgPool = [
        "Ïò§ÎäòÎèÑ ÏôÑÎ≤ΩÌñàÎã§. ÎÇ¥ÏùºÏùÄ Îçî Í∞ïÌï¥ÏßÑÎã§.",
        "ÌèºÏù¥ Ïò¨ÎùºÏôîÎã§. Îã§Ïùå Ï£ºÎäî Í∏∞Î°ù Í∞±Ïã†.",
        "ÏßëÏ§ëÎ†•Ïù¥ ÎØ∏Ï≥§Îã§. Ïª®ÎîîÏÖò ÏµúÍ≥†.",
        "Í∑úÏπôÏùÄ Î∞∞Ïã†ÌïòÏßÄ ÏïäÎäîÎã§. Í≥ÑÏÜç Í∞ÑÎã§.",
        "Ïò§ÎäòÏùÄ ÏÑ±Í≥µ. Îã§ÏùåÏùÄ ÏßÑÏßú Î†àÎ≤®ÏóÖ."
      ];
      return { sets: setsDone, exercises: exDone, msg: msgPool[Math.floor(Math.random()*msgPool.length)] };
    }

    /* =========================
      Home UI (Day + chips)
    ========================= */
    function updateHomeHeader(){
      const data = workoutData[currentDayIdx];
      $('#homeDay').textContent = data.day;
      $('#homeType').textContent = data.type.toUpperCase();
      $('#homeTitle').textContent = data.title;

      const cueMap = {
        push: "Ìë∏Ïâ¨ Îç∞Ïù¥ ‚Äî ÌÖúÌè¨ Ï†úÏñ¥ & ÏΩîÏñ¥ Í≥†Ï†ï",
        pull: "ÌíÄ Îç∞Ïù¥ ‚Äî ÏàÑÎçî Ìå®ÌÇπ & Í¥ëÎ∞∞ ÏàòÏ∂ï",
        leg:  "ÌïòÏ≤¥ Îç∞Ïù¥ ‚Äî Î∞ú Ï†ÑÏ≤¥Î°ú Î∞ÄÍ∏∞",
        rest: "ÌöåÎ≥µ ‚Äî Ìò∏Ìù° & Î¶¨ÏÖã"
      };
      $('#homeCue').textContent = cueMap[data.type] || "ÌõàÎ†® Î™®Îìú";
    }

    function renderDayChips(){
      const wrap = $('#dayChips');
      wrap.innerHTML='';
      const days = ['Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†','Ïùº'];
      days.forEach((d, i)=>{
        const dm = (i===6)?0:(i+1);
        const b = document.createElement('button');
        b.className = `pill ${dm===currentDayIdx ? 'cyan' : ''}`;
        b.textContent = d;
        b.onclick = ()=> changeDay(dm);
        wrap.appendChild(b);
      });
    }

    function changeDay(dayIdx){
      currentDayIdx = dayIdx;
      slideIndex = 0;
      updateHomeHeader();
      renderDayChips();
      renderCarousel(true);
      updateProgressUI();
      showDock();
    }

    /* =========================
      Carousel (flicker-free)
    ========================= */
    function renderCarousel(full=true){
      const date = todayStr();
      const data = workoutData[currentDayIdx];
      const carousel = $('#carousel');

      if(full){
        carousel.innerHTML='';
        data.list.forEach((w, idx)=>{
          const id = exId(currentDayIdx, idx);
          const gif = getGifByExerciseName(w.name);
          w.gif = gif || '';

          const setTotal = customSets[id] || w.set;
          const repTotal = customReps[id] || w.rep;
          const doneArr = ensureProgressArr(date, id, setTotal);
          const doneCount = doneArr.filter(Boolean).length;

          const slide = document.createElement('div');
          slide.className='slide';
          slide.setAttribute('data-slide', idx);
          slide.setAttribute('data-exid', id);

          slide.innerHTML = `
            <div class="glass cardRound p-6 md:p-7">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <h3 class="text-3xl md:text-4xl font-black italic text-white tracking-tight truncate">${w.name}</h3>
                  <div class="mt-3 flex items-center gap-2 flex-wrap">
                    <span class="pill cyan">${w.target}</span>
                    <span class="pill">REST ${w.rest}s</span>
                    <span class="pill" data-role="progress">ÏßÑÌñâ ${doneCount}/${setTotal}</span>
                  </div>
                </div>
                <button class="pill" onclick="resetExercise('${id}')" title="Ïù¥ Ïö¥Îèô(Ïò§Îäò) Ï¥àÍ∏∞Ìôî">
                  <i class="fa-solid fa-rotate-left"></i>
                </button>
              </div>

              <div class="mt-5 grid md:grid-cols-2 gap-4">
                <div class="space-y-3">
                  <div class="glass rounded-2xl p-4 border-white/5">
                    <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45 mb-2">ÌïµÏã¨ ÌÅê</p>
                    <p class="text-base md:text-lg font-black text-white/80 leading-relaxed">${w.cue || w.tip || ''}</p>
                  </div>

                  <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/[0.02] p-4 rounded-2xl border border-white/5">
                      <p class="text-[10px] font-black tracking-[0.22em] uppercase text-indigo-300 mb-2">Ìò∏Ìù°</p>
                      <p class="text-[13px] font-bold text-white/70">${w.breath}</p>
                    </div>
                    <div class="bg-white/[0.02] p-4 rounded-2xl border border-white/5">
                      <p class="text-[10px] font-black tracking-[0.22em] uppercase text-indigo-300 mb-2">ÏùòÏãù</p>
                      <p class="text-[13px] font-bold text-white/70">${w.mind}</p>
                    </div>

                    <div class="bg-cyan-400/[0.04] p-4 rounded-2xl border border-cyan-400/10 col-span-2">
                      <p class="text-[10px] font-black tracking-[0.22em] uppercase text-cyan-300 mb-2">ÏóòÎ¶¨Ìä∏ Í∞ÄÏù¥Îìú</p>
                      <p class="text-[13px] font-bold text-white/75">${w.tip} ¬∑ <span class="text-white/45">${w.guide}</span></p>
                    </div>

                    ${gif ? `
                      <div class="col-span-2">
                        <div class="mt-2 rounded-2xl overflow-hidden border border-white/10 bg-white/[0.03] shadow-[0_22px_55px_rgba(0,0,0,.55)] cursor-pointer"
                             onclick="openGif('${gif}','${escapeHtml(w.name)}')">
                          <img src="${gif}" class="w-full aspect-square object-contain bg-black/20" loading="lazy"
                               onerror="this.parentElement.style.display='none';"/>
                        </div>
                        <div class="mt-2 text-[10px] font-black tracking-[0.22em] uppercase text-white/35">
                          GIF ÌÑ∞ÏπòÌïòÎ©¥ ÌÅ¨Í≤å Î≥¥Í∏∞
                        </div>
                      </div>` : ``}
                  </div>
                </div>

                <div class="space-y-3">
                  <div class="glass rounded-2xl p-4 border-white/5">
                    <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">ÏÑ∏Ìä∏/ÌöüÏàò ÏÑ§Ï†ï</p>
                    <p class="text-[11px] mt-2 font-bold text-white/45">* ÏÑ∏Ìä∏ Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï≤¥ÌÅ¨Ìï©ÎãàÎã§</p>
                  </div>

                  <div class="stepper">
                    <div>
                      <div class="stepperLabel">SET</div>
                      <div class="stepperValue" data-role="setTotal">${setTotal}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="stepperBtn" onclick="adjust('set','${id}',-1)"><i class="fa-solid fa-minus"></i></button>
                      <button class="stepperBtn" onclick="adjust('set','${id}',1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                  </div>

                  <div class="stepper">
                    <div>
                      <div class="stepperLabel">REP</div>
                      <div class="stepperValue" data-role="repTotal">${repTotal}</div>
                    </div>
                    <div class="flex items-center gap-2">
                      <button class="stepperBtn" onclick="adjust('rep','${id}',-1)"><i class="fa-solid fa-minus"></i></button>
                      <button class="stepperBtn" onclick="adjust('rep','${id}',1)"><i class="fa-solid fa-plus"></i></button>
                    </div>
                  </div>

                  <button class="pill w-full justify-center py-4" onclick="resetSetRepToDefault('${id}')">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Í∏∞Î≥∏Í∞í Î≥µÏõê
                  </button>

                  <div class="grid grid-cols-2 gap-3" data-role="setGrid">
                    ${renderSetButtonsHTML(id, w, date)}
                  </div>
                </div>
              </div>
            </div>
          `;
          carousel.appendChild(slide);
        });

        bindSetButtons();
        bindCarouselScroll();
        updateSlideHUD();
        requestAnimationFrame(()=> scrollToSlide(slideIndex,false));
      }else{
        // partial update current slide only
        const slide = carousel.querySelector(`.slide[data-slide="${slideIndex}"]`);
        if(!slide) return;
        const w = workoutData[currentDayIdx].list[slideIndex];
        const exid = slide.getAttribute('data-exid');
        const setTotal = customSets[exid] || w.set;
        const doneArr = ensureProgressArr(date, exid, setTotal);
        const doneCount = doneArr.filter(Boolean).length;

        const progressTag = slide.querySelector('[data-role="progress"]');
        if(progressTag) progressTag.textContent = `ÏßÑÌñâ ${doneCount}/${setTotal}`;

        const setGrid = slide.querySelector('[data-role="setGrid"]');
        if(setGrid) setGrid.innerHTML = renderSetButtonsHTML(exid, w, date);

        const setValue = slide.querySelector('[data-role="setTotal"]');
        if(setValue) setValue.textContent = setTotal;

        const repValue = slide.querySelector('[data-role="repTotal"]');
        if(repValue) repValue.textContent = (customReps[exid] || w.rep);

        bindSetButtons();
      }
    }

    function renderSetButtonsHTML(id, w, date){
      const setTotal = customSets[id] || w.set;
      const doneArr = ensureProgressArr(date, id, setTotal);
      const nextIndex = doneArr.indexOf(false);

      return Array.from({length:setTotal}).map((_, s)=>{
        const done = !!doneArr[s];
        const locked = (!done && nextIndex !== -1 && s !== nextIndex);
        return `
          <button class="setBtn ${done?'done':''} ${locked?'locked':''}"
                  ${locked?'disabled':''}
                  data-date="${date}" data-ex="${id}" data-set="${s}">
            ${done?`<i class="fa-solid fa-check"></i>`:''}
            ${s+1} ÏÑ∏Ìä∏
          </button>
        `;
      }).join('');
    }

    function bindSetButtons(){
      $$('.setBtn[data-ex]').forEach(btn=>{
        btn.onclick = ()=>{
          const date = btn.getAttribute('data-date');
          const ex = btn.getAttribute('data-ex');
          const setIndex = Number(btn.getAttribute('data-set'));
          toggleSetComplete(date, ex, setIndex);
        };
      });
    }

    function bindCarouselScroll(){
      const carousel = $('#carousel');
      carousel.onscroll = ()=>{
        const slides = Array.from(carousel.children);
        if(!slides.length) return;
        const slideWidth = slides[0].getBoundingClientRect().width + 18;
        const idx = Math.round(carousel.scrollLeft / slideWidth);
        if(idx !== slideIndex){
          slideIndex = clamp(idx, 0, slides.length-1);
          updateSlideHUD();
        }
        showDock();
      };
    }

    function updateSlideHUD(){
      const total = workoutData[currentDayIdx].list.length;
      const idx = clamp(slideIndex, 0, total-1);
      $('#slideIndicator').textContent = `${idx+1} / ${total}`;

      const carousel = $('#carousel');
      Array.from(carousel.children).forEach((el,i)=>{
        el.classList.toggle('focus', i===idx);
        el.classList.toggle('peek', i!==idx);
      });
    }

    function scrollToSlide(idx, smooth=true){
      const carousel = $('#carousel');
      const slides = Array.from(carousel.children);
      if(!slides.length) return;
      idx = clamp(idx, 0, slides.length-1);
      const slideWidth = slides[0].getBoundingClientRect().width + 18;
      carousel.scrollTo({ left: slideWidth * idx, behavior: smooth ? 'smooth' : 'auto' });
    }

    function nextSlide(){
      const total = workoutData[currentDayIdx].list.length;
      slideIndex = clamp(slideIndex + 1, 0, total-1);
      scrollToSlide(slideIndex,true);
      updateSlideHUD();
      haptic(10);
      showDock();
    }

    function prevSlide(){
      const total = workoutData[currentDayIdx].list.length;
      slideIndex = clamp(slideIndex - 1, 0, total-1);
      scrollToSlide(slideIndex,true);
      updateSlideHUD();
      haptic(10);
      showDock();
    }

    /* =========================
      Set complete ‚Üí Rep modal ‚Üí Rest
    ========================= */
    function toggleSetComplete(date, exerciseId, setIndex){
      unlockAudio();
      showDock();

      const [dayIdx, exIdx] = exerciseId.split('-').map(Number);
      const w = workoutData[dayIdx]?.list?.[exIdx];
      if(!w) return;

      const setTotal = customSets[exerciseId] || w.set;
      const doneArr = ensureProgressArr(date, exerciseId, setTotal);
      const nextIndex = doneArr.indexOf(false);

      if(!doneArr[setIndex] && nextIndex !== -1 && setIndex !== nextIndex){
        haptic(10);
        toast("Îã§Ïùå ÏÑ∏Ìä∏Î•º Î®ºÏ†Ä ÏôÑÎ£åÌïòÏÑ∏Ïöî");
        return;
      }

      const repTotal = customReps[exerciseId] || w.rep;
      doneArr[setIndex] = !doneArr[setIndex];
      progressByDate[date][exerciseId] = doneArr;
      localStorage.setItem(KEY.PROGRESS, JSON.stringify(progressByDate));

      const setNo = setIndex + 1;
      const logKey = `${date}|${exerciseId}|${setNo}`;

      if(doneArr[setIndex]){
        if(!logs.some(l=> l.logKey === logKey)){
          logs.push({
            id: Date.now(),
            logKey,
            date,
            ts: nowISO(),
            exerciseId,
            name: w.name,
            set: setNo,
            plannedSetTotal: setTotal,
            plannedRep: repTotal,
            repActual: null,
            restPlanned: w.rest,
            restUsed: w.rest,
            type: workoutData[currentDayIdx].type
          });
          localStorage.setItem(KEY.LOGS, JSON.stringify(logs));
        }

        // instant UI
        renderCarousel(false);
        updateProgressUI();

        // rep modal
        openRep({ logKey, name: w.name, setNo, baseRep: repTotal });

      }else{
        logs = logs.filter(l => l.logKey !== logKey);
        localStorage.setItem(KEY.LOGS, JSON.stringify(logs));
        renderCarousel(false);
        updateProgressUI();
        haptic(12);
        toast("ÏÑ∏Ìä∏ Ï∑®ÏÜåÎê®");
      }
    }

    /* =========================
      REP Modal
    ========================= */
    function openRep({logKey, name, setNo, baseRep}){
      repModalState = { logKey, baseRep };
      $('#repTitle').textContent = name;
      $('#repSub').textContent = `${setNo} SET`;
      $('#repBase').textContent = baseRep;

      const curLog = logs.find(l=> l.logKey === logKey);
      const prevLog = curLog ? findLastWeekSameExerciseLog(curLog) : null;
      const prevRep = prevLog?.repActual ?? prevLog?.plannedRep ?? baseRep;

      renderRepRecommendations(baseRep, prevRep);

      $('#repModal').classList.add('show');
      haptic(12);
      showDock();
    }

    function closeRep(saved=false){
      $('#repModal').classList.remove('show');
      if(!saved) toast("REP ÏûÖÎ†• Ï∑®ÏÜåÎê®");
      repModalState = null;
    }

    function repSkip(){
      if(!repModalState) return;
      saveRep(repModalState.logKey, repModalState.baseRep);
      closeRep(true);
    }
    function repSelect(v){
      if(!repModalState) return;
      saveRep(repModalState.logKey, v);
      closeRep(true);
    }

    function renderRepRecommendations(baseRep, prevRep){
      const ai = $('#repAI');
      const grid = $('#repGrid');
      ai.innerHTML=''; grid.innerHTML='';

      const aiList = [
        { label:"üî• ÎèôÏùº", value: prevRep, desc:"ÏßÄÎÇúÏ£ºÏôÄ ÎèôÏùº" },
        { label:"‚úÖ +1", value: prevRep + 1, desc:"Ï°∞Í∏à Îçî" },
        { label:"‚ö° -1", value: Math.max(0, prevRep - 1), desc:"Ï°∞Í∏à Îçú" },
      ];

      aiList.forEach(item=>{
        const b = document.createElement('button');
        b.className = "pill w-full justify-center py-4";
        b.style.height = "72px";
        b.innerHTML = `
          <div class="flex flex-col items-center">
            <div class="text-sm font-black">${item.label}</div>
            <div class="text-xl font-black text-white mt-1">${item.value}</div>
            <div class="text-[9px] font-black text-white/35 mt-1">${item.desc}</div>
          </div>
        `;
        b.onclick = ()=> repSelect(item.value);
        ai.appendChild(b);
      });

      const start = Math.max(0, prevRep - 5);
      const end = prevRep + 5;

      for(let r=start; r<=end; r++){
        const b = document.createElement('button');
        const isBase = (r === baseRep);
        b.className = isBase ? "pill cyan w-full justify-center py-3" : "pill w-full justify-center py-3";
        b.innerHTML = `<span class="text-lg font-black">${isBase ? "Í∏∞Î≥∏" : r}</span>`;
        b.onclick = ()=> isBase ? repSkip() : repSelect(r);
        grid.appendChild(b);
      }
    }

    function saveRep(logKey, value){
      const idx = logs.findIndex(l=> l.logKey === logKey);
      if(idx === -1) return;
      logs[idx].repActual = value;
      localStorage.setItem(KEY.LOGS, JSON.stringify(logs));

      // start rest timer after rep saved
      const restSec = logs[idx].restPlanned || 0;
      if(restSec > 0) startTimer(restSec, logKey);

      // toast last-week diff
      const prevLog = findLastWeekSameExerciseLog(logs[idx]);
      if(prevLog){
        const prev = prevLog.repActual ?? prevLog.plannedRep ?? null;
        if(prev !== null){
          const diff = value - prev;
          if(diff > 0) toast(`ÏßÄÎÇúÏ£º ÎåÄÎπÑ +${diff} REP üî•`);
          else if(diff < 0) toast(`ÏßÄÎÇúÏ£º ÎåÄÎπÑ ${diff} REP`);
          else toast(`ÏßÄÎÇúÏ£ºÏôÄ ÎèôÏùº REP ‚úÖ`);
        }
      }else{
        toast("REP Í∏∞Î°ù ÏôÑÎ£å ‚úÖ");
      }

      haptic(18);
      renderCarousel(false);
      updateProgressUI();
      renderCalendar();
    }

    function shiftDate(dateStr, deltaDays){
      const d = new Date(dateStr);
      d.setDate(d.getDate() + deltaDays);
      return d.toISOString().split('T')[0];
    }

    function findLastWeekSameExerciseLog(cur){
      const prevDate = shiftDate(cur.date, -7);
      const prefix = `${prevDate}|${cur.exerciseId}|${cur.set}`;
      return logs.find(l=> l.logKey.startsWith(prefix)) || null;
    }

    /* =========================
      Adjust set/rep
    ========================= */
    function adjust(type, key, delta){
      showDock();
      const [d, idx] = key.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      if(!w) return;

      if(type === 'set'){
        const cur = customSets[key] || w.set;
        const next = clamp(cur + delta, 1, 12);
        customSets[key] = next;
        localStorage.setItem(KEY.SETS, JSON.stringify(customSets));
        ensureProgressArr(todayStr(), key, next);
      }else{
        const cur = customReps[key] || w.rep;
        customReps[key] = clamp(cur + delta, 1, 120);
        localStorage.setItem(KEY.REPS, JSON.stringify(customReps));
      }

      renderCarousel(false);
      updateProgressUI();
      toast("ÏÑ§Ï†ï Ï†ÄÏû•Îê®");
      haptic(10);
    }

    function resetSetRepToDefault(exerciseId){
      showDock();
      const [d, idx] = exerciseId.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      if(!w) return;

      if(customSets[exerciseId] !== undefined) delete customSets[exerciseId];
      if(customReps[exerciseId] !== undefined) delete customReps[exerciseId];
      localStorage.setItem(KEY.SETS, JSON.stringify(customSets));
      localStorage.setItem(KEY.REPS, JSON.stringify(customReps));

      ensureProgressArr(todayStr(), exerciseId, w.set);
      renderCarousel(false);
      updateProgressUI();
      toast("Í∏∞Î≥∏Í∞íÏúºÎ°ú Î≥µÏõê");
      haptic(18);
    }

    /* =========================
      Reset / Quick Start
    ========================= */
    function resetExercise(exerciseId){
      showDock();
      if(!confirm("Ïù¥ Ïö¥ÎèôÏùò Ïò§Îäò Í∏∞Î°ùÏùÑ Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;
      const date = todayStr();

      logs = logs.filter(l => !(l.date===date && l.exerciseId===exerciseId));
      localStorage.setItem(KEY.LOGS, JSON.stringify(logs));

      const [d, idx] = exerciseId.split('-').map(Number);
      const w = workoutData[d]?.list?.[idx];
      const setTotal = customSets[exerciseId] || w.set;

      if(progressByDate[date] && progressByDate[date][exerciseId]){
        progressByDate[date][exerciseId] = new Array(setTotal).fill(false);
        localStorage.setItem(KEY.PROGRESS, JSON.stringify(progressByDate));
      }

      renderCarousel(false);
      updateProgressUI();
      toast("Ïö¥Îèô Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
      haptic(22);
    }

    function resetToday(){
      showDock();
      if(!confirm("Ïò§Îäò ÏßÑÌñâ/Í∏∞Î°ùÏùÑ Î™®Îëê Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;
      const date = todayStr();

      logs = logs.filter(l => l.date !== date);
      localStorage.setItem(KEY.LOGS, JSON.stringify(logs));

      if(progressByDate[date]) delete progressByDate[date];
      localStorage.setItem(KEY.PROGRESS, JSON.stringify(progressByDate));

      localStorage.removeItem(KEY.SUMMARY);

      renderCarousel(true);
      updateProgressUI();
      renderCalendar();
      toast("Ïò§Îäò Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
      haptic(25);
    }

    function openQuickStart(){
      // Ìä∏Î†åÎîî UX: ÌòÑÏû¨ Ïö¥ÎèôÏùò Îã§Ïùå ÎØ∏ÏôÑÎ£å ÏÑ∏Ìä∏Î°ú ÏûêÎèô Ïä§ÌÅ¨Î°§ + ÏïàÎÇ¥
      const date = todayStr();
      const data = workoutData[currentDayIdx];
      let bestSlide = 0;

      for(let i=0;i<data.list.length;i++){
        const id = exId(currentDayIdx, i);
        const setTotal = customSets[id] || data.list[i].set;
        const arr = ensureProgressArr(date, id, setTotal);
        if(arr.includes(false)){ bestSlide = i; break; }
      }
      slideIndex = bestSlide;
      scrollToSlide(slideIndex,true);
      updateSlideHUD();
      toast("Îã§Ïùå ÎØ∏ÏôÑÎ£å Ïö¥ÎèôÏúºÎ°ú Ïù¥Îèô ‚úÖ");
      haptic(14);
      showDock();
    }

    /* =========================
      Timer
    ========================= */
    function showHUD(on){
      const hud = $('#timerHud');
      hud.classList.toggle('show', !!on);
    }

    function updateHUD(){
      $('#hudTime').textContent = String(restRemaining).padStart(2,'0');
      const pct = restTotal ? Math.round(((restTotal - restRemaining)/restTotal)*100) : 0;
      $('#hudBar').style.width = pct + '%';
    }

    function startTimer(sec, logKey=null){
      restRemaining = sec;
      restTotal = sec;
      restStartedAt = Date.now();
      restCurrentLogKey = logKey;

      $('#timerSec').textContent = String(restRemaining).padStart(2,'0');
      $('#timerModal').classList.add('show');

      showHUD(true);
      updateHUD();

      clearInterval(timerInt);
      timerInt = setInterval(()=>{
        restRemaining--;
        $('#timerSec').textContent = String(restRemaining).padStart(2,'0');
        updateHUD();
        if(restRemaining <= 0) closeTimer(true);
      }, 1000);
    }

    function minimizeTimer(){
      $('#timerModal').classList.remove('show');
      showHUD(true);
      toast("ÌÉÄÏù¥Î®∏ ÏµúÏÜåÌôî");
      haptic(10);
      showDock();
    }

    function openTimer(){
      $('#timerModal').classList.add('show');
      haptic(10);
      showDock();
    }

    function adjustRest(delta){
      if(!timerInt) return;
      restRemaining = clamp(restRemaining + delta, 5, 600);
      restTotal = Math.max(restTotal, restRemaining);
      $('#timerSec').textContent = String(restRemaining).padStart(2,'0');
      updateHUD();
      haptic(10);
      showDock();
    }

    function closeTimer(finished=false){
      clearInterval(timerInt);
      timerInt = null;

      $('#timerModal').classList.remove('show');
      showHUD(false);

      // restUsed Í∏∞Î°ù
      if(restStartedAt && restCurrentLogKey){
        const used = clamp(Math.round((Date.now() - restStartedAt)/1000), 0, restTotal);
        const idx = logs.findIndex(l=> l.logKey === restCurrentLogKey);
        if(idx !== -1){
          logs[idx].restUsed = used;
          localStorage.setItem(KEY.LOGS, JSON.stringify(logs));
        }
      }
      restStartedAt = null;
      restCurrentLogKey = null;

      if(finished){
        haptic(30);
        if(restNotifEnabled) restDoneNotify();
        toast("Ìú¥Ïãù ÎÅù! Îã§Ïùå ÏÑ∏Ìä∏ ‚úÖ");
      }
    }

    function restDoneNotify(){
      try{ navigator.vibrate && navigator.vibrate([120,80,200,80,220]); }catch(e){}
      try{
        unlockAudio();
        const now = audioCtx.currentTime;
        const pattern = [
          { t:0.00, dur:0.16, freq:1318 },
          { t:0.20, dur:0.16, freq:1567 },
          { t:0.40, dur:0.18, freq:2093 },
          { t:0.66, dur:0.18, freq:1567 },
        ];
        pattern.forEach(p=>{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.connect(g);
          g.connect(audioCtx.destination);
          o.type = 'sine';
          o.frequency.setValueAtTime(p.freq, now + p.t);

          g.gain.setValueAtTime(0.0001, now+p.t);
          g.gain.exponentialRampToValueAtTime(0.25, now+p.t+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now+p.t+p.dur);

          o.start(now+p.t);
          o.stop(now+p.t+p.dur);
        });
      }catch(e){}
    }

    function toggleNotif(){
      restNotifEnabled = !restNotifEnabled;
      localStorage.setItem(KEY.NOTIF, restNotifEnabled ? '1' : '0');
      $('#notifToggle').textContent = restNotifEnabled ? 'ON' : 'OFF';
      $('#notifToggle').classList.toggle('cyan', restNotifEnabled);
      toast(restNotifEnabled ? "ÏïåÎ¶º ON" : "ÏïåÎ¶º OFF");
      haptic(14);
      showDock();
    }

    /* =========================
      Charts (Insights)
    ========================= */
    function renderCharts(force=false){
      // counts
      const counts = { push:0, pull:0, leg:0, rest:0 };
      logs.forEach(l=> { if(counts[l.type] !== undefined) counts[l.type]++; });

      $('#statSets').textContent = logs.length;
      $('#statDays').textContent = new Set(logs.map(l=> l.date)).size;

      // radar
      const rctx = $('#radar').getContext('2d');
      if(radarChart) radarChart.destroy();
      radarChart = new Chart(rctx, {
        type:'radar',
        data:{
          labels:['PUSH','PULL','LEGS','REST'],
          datasets:[{
            data:[counts.push, counts.pull, counts.leg, counts.rest],
            backgroundColor:'rgba(34,211,238,0.10)',
            borderColor:'#22d3ee',
            borderWidth:2,
            pointRadius:0
          }]
        },
        options:{
          scales:{
            r:{
              grid:{ color:'rgba(255,255,255,0.06)' },
              angleLines:{ color:'rgba(255,255,255,0.06)' },
              pointLabels:{ color:'rgba(255,255,255,0.55)', font:{ weight:'800' } },
              ticks:{ display:false }
            }
          },
          plugins:{ legend:{ display:false } }
        }
      });

      // weekly sets
      const days = [];
      for(let i=6;i>=0;i--){
        days.push(shiftDate(todayStr(), -i));
      }
      const values = days.map(d=> logs.filter(l=> l.date === d).length);

      const wctx = $('#weekly').getContext('2d');
      if(weeklyChart) weeklyChart.destroy();
      weeklyChart = new Chart(wctx, {
        type:'bar',
        data:{
          labels: days.map(d=> d.slice(5)),
          datasets:[{
            data: values,
            borderWidth: 0,
            backgroundColor: 'rgba(99,102,241,0.35)',
          }]
        },
        options:{
          plugins:{ legend:{ display:false } },
          scales:{
            x:{ grid:{ display:false }, ticks:{ color:'rgba(255,255,255,0.55)', font:{weight:'800'} } },
            y:{ grid:{ color:'rgba(255,255,255,0.06)' }, ticks:{ color:'rgba(255,255,255,0.45)', font:{weight:'800'} } }
          }
        }
      });
    }

    /* =========================
      Calendar / History
    ========================= */
    function renderCalendar(){
      $('#monthLabel').textContent = `${currentYear}.${String(currentMonth+1).padStart(2,'0')}`;
      const first = new Date(currentYear, currentMonth, 1).getDay();
      const last = new Date(currentYear, currentMonth+1, 0).getDate();
      const body = $('#calendar');
      body.innerHTML = '';

      for(let i=0;i<first;i++) body.innerHTML += `<div></div>`;

      for(let d=1; d<=last; d++){
        const dStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const hasLog = logs.some(l=> l.date === dStr);

        const el = document.createElement('div');
        el.className = `calendar-day cursor-pointer ${dStr===todayStr()?'today':''} ${hasLog?'has-log':''}`;
        if(dStr===selectedDate) el.classList.add('selected');
        el.textContent = d;
        el.onclick = ()=> { selectedDate = dStr; renderCalendar(); showDock(); };
        body.appendChild(el);
      }

      renderHistoryDetail();
    }

    function estimateWorkoutMinutes(date){
      const day = logs.filter(l=> l.date===date);
      if(!day.length) return 0;
      const avgRest = day.reduce((a,c)=> a + (c.restUsed ?? c.restPlanned ?? 0), 0) / day.length;
      const perSet = 45 + avgRest; // simple estimate
      return Math.max(1, Math.round((perSet * day.length) / 60));
    }

    function renderHistoryDetail(){
      const area = $('#historyDetail');

      const dayLogs = logs
        .filter(l => l.date === selectedDate)
        .sort((a,b)=> (a.exerciseId > b.exerciseId ? 1 : -1) || (a.set - b.set));

      area.innerHTML = `<p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45 px-2">${selectedDate} Î¶¨Ìè¨Ìä∏</p>`;

      if(dayLogs.length === 0){
        area.innerHTML += `<div class="glass cardRound p-12 text-center text-white/45 italic text-xs">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>`;
        return;
      }

      const totalSets = dayLogs.length;
      const avgRest = Math.round(dayLogs.reduce((a,c)=> a + (c.restUsed ?? c.restPlanned ?? 0), 0) / totalSets);
      const approxMin = estimateWorkoutMinutes(selectedDate);
      const exCount = new Set(dayLogs.map(l=> l.exerciseId)).size;

      area.innerHTML += `
        <div class="glass cardRound p-6">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/45">ÏöîÏïΩ</p>
              <h4 class="text-2xl font-black italic text-white mt-2">${approxMin}Î∂Ñ</h4>
              <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/35 mt-2">
                Ï¥ù ${totalSets}ÏÑ∏Ìä∏ ¬∑ ÌèâÍ∑† Ìú¥Ïãù ${avgRest}s
              </p>
            </div>
            <div class="text-right">
              <p class="text-[10px] font-black tracking-[0.22em] uppercase text-white/35">ÏôÑÎ£å Ïö¥Îèô</p>
              <p class="text-3xl font-black text-cyan-300 mt-2">${exCount}</p>
            </div>
          </div>
        </div>
      `;

      const groups = dayLogs.reduce((acc, o)=>{
        if(!acc[o.exerciseId]) acc[o.exerciseId]=[];
        acc[o.exerciseId].push(o);
        return acc;
      }, {});

      Object.entries(groups).forEach(([exerciseId, data])=>{
        const name = data[0].name;
        const plannedRep = data[0].plannedRep ?? "-";
        const totalSets = data.length;

        const prevDate = shiftDate(selectedDate, -7);
        const prevGroup = logs.filter(l=> l.date===prevDate && l.exerciseId===exerciseId);
        const prevAvgRep = prevGroup.length
          ? Math.round(prevGroup.reduce((a,c)=> a + (c.repActual ?? c.plannedRep ?? 0), 0) / prevGroup.length)
          : null;
        const curAvgRep = Math.round(data.reduce((a,c)=> a + (c.repActual ?? c.plannedRep ?? 0), 0) / data.length);
        const repDelta = prevAvgRep !== null ? (curAvgRep - prevAvgRep) : null;

        area.innerHTML += `
          <div class="glass cardRound p-6 border-l-4 border-cyan-400">
            <div>
              <h4 class="font-black text-white italic">${name}</h4>
              <div class="flex items-center gap-2 mt-3 flex-wrap">
                <span class="pill cyan">${totalSets} ÏÑ∏Ìä∏</span>
                <span class="pill">Î™©Ìëú REP: ${plannedRep}</span>
                ${repDelta !== null
                  ? `<span class="pill ${repDelta>0?'cyan':''}">ÏßÄÎÇúÏ£º ÎåÄÎπÑ ${repDelta>0?'+':''}${repDelta} REP</span>`
                  : `<span class="pill">ÏßÄÎÇúÏ£º Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</span>`
                }
              </div>
            </div>

            <div class="mt-5 space-y-2">
              ${data.map(row=>{
                const repVal = row.repActual ?? row.plannedRep ?? "-";
                const restVal = (row.restUsed ?? row.restPlanned ?? "-");
                return `
                  <div class="flex items-center justify-between glass rounded-2xl px-4 py-3">
                    <div class="flex items-center gap-2">
                      <span class="pill">${row.set} SET</span>
                      <span class="pill cyan">${repVal} REP</span>
                    </div>
                    <span class="pill">REST ${restVal}s</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
    }

    function changeMonth(dir){
      showDock();
      currentMonth += dir;
      if(currentMonth < 0){ currentMonth=11; currentYear--; }
      if(currentMonth > 11){ currentMonth=0; currentYear++; }
      renderCalendar();
    }

    function resetSelectedDate(){
      showDock();
      if(!confirm("ÏÑ†ÌÉùÌïú ÎÇ†ÏßúÏùò Í∏∞Î°ùÏùÑ Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;
      const date = selectedDate;

      logs = logs.filter(l=> l.date !== date);
      localStorage.setItem(KEY.LOGS, JSON.stringify(logs));

      if(progressByDate[date]) delete progressByDate[date];
      localStorage.setItem(KEY.PROGRESS, JSON.stringify(progressByDate));

      toast("ÏÑ†ÌÉù ÎÇ†Ïßú Ï¥àÍ∏∞Ìôî");
      renderCalendar();
      haptic(25);
    }

    /* =========================
      Backup / Export / Reset All
    ========================= */
    function backupJSON(){
      showDock();
      const payload = {
        version: 'DK_FIT_NEXT_v1',
        exportedAt: nowISO(),
        logs,
        customSets,
        customReps,
        progressByDate
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `dk_fit_next_backup_${todayStr()}.json`;
      a.click();
      toast("Î∞±ÏóÖ Îã§Ïö¥Î°úÎìú");
      haptic(18);
    }

    function exportCSV(){
      showDock();
      if(!logs.length){
        toast("ÎÇ¥Î≥¥ÎÇº Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§");
        return;
      }
      const header = ["date","time","type","exercise","set","plannedRep","actualRep","restPlanned","restUsed"];
      const rows = logs.map(l=> [
        l.date,
        l.ts,
        l.type,
        `"${(l.name||'').replace(/"/g,'""')}"`,
        l.set,
        l.plannedRep ?? "",
        l.repActual ?? "",
        l.restPlanned ?? "",
        l.restUsed ?? ""
      ].join(","));
      const csv = [header.join(","), ...rows].join("\n");
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `dk_fit_next_logs_${todayStr()}.csv`;
      a.click();
      toast("CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏôÑÎ£å");
      haptic(18);
    }

    function resetAll(){
      showDock();
      if(!confirm("‚ö†Ô∏è Î™®Îì† Îç∞Ïù¥ÌÑ∞(Í∏∞Î°ù/ÏÑ§Ï†ï/ÏßÑÌñâ)Î•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?")) return;

      Object.values(KEY).forEach(k=> localStorage.removeItem(k));
      logs=[]; customSets={}; customReps={}; progressByDate={};

      renderCarousel(true);
      updateProgressUI();
      renderCalendar();
      renderCharts(true);

      toast("Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å");
      haptic(30);
    }

    /* =========================
      GIF view (simple)
    ========================= */
    function openGif(src, title){
      // extremely simple: open in new tab (fast)
      window.open(src, "_blank");
      toast("GIF Ïó¥Í∏∞");
      haptic(10);
    }

    function escapeHtml(str){
      return (str||'').replace(/[&<>"']/g, (m)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    /* =========================
      Zoom prevent
    ========================= */
    (function preventZoom(){
      document.addEventListener('gesturestart', (e)=> e.preventDefault(), {passive:false});
      document.addEventListener('gesturechange', (e)=> e.preventDefault(), {passive:false});
      document.addEventListener('gestureend', (e)=> e.preventDefault(), {passive:false});
      let lastTouchEnd=0;
      document.addEventListener('touchend', (e)=>{
        const now = Date.now();
        if(now - lastTouchEnd <= 260) e.preventDefault();
        lastTouchEnd = now;
      }, {passive:false});
      document.addEventListener('dblclick', (e)=> e.preventDefault(), {passive:false});
    })();

    /* =========================
      Init
    ========================= */
    window.onload = async ()=>{
      initSplash();
      await requestWakeLock();

      // notif button
      $('#notifToggle').textContent = restNotifEnabled ? 'ON' : 'OFF';
      $('#notifToggle').classList.toggle('cyan', restNotifEnabled);

      renderDayChips();
      changeDay(new Date().getDay());
      renderCalendar();

      // stopwatch tick
      setInterval(()=>{
        const total = getWorkoutElapsedSec();
        const m = String(Math.floor(total/60)).padStart(2,'0');
        const s = String(total%60).padStart(2,'0');
        $('#stopwatch').textContent = `${m}:${s}`;
      }, 500);

      // auto hide dock after load
      setTimeout(()=> $('#dockWrap').classList.add('hide'), 1200);
    };

    document.addEventListener('keydown', (e)=>{
      if(e.key === "Escape"){
        closeTimer(false);
        closeRep(false);
        closeSummary();
      }
    });
  </script>
</body>
</html>

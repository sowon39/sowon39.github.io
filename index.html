<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>DK Fit OS v12.1 (WakeLock + Rep AI Buttons + History Pro)</title>

  <!-- âœ… PWA / iOS Standalone -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="DK Fit">
  <meta name="theme-color" content="#050507">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800;900&display=swap');

    :root{
      --primary:#22d3ee;
      --accent:#6366f1;
      --bg:#050507;
      --card:rgba(255,255,255,0.04);
      --dockH: 110px;
      --headerH: 76px;
    }

    html,body{ height:100%; }

/* --- Tablet WebApp UX Polish (app-like touch) --- */
*{
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
  -webkit-tap-highlight-color:transparent;
}
img, video{
  -webkit-user-drag:none;
  user-drag:none;
}
button,a{
  touch-action: manipulation;
}


    html{
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    body{
      font-family:'Pretendard',sans-serif;
      background-color:var(--bg);
      color:#e4e4e7;
      margin:0;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom: env(safe-area-inset-bottom);
      overscroll-behavior: none;

      background-image:
        radial-gradient(1200px 700px at 15% -10%, rgba(34,211,238,0.18), transparent 55%),
        radial-gradient(1200px 700px at 100% 10%, rgba(99,102,241,0.22), transparent 55%),
        radial-gradient(900px 600px at 15% 110%, rgba(12,74,110,0.25), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      background-attachment: fixed;
    }

    ::-webkit-scrollbar{ display:none; }
    .scroll-hide{ -ms-overflow-style:none; scrollbar-width:none; }

    .glass{
      background:var(--card);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      border:1px solid rgba(255,255,255,0.10);
    }

    .layoutWrap{
      width:100%;
      max-width: 1100px;
      margin: 0 auto;
    }

    /* =========================================================
       âœ… NEW Splash (Apple Liquid Glass Style)
    ========================================================= */
    #splash-screen{
      position:fixed; inset:0; z-index:10000;
      display:flex; align-items:center; justify-content:center;
      background:#050507;
      overflow:hidden;
      transition:all 1s cubic-bezier(0.65,0,0.35,1);
    }

    #splash-screen::before{
      content:"";
      position:absolute; inset:-30%;
      background:
        radial-gradient(1000px 600px at 30% 10%, rgba(34,211,238,0.35), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(99,102,241,0.35), transparent 62%),
        radial-gradient(900px 600px at 20% 90%, rgba(34,211,238,0.25), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,1));
      animation: liquidFloat 5.5s ease-in-out infinite alternate;
      filter:saturate(1.2);
      opacity:1;
    }

    #splash-screen::after{
      content:"";
      position:absolute; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.20'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.13;
      pointer-events:none;
    }

    @keyframes liquidFloat{
      0%{ transform: translateY(0) scale(1); }
      100%{ transform: translateY(-22px) scale(1.05); }
    }

    .splash-inner{
      width:min(540px, calc(100vw - 56px));
      padding: 56px 26px 46px;
      border-radius: 38px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(30px);
      -webkit-backdrop-filter: blur(30px);
      box-shadow: 0 50px 160px rgba(0,0,0,0.6);
      position:relative;
      z-index:2;
      text-align:center;
      transform: translateY(14px) scale(.98);
      opacity:0;
      animation: splashIn 1.1s cubic-bezier(.2,.9,.2,1) forwards;
      overflow: hidden;
      isolation:isolate;
    }

    .splash-inner .shine{
      position:absolute;
      inset:-30%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.35), transparent 40%);
      filter: blur(10px);
      opacity:.35;
      animation: shineMove 3.2s ease-in-out infinite alternate;
      pointer-events:none;
      z-index:0;
    }
    @keyframes shineMove{
      0%{ transform: translate(-10px, 10px); }
      100%{ transform: translate(18px, -18px); }
    }

    @keyframes splashIn{
      to{ transform: translateY(0) scale(1); opacity:1; }
    }

    .splash-logo{
      font-size: 4.5rem;
      font-weight: 950;
      letter-spacing: -0.08em;
      background: linear-gradient(180deg, rgba(255,255,255,1), rgba(34,211,238,0.95));
      -webkit-background-clip:text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 0 24px rgba(34,211,238,0.20));
      position:relative;
      z-index:2;
      display:inline-block;
      padding: 6px 14px;
    }

    .splash-loader{
      margin-top: 26px;
      position:relative;
      z-index:2;
    }

    .splash-line{
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      position:relative;
    }

    .splash-line span{
      position:absolute; inset:0;
      width:45%;
      background: linear-gradient(90deg, rgba(34,211,238,0), rgba(34,211,238,1), rgba(99,102,241,1), rgba(34,211,238,0));
      animation: splashScan 1.15s ease-in-out infinite;
      filter: drop-shadow(0 0 14px rgba(34,211,238,0.35));
    }

    @keyframes splashScan{
      0%{ transform: translateX(-70%); }
      100%{ transform: translateX(170%); }
    }

    /* Header */
    header{
      position:fixed; top:0; left:0; right:0; z-index:50;
      padding: 14px 18px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      background: rgba(10,10,12,0.62);
      height: var(--headerH);
      box-sizing:border-box;
      padding-top: calc(6px + env(safe-area-inset-top));
    }

    .tab-content{ display:none; animation:fadeInContent 0.45s ease-out; }
    .tab-content.active{ display:block; }
    @keyframes fadeInContent{ from{opacity:0; transform:translateY(6px) scale(0.985);} to{opacity:1; transform:translateY(0) scale(1);} }

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      font-size:11px; font-weight:900;
      color:rgba(255,255,255,0.82);
      white-space:nowrap;
      user-select:none;
    }
    .pill.cyan{ border-color:rgba(34,211,238,0.25); background:rgba(34,211,238,0.10); color:rgba(34,211,238,0.95); }

    main{
      padding-top: calc(var(--headerH) + 18px + env(safe-area-inset-top));
      padding-bottom: calc(var(--dockH) + env(safe-area-inset-bottom) + 28px);
    }

    /* Carousel */
    .carousel{
      display:flex;
      gap:18px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      padding: 0 22px 18px;
      margin: 0 -22px;
      touch-action: pan-x pan-y;
    }
    .carousel::before,.carousel::after{ content:''; flex:0 0 22px; }

    .carousel > .slide{
      scroll-snap-align:center;
      flex: 0 0 calc(100% - 120px);
      min-height: auto;
      transition: opacity .22s ease, transform .22s ease, filter .22s ease;
    }
    .slide.peek{ opacity:.60; transform:scale(.965); filter:blur(.6px); }
    .slide.focus{ opacity:1; transform:scale(1); filter:none; }

    @media (min-width: 860px){
      .carousel > .slide{ flex:0 0 calc(100% - 160px); }
      .slide.peek{ opacity:.62; transform:scale(.97); filter:blur(.45px); }
    }

    .slideCard{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      border-radius:32px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
      overflow:hidden;
    }

    .rightPanel{ border-radius:26px; padding:18px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); }

    .stepper{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:14px 14px; border-radius:22px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
    }
    .stepperLabel{ font-size:10px; font-weight:900; letter-spacing:.18em; text-transform:uppercase; color:rgba(255,255,255,0.50); }
    .stepperValue{ font-size:22px; font-weight:950; color:white; }
    .stepperBtn{
      width:48px; height:48px; border-radius:18px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.12);
      color:rgba(255,255,255,0.9);
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      transition: transform .08s ease;
    }
    .stepperBtn:active{ transform:scale(.98); }

    .bigBtn{
      width:100%; height:60px; border-radius:20px;
      font-weight:900; font-size:15px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .12s ease;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
    }
    .bigBtn:active{ transform:scale(0.985); }

    .setBtn{
      width:100%; height:66px; border-radius:20px;
      font-weight:950; font-size:18px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .12s ease;
      -webkit-tap-highlight-color:transparent;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      user-select:none;
      overflow:hidden;
    }
    .setBtn:active{ transform:scale(0.985); }
    .setBtn.done{ background:linear-gradient(135deg,var(--primary),var(--accent)); color:#000; box-shadow:0 18px 34px rgba(34,211,238,0.24); border:none; }

    .setBtn.locked{
      opacity: .35;
      filter: saturate(.6);
      pointer-events: none;
    }

    /* Floating Dock */
    .navDockWrap{ position:fixed; left:0; right:0; bottom:0; padding: 18px; z-index:60; }
    .nav-dock{
      background:rgba(10,10,12,0.78);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter:blur(22px);
      border-radius:34px;
      padding:10px;
      display:flex;
      justify-content:space-around;
      align-items:center;
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.7);
    }
    .nav-item{ position:relative; padding:12px 0; flex:1; display:flex; flex-direction:column; align-items:center; gap:5px; transition:all .25s; color:#777; -webkit-tap-highlight-color:transparent; user-select:none; }
    .nav-item.active{ color:var(--primary); transform:translateY(-3px); }
    .nav-item i{ font-size:1.25rem; }
    .nav-active-dot{ position:absolute; bottom:1px; width:4px; height:4px; background:var(--primary); border-radius:50%; box-shadow:0 0 12px var(--primary); opacity:0; transition:all .25s; }
    .nav-item.active .nav-active-dot{ opacity:1; transform:scale(1.6); }

    /* Dock Auto Hide */
    .navDockWrap{
      transition: transform .45s cubic-bezier(0.22, 1, 0.36, 1), opacity .35s ease;
      will-change: transform, opacity;
    }
    .navDockWrap.dock-hide{
      transform: translateY(120%);
      opacity: 0;
      pointer-events: none;
    }
    .navDockWrap.dock-show{
      transform: translateY(0%);
      opacity: 1;
      pointer-events: auto;
    }

    /* Day chips */
    .day-chip{
      width:44px; height:44px;
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      color:rgba(255,255,255,0.55);
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      flex:0 0 auto;
      user-select:none;
      overflow:hidden;
      position:relative;
      isolation:isolate;
    }
    .day-chip.active{
      background:var(--primary);
      color:#000;
      border-color:rgba(34,211,238,0.25);
      box-shadow:0 10px 24px rgba(34,211,238,0.25);
    }

    /* Timer Modal */
    #timer-modal{ transition:all .65s ease; }
    #timer-sec{ letter-spacing:-0.08em; }

    /* Timer HUD */
    #timer-hud{
      position:fixed;
      top: calc(var(--headerH) + 10px + env(safe-area-inset-top));
      right: 14px;
      z-index: 210;
      display:none;
    }
    #timer-hud.show{ display:block; }
    .hudCard{
      border-radius: 22px;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      background:rgba(10,10,12,0.72);
      border:1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(22px);
      box-shadow:0 20px 40px rgba(0,0,0,0.55);
      min-width: 170px;
      user-select:none;
    }
    .hudTime{
      font-weight: 950;
      font-size: 22px;
      letter-spacing: -0.06em;
      color:white;
      line-height:1;
    }
    .hudLabel{ font-size: 9px; font-weight: 900; letter-spacing: .18em; text-transform: uppercase; color: rgba(255,255,255,0.45); }
    .hudBarWrap{
      width:100%;
      height:6px;
      border-radius:999px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      margin-top:8px;
    }
    .hudBar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius:999px;
      box-shadow: 0 0 14px rgba(34,211,238,0.35);
    }
    .hudBtn{
      width:34px;height:34px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.85);
    }
    .hudBtn:active{ transform:scale(.98); }

    /* Summary modal */
    #summary-modal{ position:fixed; inset:0; z-index:220; display:none; align-items:center; justify-content:center; }
    #summary-modal.show{ display:flex; }

    /* Toast */
    #toast{ position:fixed; left:50%; bottom:130px; transform:translateX(-50%); z-index:250; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(-6px); }

    /* History layout */
    .historyLayout{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }
    @media(min-width: 900px){
      .historyLayout{
        grid-template-columns: 360px 1fr;
      }
    }

    /* Calendar */
    .calendar-day{ aspect-ratio:1; border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:13px; position:relative; transition:all .18s; font-weight:800; color:rgba(255,255,255,0.75); background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); user-select:none;}
    .has-log::after{ content:''; width:6px; height:6px; background:rgba(34,211,238,0.90); border-radius:50%; position:absolute; bottom:8px; box-shadow:0 0 12px rgba(34,211,238,0.35); }
    .calendar-day.selected{ background:rgba(34,211,238,0.14); border:1px solid rgba(34,211,238,0.35); box-shadow:0 0 0 2px rgba(34,211,238,0.18), 0 0 30px rgba(34,211,238,0.12); color:#eaffff; font-weight:900; transform:translateY(-2px); }
    .calendar-day.today{ border:1px solid rgba(255,255,255,0.12); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); color:rgba(255,255,255,0.95); font-weight:900; }

    /* History table */
    .log-table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
    .log-table th{ font-size:10px; text-transform:uppercase; letter-spacing:.18em; color:rgba(255,255,255,0.35); font-weight:900; text-align:left; padding:0 10px 6px; }
    .log-row{ background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); border-radius:16px; overflow:hidden; }
    .log-row td{ padding:12px 10px; font-weight:800; font-size:12px; color:rgba(255,255,255,0.78); }

    /* Bottom Sheet (ìš´ë™ ìƒì„¸) */
    #detail-sheet{
      position: fixed;
      inset: 0;
      z-index: 9999;
      display: none;
      pointer-events: none;
    }
    #detail-sheet.show{
      display: block;
      pointer-events: auto;
    }
    .sheet-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 1;
      pointer-events: auto;
    }
    .sheet{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      border-radius: 26px 26px 0 0;
      background: rgba(10,10,12,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 -24px 80px rgba(0,0,0,0.75);
      transform: translateY(100%);
      transition: transform .45s cubic-bezier(0.22,1,0.36,1);
      z-index: 2;
      pointer-events: auto;
      padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
      isolation: isolate;
      max-height: 88vh;
      overflow: hidden;
    }
    #detail-sheet.show .sheet{
      transform: translateY(0%);
    }
    .sheetHeader{
      padding: 16px 18px 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .sheetTitle{
      font-weight: 950;
      font-size: 18px;
      letter-spacing: -0.03em;
      color: white;
    }
    .sheetSub{
      margin-top: 4px;
      font-size: 10px;
      letter-spacing: .22em;
      font-weight: 900;
      text-transform: uppercase;
      color: rgba(255,255,255,0.40);
    }
    .sheetClose{
      width:44px; height:44px;
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.85);
      z-index: 3;
      pointer-events: auto;
      -webkit-tap-highlight-color:transparent;
    }
    .sheetClose:active{ transform: scale(.98); }

    .sheetBody{
      padding: 16px 18px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: calc(88vh - 90px);
    }

    .sheetTabs{
      display:flex;
      gap:10px;
      padding: 0 0 14px;
      overflow-x:auto;
    }
    .sheetTab{
      flex: 0 0 auto;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.75);
      -webkit-tap-highlight-color:transparent;
    }
    .sheetTab.active{
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color:#000;
      border: none;
      box-shadow: 0 14px 32px rgba(34,211,238,0.18);
    }

    .sheetBox{
      border-radius: 22px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 14px 14px;
      margin-bottom: 12px;
    }
    .sheetLabel{
      font-size: 10px;
      letter-spacing: .20em;
      font-weight: 950;
      text-transform: uppercase;
      color: rgba(255,255,255,0.42);
    }
    .sheetText{
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.55;
      font-weight: 800;
      color: rgba(255,255,255,0.88);
      letter-spacing: -0.01em;
    }
    .sheetHint{
      margin-top: 10px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(255,255,255,0.45);
      line-height: 1.4;
    }

    /* âœ… ìƒì„¸ GIF: ë„ˆë¬´ í¬ì§€ ì•Šê²Œ ì ì • ì‚¬ì´ì¦ˆ + í™”ë©´ì—ì„œ íƒ­/ë‚´ìš© ê°™ì´ ë³´ì´ë„ë¡ */
    .sheetGif{
      width: 100%;
      max-height: 220px;
      border-radius: 18px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      display:block;
      object-fit: contain;
      background: rgba(255,255,255,0.03);
    }

    /* ì¹´ë“œ GIF */
    .cardGifSquareWrap{
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 22px 55px rgba(0,0,0,0.55);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    .cardGifSquareWrap:active{ transform: scale(0.99); }
    .cardGifSquare{
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: rgba(0,0,0,0.15);
    }

    /* âœ… REP ì…ë ¥ ëª¨ë‹¬ */
    #rep-modal{
      position:fixed; inset:0;
      z-index: 260;
      display:none;
      align-items:center;
      justify-content:center;
    }
    #rep-modal.show{ display:flex; }
    .repCard{
      width:min(520px, calc(100vw - 44px));
      border-radius: 28px;
      padding: 18px;
      background: rgba(10,10,12,0.92);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 40px 140px rgba(0,0,0,0.70);
    }
    .repBtn{
      height: 54px;
      border-radius: 18px;
      font-weight: 950;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .08s ease;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .repBtn:active{ transform: scale(.985); }
    .repBtn.primary{
      background: linear-gradient(135deg, var(--primary), var(--accent));
      border: none;
      color:#000;
      box-shadow: 0 18px 34px rgba(34,211,238,0.22);
    }

    /* Mobile Layout Optimization */
    @media (max-width: 520px){
      .layoutWrap{ padding-left: 0; padding-right: 0; }
      main .layoutWrap.px-4{ padding-left: 14px !important; padding-right: 14px !important; }

      header{
        padding: 12px 14px 10px !important;
        height: 76px;
        padding-top: calc(4px + env(safe-area-inset-top)) !important;
      }
      :root{ --headerH: 76px; --dockH: 92px; }

      #view-day{
        font-size: 1.38rem !important;
        letter-spacing: -0.02em !important;
      }
      #view-title{
        font-size: 0.95rem !important;
        margin-top: 2px !important;
        opacity: 0.9;
      }
      #view-subcue{
        margin-top: 6px !important;
        font-size: 9px !important;
      }

      #progress-percent{
        font-size: 16px !important;
        font-weight: 950 !important;
        margin-bottom: 4px !important;
        letter-spacing: -0.02em;
      }
      #progress-text{
        font-size: 10px !important;
      }
      header .w-28{
        width: 140px !important;
        height: 8px !important;
      }

      .slideCard{ border-radius: 24px; }
      .slideCard .p-6{ padding: 14px !important; }
      .slideCard h3{ font-size: 1.55rem !important; }

      .slideCard .md\:grid-cols-2{ grid-template-columns: 1fr !important; }

      .rightPanel{
        padding: 14px !important;
        border-radius: 22px !important;
      }

      .stepperBtn{
        width: 44px !important;
        height: 44px !important;
        border-radius: 16px !important;
      }
      .stepperValue{ font-size: 20px !important; }

      .rightPanel .grid.grid-cols-2{
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
      }
      .setBtn{
        height: 54px !important;
        font-size: 15px !important;
        border-radius: 18px !important;
      }

      .carousel > .slide{
        flex: 0 0 calc(100% - 70px) !important;
      }

      .navDockWrap{ padding: 14px !important; }
      .nav-dock{ border-radius: 30px !important; padding: 9px !important; }
      .nav-item{ padding: 10px 0 !important; }
      .nav-item i{ font-size: 1.15rem !important; }
    }
  
/* ===== Swipe-friendly touch-action tuning ===== */
.carousel, .slides, .slideTrack, .slideContainer{ touch-action: pan-x; }
button, a, [role="button"], .btn, .chip, .tab, .iconbtn{ touch-action: manipulation; }
.main, .content, .scrollArea, .list{ -webkit-overflow-scrolling: touch; }
.is-pressed{
  transform: scale(0.97);
  filter: brightness(0.95);
  transition: transform 0.08s ease, filter 0.08s ease;
}

</style>
<style>
/* ===== Mobile / Tablet app-like touch tuning ===== */
html, body{
  overscroll-behavior: none;
  -webkit-text-size-adjust: 100%;
  text-rendering: optimizeLegibility;
}
/* Prevent text selection & callouts where it feels "app-y" */
body, button, .btn, .chip, .tab, .dock, .card, .slide, .control, .iconbtn, input[type="button"], input[type="submit"]{
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}
/* Make taps respond immediately and stop browser gestures hijacking */
button, a, [role="button"], .btn, .chip, .tab, .iconbtn{
  touch-action: manipulation;
}
/* If you have horizontal swipe areas (carousel), only allow horizontal pan there */
.carousel, .slides, .slideTrack{
  touch-action: pan-y;
}
.slide, .carousel{
  -webkit-user-drag: none;
}
/* Remove 300ms delays and accidental drag cursors */
button, [role="button"], .btn, .iconbtn{
  cursor: pointer;
}
/* Press feedback (subtle) */
button:active, a:active, [role="button"]:active, .btn:active, .iconbtn:active, .chip:active{
  transform: scale(0.98);
  filter: brightness(0.97);
}
/* Disable double-tap zoom on iOS for controls */
*{ -webkit-tap-highlight-color: transparent; }
</style>
</head>

<body>

  <!-- âœ… Splash -->
  <div id="splash-screen">
    <div class="splash-inner">
      <div class="shine"></div>
      <div class="splash-logo">DK Fit</div>
      <div class="splash-loader">
        <div class="splash-line"><span></span></div>
      </div>
    </div>
  </div>

  <!-- âœ… REP ì…ë ¥ ëª¨ë‹¬ -->
  <div id="rep-modal">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-xl" onclick="closeRepModal(false)"></div>
    <div class="relative repCard">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-[10px] font-black tracking-[0.2em] uppercase text-white/45">REP ì…ë ¥</p>
          <h3 id="rep-title" class="text-2xl font-black italic text-white mt-1">ìš´ë™</h3>
          <p id="rep-sub" class="text-[10px] font-black tracking-[0.2em] uppercase text-white/35 mt-2">1 SET</p>
        </div>
        <button class="pill" onclick="closeRepModal(false)"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-5 glass rounded-2xl p-5">
        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/40">ê¸°ë³¸ REP</p>
        <div class="flex items-end justify-between mt-2">
          <div id="rep-base" class="text-5xl font-black text-white tracking-tighter">20</div>
          <div class="text-[10px] font-black tracking-[0.18em] uppercase text-white/35 text-right">
            ì¶”ì²œ ì…ë ¥<br>ë²„íŠ¼ í´ë¦­ë§Œ
          </div>
        </div>
      </div>

      <!-- âœ… AI ì¶”ì²œ + ìˆ«ì ê·¸ë¦¬ë“œ -->
      <div class="mt-4 glass rounded-2xl p-4">
        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">AI ì¶”ì²œ</p>
        <div id="rep-ai-reco" class="mt-3 grid grid-cols-3 gap-2"></div>

        <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/35 mt-5">ì¶”ì²œ ìˆ«ì</p>
        <div id="rep-number-grid" class="mt-3 grid grid-cols-5 gap-2"></div>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-3">
        <button class="repBtn" onclick="closeRepModal(false)">
          <i class="fa-solid fa-ban"></i> ì·¨ì†Œ
        </button>
        <button class="repBtn primary" onclick="repSkip()">
          <i class="fa-solid fa-check"></i> ê¸°ë³¸ REP ê¸°ë¡
        </button>
      </div>

      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/30 mt-4">
        * ì…ë ¥ ì™„ë£Œ í›„ ì§€ë‚œì£¼ ë™ì¼ ìš”ì¼/ìš´ë™ê³¼ ë¹„êµ ê²°ê³¼ë¥¼ í† ìŠ¤íŠ¸ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
      </p>
    </div>
  </div>

  <!-- âœ… Bottom Sheet (ìš´ë™ ìƒì„¸) -->
  <div id="detail-sheet">
    <div class="sheet-backdrop" onclick="closeDetailSheet()"></div>
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="sheetHeader">
        <div>
          <div class="sheetTitle" id="sheet-title">ìš´ë™ ìƒì„¸</div>
          <div class="sheetSub" id="sheet-sub">DETAIL</div>
        </div>
        <button class="sheetClose" onclick="closeDetailSheet()" aria-label="ë‹«ê¸°">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="sheetBody">
        <div class="sheetTabs" id="sheet-tabs"></div>
        <div id="sheet-body"></div>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="layoutWrap flex justify-between items-end">
      <div>
        <div class="flex items-center gap-2">
          <h2 id="stopwatch" class="text-3xl font-black font-mono tracking-tighter text-white">00:00</h2>

          <!-- âœ… ì¼ì‹œì •ì§€ ë²„íŠ¼ -->
          <button onclick="toggleStopwatchPause()" class="pill cyan" style="padding:6px 10px;" title="ì´ ìš´ë™ì‹œê°„ ì¼ì‹œì •ì§€">
            <i id="pause-icon" class="fa-solid fa-pause"></i>
          </button>
        </div>

        <div class="flex items-center gap-2 mt-1">
          <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
          <p class="text-[9px] font-black text-gray-300 tracking-widest uppercase">ELITE MODE Â· DK</p>
        </div>
      </div>

      <div class="flex flex-col items-end">
        <span id="progress-percent" class="text-[10px] font-black mb-0.5 text-cyan-300">0%</span>
        <span id="progress-text" class="text-[9px] font-black text-white/40 tracking-widest uppercase">í˜„ì¬ 0% ì™„ë£Œ!</span>
        <div class="w-28 h-1.5 bg-white/5 rounded-full overflow-hidden mt-2">
          <div id="progress-bar" class="h-full bg-cyan-400 shadow-[0_0_12px_#22d3ee] transition-all duration-700" style="width:0%"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- Timer HUD -->
  <div id="timer-hud">
    <div class="hudCard">
      <div class="min-w-[70px]">
        <div class="hudLabel">REST</div>
        <div id="hud-time" class="hudTime">60</div>
        <div class="hudBarWrap"><div id="hud-bar" class="hudBar"></div></div>
      </div>
      <div class="flex items-center gap-2">
        <button class="hudBtn" onclick="openTimerFromHUD()" title="íƒ€ì´ë¨¸ ë³´ê¸°"><i class="fa-solid fa-expand"></i></button>
        <button class="hudBtn" onclick="closeTimer(false)" title="ìŠ¤í‚µ"><i class="fa-solid fa-forward"></i></button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main>
    <div class="layoutWrap px-4">

      <!-- Session -->
      <section id="tab-session" class="tab-content active">
        <div class="mb-4 mt-2 px-2 flex justify-between items-start">
          <div>
            <h1 id="view-day" class="text-5xl font-black italic text-white uppercase tracking-tighter">DAY</h1>
            <p id="view-title" class="text-gray-300 font-black mt-1 text-sm tracking-wide"></p>
            <p id="view-subcue" class="text-[10px] font-black text-white/50 mt-2 tracking-[0.18em] uppercase"></p>
          </div>
          <button onclick="resetToday()" class="pill" title="ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”">
            <i class="fa-solid fa-rotate-left"></i> ì˜¤ëŠ˜ ì´ˆê¸°í™”
          </button>
        </div>

        <div id="day-nav-wrap" class="mb-3">
          <div id="day-nav" class="flex justify-center gap-2 overflow-x-auto pb-2 scroll-hide"></div>
        </div>

        <div class="flex items-center justify-between px-2 mb-4">
          <div class="flex items-center gap-2">
            <span class="pill cyan" id="slide-indicator">1 / 1</span>
            <span class="pill" id="slide-name">ìš´ë™</span>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="carouselPrev()" class="pill"><i class="fa-solid fa-chevron-left"></i></button>
            <button onclick="carouselNext()" class="pill"><i class="fa-solid fa-chevron-right"></i></button>
          </div>
        </div>

        <div id="session-carousel" class="carousel scroll-hide"></div>
      </section>

      <!-- Stats -->
      <section id="tab-stats" class="tab-content">
        <div class="mb-8 px-2">
          <h2 class="text-3xl font-black italic uppercase tracking-tight">ë¶„ì„</h2>
          <p class="text-[11px] font-black text-white/45 mt-2 tracking-[0.18em] uppercase">
            í›ˆë ¨ì˜ í¸í–¥/ë°¸ëŸ°ìŠ¤ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
          </p>
        </div>

        <div class="glass rounded-[28px] p-8 mb-6">
          <canvas id="radarChart" class="max-h-[320px]"></canvas>
        </div>

        <div class="grid grid-cols-2 gap-5 mb-6">
          <div class="glass rounded-[28px] p-6">
            <p class="text-[9px] text-gray-400 font-black uppercase mb-2 tracking-widest">ì´ ê¸°ë¡(ì„¸íŠ¸)</p>
            <p id="stat-total-sets" class="text-4xl font-black text-white">0</p>
          </div>
          <div class="glass rounded-[28px] p-6">
            <p class="text-[9px] text-gray-400 font-black uppercase mb-2 tracking-widest">í™œë™ ì¼ìˆ˜</p>
            <p id="stat-week-count" class="text-4xl font-black text-indigo-300">0</p>
          </div>
        </div>

        <div class="glass rounded-[28px] p-6 mb-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/45">íœ´ì‹ íƒ€ì´ë¨¸ ì•Œë¦¼</p>
              <p class="text-sm font-black text-white/70 mt-2">íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ ì†Œë¦¬/ì§„ë™</p>
            </div>
            <button id="notif-toggle" class="pill cyan" onclick="toggleNotif()">ON</button>
          </div>
          <p class="text-[11px] font-black text-white/35 mt-3">
            * iOSëŠ” ë¬´ìŒëª¨ë“œì—ì„œ ì†Œë¦¬ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. iPadëŠ” ì§„ë™ì´ ì§€ì›ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div class="grid gap-3">
          <button onclick="backupJSON()" class="bigBtn"><i class="fa-solid fa-download"></i> ë°±ì—…(JSON)</button>
          <button onclick="resetAll()" class="bigBtn" style="border-color: rgba(255,255,255,0.18);"><i class="fa-solid fa-triangle-exclamation"></i> ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </section>

      <!-- History -->
      <section id="tab-history" class="tab-content">
        <div class="mb-6 px-2 flex justify-between items-end">
          <h2 class="text-3xl font-black italic uppercase">ê¸°ë¡</h2>
          <div class="flex items-center gap-4 glass rounded-2xl px-5 py-2.5">
            <button onclick="changeMonth(-1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-left text-xs"></i></button>
            <span id="calendar-month" class="text-xs font-black w-20 text-center tracking-widest">2026.01</span>
            <button onclick="changeMonth(1)" class="p-1 hover:text-cyan-300 transition-colors"><i class="fa-solid fa-chevron-right text-xs"></i></button>
          </div>
        </div>

        <div class="historyLayout">
          <div>
            <div class="glass rounded-[28px] p-6 mb-4 shadow-2xl">
              <div class="grid grid-cols-7 text-center text-[9px] font-black text-gray-500 mb-5 uppercase tracking-[0.2em]">
                <div class="text-red-600">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-600">í† </div>
              </div>
              <div id="calendar-body" class="grid grid-cols-7 gap-3"></div>
            </div>

            <button onclick="resetSelectedDate()" class="pill w-full justify-center">
              <i class="fa-solid fa-eraser"></i> ì„ íƒ ë‚ ì§œ ì´ˆê¸°í™”
            </button>
          </div>

          <div>
            <div id="history-detail" class="space-y-6"></div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Bottom Dock -->
  <div class="navDockWrap">
    <div class="layoutWrap">
      <nav class="nav-dock" style="margin-bottom: calc(env(safe-area-inset-bottom) + 6px);">
        <button onclick="showTab('session', this)" class="nav-item active">
          <i class="fa-solid fa-bolt-lightning"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">í›ˆë ¨</span>
          <div class="nav-active-dot"></div>
        </button>
        <button onclick="showTab('stats', this)" class="nav-item">
          <i class="fa-solid fa-chart-simple"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">ë¶„ì„</span>
          <div class="nav-active-dot"></div>
        </button>
        <button onclick="showTab('history', this)" class="nav-item">
          <i class="fa-solid fa-calendar-days"></i>
          <span class="text-[8px] font-black uppercase tracking-tighter">ê¸°ë¡</span>
          <div class="nav-active-dot"></div>
        </button>
      </nav>
    </div>
  </div>

  <!-- REST TIMER MODAL -->
  <div id="timer-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden opacity-0">
    <div class="absolute inset-0 bg-black/95 backdrop-blur-2xl"></div>
    <div class="relative text-center">
      <div class="miniHint mb-3 text-[10px] font-black tracking-[0.2em] uppercase text-white/35">íœ´ì‹</div>
      <div id="timer-sec" class="text-[14rem] font-black text-white italic tracking-tighter leading-none mb-6 drop-shadow-[0_0_30px_rgba(255,255,255,0.2)]">00</div>

      <div class="flex items-center justify-center gap-3">
        <button onclick="adjustRest(-10)" class="glass px-7 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">-10</button>
        <button onclick="minimizeTimer()" class="glass px-10 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">ìµœì†Œí™”</button>
        <button onclick="adjustRest(10)" class="glass px-7 py-4 rounded-full font-black text-white text-xs uppercase tracking-[0.25em] hover:bg-white/10 transition-all">+10</button>
      </div>

      <div class="mt-4 flex items-center justify-center gap-3">
        <button onclick="closeTimer(false)" class="pill"><i class="fa-solid fa-forward"></i> ìŠ¤í‚µ</button>
      </div>

      <p class="text-[10px] font-black tracking-[0.18em] uppercase text-white/40 mt-6">ìµœì†Œ ë°©í•´ Â· ìµœëŒ€ ì§‘ì¤‘</p>
    </div>
  </div>

  <!-- SUMMARY MODAL -->
  <div id="summary-modal">
    <div class="absolute inset-0 bg-black/85 backdrop-blur-xl" onclick="closeSummary()"></div>
    <div class="relative glass rounded-[28px] p-7 w-[min(520px,calc(100vw-44px))]">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-[10px] font-black tracking-[0.2em] uppercase text-white/45">ì˜¤ëŠ˜ ìš”ì•½</p>
          <h3 class="text-2xl font-black italic text-white mt-1">ì™„ë£Œ ğŸ‰</h3>
        </div>
        <button class="pill" onclick="closeSummary()"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-5 grid grid-cols-2 gap-3">
        <div class="glass rounded-2xl p-4">
          <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì™„ë£Œ ì„¸íŠ¸</p>
          <p id="sum-sets" class="text-3xl font-black text-white mt-2">0</p>
        </div>
        <div class="glass rounded-2xl p-4">
          <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì™„ë£Œ ìš´ë™</p>
          <p id="sum-ex" class="text-3xl font-black text-white mt-2">0</p>
        </div>
        <div class="glass rounded-2xl p-4 col-span-2">
          <p class="text-[9px] font-black tracking-[0.18em] uppercase text-white/40">ì˜¤ëŠ˜ í•œë§ˆë””</p>
          <p id="sum-msg" class="text-base font-black text-white/80 mt-2">ì¢‹ì€ í›ˆë ¨ì´ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button class="bigBtn" onclick="closeSummary()" style="background:linear-gradient(135deg,var(--primary),var(--accent)); color:#000; border:none;">
          <i class="fa-solid fa-check"></i> í™•ì¸
        </button>
        <button class="bigBtn" onclick="showTab('history', document.querySelectorAll('.nav-item')[2]); closeSummary();">ê¸°ë¡ ë³´ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="pill cyan"></div>

  <script>
    
    /* =========================================================
      DK Fit OS v12.1
      âœ… Wake Lock (screen on)
      âœ… Stopwatch Pause
      âœ… Set tap -> instant done UI + REP modal appears
      âœ… REP modal: previous week based number buttons (no mental math)
      âœ… Rest sound: notification-like melody (no flash)
      âœ… Progress percent + "í˜„ì¬ XX% ì™„ë£Œ!"
      âœ… History: daily summary with duration / avg rest / detail
      âœ… GIF blink fix: avoid full re-render when stepper changes
    ========================================================= */

    /* ---------- GIF ë§¤ì¹­ ---------- */
    
    /* ---------- DATA ---------- */

    /* ---------- APP DATA (JSON) ---------- */
    let appData = null;
    let workoutData = null;
    let gifMap = null;
    let copy = null;
    let uiConfig = null;

    async function loadAppData(){
      const res = await fetch("./appData.json", {cache:"no-store"});
      if(!res.ok) throw new Error("Failed to load appData.json: " + res.status);
      appData = await res.json();
      workoutData = appData?.data?.workout || {};
      gifMap = appData?.data?.gifMap || [];
      copy = appData?.ui?.copy || {};
      uiConfig = appData?.ui?.config || {};
    }

    function t(path, fallback=""){
      try{
        const val = path.split('.').reduce((o,k)=>o?.[k], copy);
        return (val===undefined||val===null) ? fallback : val;
      }catch(e){ return fallback; }
    }

    function getGifByExerciseName(name){
      const n = (name || '').toLowerCase();
      for(const r of (gifMap || [])){
        if(r.kw_ko && n.includes(String(r.kw_ko).toLowerCase())) return r.gif;
        if(r.kw_en && n.includes(String(r.kw_en).toLowerCase())) return r.gif;
      }
      return '';
    }


    /* ---------- STORAGE KEYS ---------- */
    const KEY_LOGS = 'dk_os_v121_logs';
    const KEY_SETS = 'dk_os_v121_sets';
    const KEY_REPS = 'dk_os_v121_reps';
    const KEY_PROGRESS_BY_DATE = 'dk_os_v121_progress_by_date';
    const KEY_SPLASH = 'dk_os_v121_splash_shown';
    const KEY_SUMMARY_SHOWN = 'dk_os_v121_summary_shown';
    const KEY_NOTIF = 'dk_os_v121_rest_notif';


    const KEY_LOCAL_UPDATED_AT = 'dk_os_v121_local_updatedAt';
    let silentPushTimer=null;
    let isApplyingCloud=false;
    function scheduleSilentPush(){
      try{
        if(!currentUser || !fbDb || !cloudReady) return;
        if(isApplyingCloud) return;

        // ì¦‰ì‹œ 1íšŒ ì—…ë¡œë“œ(ì¶”ê°€ ê¸°ë¡ í›„ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ìƒˆë¡œê³ ì¹¨ ì‹œ ë°”ë¡œ ë³´ì´ê²Œ)
        (async ()=>{ try{ await pushToCloud(); }catch(e){} })();

        if(silentPushTimer) clearTimeout(silentPushTimer);
        silentPushTimer = setTimeout(async ()=>{
          try{ await pushToCloud(); }catch(e){}
        }, 900);
      }catch(e){}
    }

    function touchLocalUpdate(){
      try{
        // ê¸°ì¡´ ë¡œì»¬ ë³€ê²½ íƒ€ì„ìŠ¤íƒ¬í”„ + Firebase(ìˆë‹¤ë©´) ì—…ë¡œë“œ ìŠ¤ì¼€ì¤„
        localStorage.setItem(KEY_LOCAL_UPDATED_AT, new Date().toISOString());
        scheduleSilentPush();

        // âœ… GitHub Gist ìë™ ë°±ì—… íŠ¸ë¦¬ê±° (ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ê³µí†µ)
        if(typeof window.gistScheduleBackup === "function"){
          window.gistScheduleBackup("ë¡œì»¬ ë³€ê²½");
        }else{
          // ì´ë²¤íŠ¸ ë°©ì‹ë„ ì§€ì›
          try{ window.dispatchEvent(new Event("app:dataChanged")); }catch(e){}
        }
      }catch(e){}
    }

    function getLocalUpdatedAt(){
      try{ return localStorage.getItem(KEY_LOCAL_UPDATED_AT) || null; }catch(e){ return null; }
    }


    /* ---------- LOAD ---------- */
    function safeParse(raw, fallback){ try { return raw ? JSON.parse(raw) : fallback; } catch(e){ return fallback; } }
    let logs = safeParse(localStorage.getItem(KEY_LOGS), []);
    let customSets = safeParse(localStorage.getItem(KEY_SETS), {});
    let customReps = safeParse(localStorage.getItem(KEY_REPS), {});
    let progressByDate = safeParse(localStorage.getItem(KEY_PROGRESS_BY_DATE), {});

    /* ---------- STATE ---------- */
    let timerInt = null;
    let currentDayIdx = new Date().getDay();
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let selectedDate = new Date().toISOString().split('T')[0];
    let restRemaining = 0;
    let restTotal = 0;
    let currentSlideIndex = 0;
    let restNotifEnabled = (localStorage.getItem(KEY_NOTIF) ?? '1') === '1';

    /* íœ´ì‹ ê¸°ë¡ */
    let restStartedAt = null;
    let restCurrentLogKey = null;

    /* Audio unlock */
    let audioCtx = null;
    function unlockAudio(){
      try{
        if(!audioCtx){
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(audioCtx.state === 'suspended'){
          audioCtx.resume();
        }
      }catch(e){}
    }

    /* Stopwatch (pause support) */
    let workoutStartAt = Date.now();
    let stopwatchPaused = false;
    let pauseStartedAt = null;
    let pausedTotalMs = 0;

    /* Wake Lock */
    let wakeLock = null;
    async function requestWakeLock(){
      try{
        if('wakeLock' in navigator){
          wakeLock = await navigator.wakeLock.request('screen');
        }
      }catch(e){}
    }
    function releaseWakeLock(){
      try{ wakeLock && wakeLock.release(); }catch(e){}
      wakeLock = null;
    }
    document.addEventListener("visibilitychange", () => {
      if(document.visibilityState === 'visible') requestWakeLock();
    });

    /* REP modal state */
    let repModalState = null;

    /* ---------- UTILS ---------- */
    function haptic(ms=18){ if(navigator.vibrate) navigator.vibrate(ms); }
    function nowISO(){ return new Date().toISOString(); }
    function todayStr(){ return new Date().toISOString().split('T')[0]; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function exId(dayIdx, exIdx){ return `${dayIdx}-${exIdx}`; }

    /* ---------- SPLASH ---------- */
    function initIntro(){
      const shown = sessionStorage.getItem(KEY_SPLASH) === '1';
      const splash = document.getElementById('splash-screen');
      if(shown){ splash.style.display = 'none'; return; }

      setTimeout(() => {
        splash.style.opacity = '0';
        splash.style.transform = 'scale(1.08)';
        setTimeout(()=> splash.style.display='none', 900);
        sessionStorage.setItem(KEY_SPLASH, '1');
      }, 2200);
    }

    /* ---------- TOAST ---------- */
    let toastTimer=null;
    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.classList.remove('show'), 1800);
    }

    /* ---------- SUMMARY MODAL ---------- */
    function openSummary(stats){
      document.getElementById('sum-sets').textContent = stats.sets;
      document.getElementById('sum-ex').textContent = stats.exercises;
      document.getElementById('sum-msg').textContent = stats.msg;
      document.getElementById('summary-modal').classList.add('show');
    }
    function closeSummary(){
      document.getElementById('summary-modal').classList.remove('show');
    }

    /* ---------- TABS ---------- */
    function showTab(name, btn){
      // Double-tap on the same tab => refresh/restore like typical fitness apps
      try{
        const now = Date.now();
        const last = window.__TAB_LAST__ || {name:null, t:0};
        if(last.name === name && (now - last.t) < 650){
          if(typeof window.gistRestoreNow === "function"){
            window.gistRestoreNow(true);
          }else if(typeof window.restoreFromGist === "function"){
            window.restoreFromGist(true);
          }
          window.__TAB_LAST__ = {name, t:0};
          return;
        }
        window.__TAB_LAST__ = {name, t:now};
      }catch(e){}

      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${name}`).classList.add('active');
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const dayWrap = document.getElementById('day-nav-wrap');
      if(dayWrap) dayWrap.style.display = (name === 'session') ? 'block' : 'none';

      if(name === 'stats') renderStats();
      if(name === 'history') renderHistory();
    })();
</script>
<script>
/* ===== Safer fast-tap (no global preventDefault) ===== */
(function(){
  const FAST_SELECTOR = 'button,[role="button"],.btn,.iconbtn,.chip,.tab,a';
  document.querySelectorAll(FAST_SELECTOR).forEach(el=>{
    el.setAttribute('data-fasttap','1');
  });

  const addPressed = (el)=> el && el.classList.add('is-pressed');
  const rmPressed  = (el)=> el && el.classList.remove('is-pressed');

  document.addEventListener('pointerdown', function(e){
    const el = e.target.closest && e.target.closest('[data-fasttap="1"]');
    if(!el) return;
    addPressed(el);
  }, {capture:true, passive:true});

  document.addEventListener('pointerup', function(e){
    const el = e.target.closest && e.target.closest('[data-fasttap="1"]');
    if(!el) return;
    rmPressed(el);
  }, {capture:true, passive:true});

  document.addEventListener('pointercancel', function(e){
    const el = e.target.closest && e.target.closest('[data-fasttap="1"]');
    if(!el) return;
    rmPressed(el);
  }, {capture:true, passive:true});

  })();
</script>
<script>
/* ===== Robust swipe-to-slide (bind after carousel renders) ===== */
(function(){
  function bindScroller(scroller){
    if(!scroller || scroller.__swipeBound) return;
    scroller.__swipeBound = true;

    const isHScrollable = ()=> scroller.scrollWidth > scroller.clientWidth + 5;

    let isDown=false, startX=0, startScrollLeft=0, pointerId=null, moved=0;

    const onDown=(e)=>{
      const t=e.target;
      if(t && t.closest && t.closest('button,[role="button"],.btn,.iconbtn,.chip,.tab,a,input,textarea,select')) return;
      if(!isHScrollable()) return;
      isDown=true; moved=0; pointerId=e.pointerId;
      startX=e.clientX; startScrollLeft=scroller.scrollLeft;
      try{ scroller.setPointerCapture(pointerId); }catch(_){}
    };
    const onMove=(e)=>{
      if(!isDown || e.pointerId!==pointerId) return;
      const dx=e.clientX-startX;
      moved=Math.max(moved, Math.abs(dx));
      if(moved>6) e.preventDefault();
      scroller.scrollLeft = startScrollLeft - dx;
    };
    const onUp=(e)=>{
      if(!isDown || e.pointerId!==pointerId) return;
      isDown=false;
      try{ scroller.releasePointerCapture(pointerId); }catch(_){}
      pointerId=null;

      // snap to nearest child (if any)
      const children = Array.from(scroller.children || []);
      if(!children.length) return;
      const cur = scroller.scrollLeft;
      let nearest = children[0], best = Math.abs(children[0].offsetLeft - cur);
      for(const ch of children){
        const d = Math.abs(ch.offsetLeft - cur);
        if(d < best){ best=d; nearest=ch; }
      }
      if(best > 2){
        scroller.scrollTo({left: nearest.offsetLeft, behavior:'smooth'});
      }
    };

    scroller.addEventListener('pointerdown', onDown, {passive:true});
    scroller.addEventListener('pointermove', onMove, {passive:false});
    scroller.addEventListener('pointerup', onUp, {passive:true});
    scroller.addEventListener('pointercancel', onUp, {passive:true});
  }

  function findAndBind(){
    // Your carousel element exists from start, but its children are rendered later by JS
    const car = document.querySelector('.carousel');
    if(!car) return;
    // sometimes the scroller is carousel itself; sometimes a child
    bindScroller(car);
    const childScroller = car.querySelector('.slides,.track,.slideTrack,.scroller,[data-role="carousel"],[data-carousel]');
    if(childScroller) bindScroller(childScroller);
  }

  // Initial attempt (in case already rendered)
  findAndBind();

  // Observe for renderCarousel() DOM changes and bind when nodes appear
  const mo = new MutationObserver(()=>{ findAndBind(); });
  mo.observe(document.body, {childList:true, subtree:true});
})();
</script>


<!-- ===================== GitHub Gist Backup/Restore (Local-first Sync) ===================== -->
<style>
  /* Top app-like snackbar */
  #gistSnack{position:fixed;left:50%;top:calc(env(safe-area-inset-top, 0px) + 10px);transform:translateX(-50%);z-index:9999;
    background:rgba(20,20,20,.92);color:#fff;border-radius:14px;
    padding:10px 12px;display:none;align-items:center;gap:10px;min-width:240px;max-width:92vw;
    box-shadow:0 14px 40px rgba(0,0,0,.25)}
  opacity:0; transform:translateX(-50%) translateY(-6px);transition:opacity .18s ease, transform .18s ease;}
  #gistSnack.show{opacity:1; transform:translateX(-50%) translateY(0);}
  #gistSnack .msg{font-size:12px;line-height:1.25;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  #gistSnack .btn{background:rgba(255,255,255,.14);border:0;color:#fff;border-radius:10px;
    padding:6px 10px;font-size:12px;cursor:pointer}
  #gistSnack .spin{width:14px;height:14px;border-radius:50%;
    border:2px solid rgba(255,255,255,.25);border-top-color:#fff;animation:gistSpin .8s linear infinite;display:none}
  @keyframes gistSpin{to{transform:rotate(360deg)}}
  @keyframes ptrSnap{0%{transform:translateY(28px)}100%{transform:translateY(0px)}}

  /* Small floating settings button (hidden if configured) */
  #gistFab{position:fixed;right:14px;bottom:14px;z-index:9998;width:44px;height:44px;border-radius:16px;
    border:0;background:rgba(20,20,20,.92);color:#fff;display:none;cursor:pointer;
    box-shadow:0 14px 40px rgba(0,0,0,.25);font-size:20px;line-height:44px}
  #gistFab:active{transform:scale(.98)}

  /* Modal */
  #gistModalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:10000;align-items:center;justify-content:center}
  #gistModal{background:#fff;border-radius:18px;max-width:420px;width:92%;padding:18px 18px 14px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  #gistModal h3{margin:0 0 8px 0;font-size:18px}
  #gistModal p{margin:6px 0;font-size:13px;line-height:1.5;color:#333}
  #gistModal label{display:block;margin-top:10px;font-size:12px;color:#222}
  #gistModal input{width:100%;padding:10px;border:1px solid #ddd;border-radius:12px;font-size:13px}
  #gistModal .row{display:flex;gap:10px;margin-top:12px}
  #gistModal .row button{flex:1;border:0;border-radius:12px;padding:10px 12px;font-size:13px;cursor:pointer}
  #gistModal .primary{background:#111;color:#fff}
  #gistModal .ghost{background:#eee}
  #gistModal small{display:block;color:#666;margin-top:6px;line-height:1.4}

  #gistModal .head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px}
  #gistModal .sub{margin:4px 0 0 0;color:#555;font-size:12px}
  #gistModal .iconBtn{border:0;background:#f1f1f1;border-radius:12px;width:36px;height:36px;cursor:pointer}
  #gistModal .card{background:#fafafa;border:1px solid #eee;border-radius:16px;padding:14px}
  #gistModal .hint{margin:0 0 10px 0;color:#333}
  #gistModal .err{min-height:16px;margin-top:6px;color:#b00020;font-size:12px}
  #gistModal .note{display:block;color:#666;margin-top:8px;line-height:1.4}
  #gistModal .footer{margin-top:10px;text-align:center}
  #gistModal .muted{color:#777}
  #gistModal button[disabled]{opacity:.45;cursor:not-allowed}

  #gistModal .danger{color:#b00020}

  /* Pull-to-refresh hint */
  #ptrHint{position:fixed;top:calc(env(safe-area-inset-top, 0px) - 40px);left:0;right:0;text-align:center;z-index:9997;
    color:#111;font-size:12px;transition:top .2s;}
  #ptrHint .box{display:inline-block;background:rgba(255,255,255,.96);padding:8px 12px;border-radius:999px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
</style>

<div id="ptrHint"><div class="box">â†“ ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨ (Gist ë³µì›)</div></div>

<div id="gistSnack">
  <div class="spin" id="gistSnackSpin"></div>
  <div class="msg" id="gistSnackMsg">Sync</div>
  <button class="btn" id="gistSnackAction" type="button" style="display:none">ë³µì›</button>
  <button class="btn" id="gistSnackDismiss" type="button" style="display:none">ìœ ì§€</button>
</div>

<button id="gistFab" type="button" title="Gist ë™ê¸°í™” ì„¤ì •">âš™ï¸</button>


<div id="gistModalOverlay">
  <div id="gistModal">
    <div class="head">
      <div>
        <h3>Gist ë™ê¸°í™” ì„¤ì •</h3>
        <p class="sub">í•œ ë²ˆë§Œ ì„¤ì •í•˜ë©´ ìë™ ë°±ì—…/ë³µì›ì´ ì¼œì§‘ë‹ˆë‹¤.</p>
      </div>
      <button id="gistModalCancelX" class="iconBtn" type="button" aria-label="ë‹«ê¸°">âœ•</button>
    </div>

    <div class="card">
      <p class="hint"><b>ë¡œì»¬ ìš°ì„ </b>ìœ¼ë¡œ ì¦‰ì‹œ ì €ì¥í•˜ê³ , 10ë¶„ë§ˆë‹¤ + ê¸°ë¡ ë³€ê²½ ì‹œ <b>Gist</b>ë¡œ ìë™ ë°±ì—…í•©ë‹ˆë‹¤.</p>

      <label>Gist ID</label>
      <input id="gistIdInput" placeholder="ì˜ˆ: ad5ab1d6edecb14c530b30d524144dbc" autocomplete="off" />
      <div id="gistIdErr" class="err"></div>

      <label>GitHub Token (PAT)</label>
      <input id="gistTokenInput" placeholder="ghp_... / github_pat_..." autocomplete="off" />
      <div id="gistTokErr" class="err"></div>
      <small class="note">ê¶Œí•œ(scope): <b>gist</b> (Read/Write). í† í°ì€ ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤(localStorage).</small>

      <div class="row">
        <button id="gistModalCancel" class="ghost" type="button">ì·¨ì†Œ</button>
        <button id="gistModalSave" class="primary" type="button" disabled>ì €ì¥</button>
      </div>
    </div>

    <div class="footer">
      <small class="muted">â€» ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•Šìœ¼ë©´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
    </div>
  </div>
</div>


<script>
try{

(function(){
  const LS_GIST_ID = "GIST_SYNC_ID";
  const LS_GIST_TOKEN = "GIST_SYNC_TOKEN";
  const LS_LAST_BACKUP_AT = "GIST_LAST_BACKUP_AT";
  const LS_LAST_RESTORE_AT = "GIST_LAST_RESTORE_AT";
  const LS_LAST_HASH = "GIST_LAST_HASH";
  const LS_SYNC_POLICY = "GIST_SYNC_POLICY"; // "ask" | "cloudWins" | "localWins"
  const DEFAULT_GIST_ID = "ad5ab1d6edecb14c530b30d524144dbc";
  const TARGET_FILENAME = "workout_backup.json";

  // UI
  const snack = document.getElementById("gistSnack");
  const snackMsg = document.getElementById("gistSnackMsg");
  const snackSpin = document.getElementById("gistSnackSpin");
  const snackAction = document.getElementById("gistSnackAction");
  const snackDismiss = document.getElementById("gistSnackDismiss");
  const fab = document.getElementById("gistFab");

  const overlay = document.getElementById("gistModalOverlay");
  const inputId = document.getElementById("gistIdInput");
  const inputToken = document.getElementById("gistTokenInput");
  const btnSave = document.getElementById("gistModalSave");
  const btnCancel = document.getElementById("gistModalCancel");
  const btnCancelX = document.getElementById("gistModalCancelX");
  const idErr = document.getElementById("gistIdErr");
  const tokErr = document.getElementById("gistTokErr");
  const ptrHint = document.getElementById("ptrHint");

  function getGistId(){ return localStorage.getItem(LS_GIST_ID) || DEFAULT_GIST_ID; }
  function getToken(){ return localStorage.getItem(LS_GIST_TOKEN) || ""; }
  function getPolicy(){ return localStorage.getItem(LS_SYNC_POLICY) || "ask"; }

  function showSnack(msg, {loading=false, actionText="", actionFn=null, dismissText="", dismissFn=null, autoHideMs=2200} = {}){
    snackMsg.textContent = msg;
    snack.style.display = "flex";
    requestAnimationFrame(()=>snack.classList.add("show"));
    snackSpin.style.display = loading ? "inline-block" : "none";

    // primary action
    if(actionText && actionFn){
      snackAction.textContent = actionText;
      snackAction.style.display = "inline-block";
      snackAction.onclick = actionFn;
      autoHideMs = 0; // don't auto hide if action exists
    }else{
      snackAction.style.display = "none";
      snackAction.onclick = null;
    }

    // dismiss/secondary action
    if(dismissText && dismissFn){
      snackDismiss.textContent = dismissText;
      snackDismiss.style.display = "inline-block";
      snackDismiss.onclick = dismissFn;
      autoHideMs = 0;
    }else{
      snackDismiss.style.display = "none";
      snackDismiss.onclick = null;
    }

    if(autoHideMs){
      setTimeout(()=> { snack.classList.remove("show"); setTimeout(()=>{snack.style.display="none";}, 180); }, autoHideMs);
    }
  }else{
      snackAction.style.display = "none";
      snackAction.onclick = null;
    }
    if(autoHideMs){
      setTimeout(()=> { snack.classList.remove("show");
    setTimeout(()=>{snack.style.display="none";},180); }, autoHideMs);
    }
  }
  function hideSnack(){ snack.classList.remove("show");
    setTimeout(()=>{snack.style.display="none";},180); }

  function showSetup(){
    inputId.value = getGistId();
    inputToken.value = getToken();
    overlay.style.display = "flex";
    setTimeout(updateSaveState,0);
  }
  function hideSetup(){ overlay.style.display = "none"; }

  function toast(msg){
    try{
      if(typeof window.toast === "function") return window.toast(msg);
      const d=document.createElement("div");
      d.textContent=msg;
      d.style.cssText="position:fixed;left:50%;bottom:64px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:10px 12px;border-radius:999px;font-size:12px;z-index:10001";
      document.body.appendChild(d);
      setTimeout(()=>d.remove(),1200);
    }catch(e){}
  }

  fab && fab.addEventListener("click", showSetup);
  btnCancel && btnCancel.addEventListener("click", hideSetup);
  btnCancelX && btnCancelX.addEventListener("click", hideSetup);
  
  function validateGistId(v){
    const s=(v||"").trim();
    if(!s) return {ok:false,msg:"Gist IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."};
    if(!/^[0-9a-fA-F]{20,40}$/.test(s)) return {ok:false,msg:"Gist ID í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (hex 20~40ì)"};
    return {ok:true,msg:""};
  }
  function validateToken(v){
    const s=(v||"").trim();
    if(!s) return {ok:false,msg:"Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”."};
    if(!/^(ghp_[A-Za-z0-9]{20,}|github_pat_[A-Za-z0-9_]{20,})$/.test(s)) return {ok:false,msg:"Token í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."};
    return {ok:true,msg:""};
  }
  function updateSaveState(){
    const idV=validateGistId(inputId.value);
    const tokV=validateToken(inputToken.value);
    if(idErr) idErr.textContent=idV.msg;
    if(tokErr) tokErr.textContent=tokV.msg;
    btnSave.disabled = !(idV.ok && tokV.ok);
  }
  inputId && inputId.addEventListener("input", updateSaveState);
  inputToken && inputToken.addEventListener("input", updateSaveState);

btnSave && btnSave.addEventListener("click", async () => {
  const idCheck = validateGistId(inputId.value);
  const tokCheck = validateToken(inputToken.value);
  if(!idCheck.ok || !tokCheck.ok){ updateSaveState(); toast("ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”"); return; }

  const id = (inputId.value || "").trim();
  const tok = (inputToken.value || "").trim();

  const prevText = btnSave.textContent;
  btnSave.textContent = "ê²€ì¦ ì¤‘â€¦";
  btnSave.disabled = true;

  try{
    const res1 = await fetch(`https://api.github.com/gists/${id}`, { headers: { "Accept":"application/vnd.github+json" }});
    if(res1.status === 404){ if(idErr) idErr.textContent="í•´ë‹¹ Gist IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (404)"; throw new Error("Gist IDê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); }
    if(!res1.ok){ throw new Error("Gist í™•ì¸ ì‹¤íŒ¨: " + res1.status); }

    const res2 = await fetch(`https://api.github.com/gists/${id}`, { headers: { "Accept":"application/vnd.github+json", "Authorization":"token "+tok }});
    if(res2.status === 401){ if(tokErr) tokErr.textContent="Tokenì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (401)"; throw new Error("Token ì¸ì¦ ì‹¤íŒ¨"); }
    if(res2.status === 403){ if(tokErr) tokErr.textContent="ê¶Œí•œì´ ë¶€ì¡±í•©ë‹ˆë‹¤. Token ê¶Œí•œì— gist(Read/Write)ê°€ í•„ìš”í•©ë‹ˆë‹¤. (403)"; throw new Error("Token ê¶Œí•œ ë¶€ì¡±"); }
    if(!res2.ok){ throw new Error("Token í™•ì¸ ì‹¤íŒ¨: " + res2.status); }

    const j = await res2.json();
    const files = j && j.files ? Object.keys(j.files) : [];
    const targetName = (files.includes("workout_backup.json") ? "workout_backup.json" : (files[0] || "workout_backup.json"));
    const current = j.files && j.files[targetName] ? (j.files[targetName].content || "{}") : "{}";

    const res3 = await fetch(`https://api.github.com/gists/${id}`, {
      method:"PATCH",
      headers:{ "Accept":"application/vnd.github+json","Content-Type":"application/json","Authorization":"token "+tok },
      body: JSON.stringify({ files: { [targetName]: { content: current } } })
    });
    if(res3.status === 401){ if(tokErr) tokErr.textContent="Tokenì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (401)"; throw new Error("Token ì¸ì¦ ì‹¤íŒ¨"); }
    if(res3.status === 403){ if(tokErr) tokErr.textContent="ì“°ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. Token ê¶Œí•œì— gist(Read/Write)ê°€ í•„ìš”í•©ë‹ˆë‹¤. (403)"; throw new Error("ì“°ê¸° ê¶Œí•œ ë¶€ì¡±"); }
    if(!res3.ok){ throw new Error("ì“°ê¸° ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: " + res3.status); }

    localStorage.setItem(LS_GIST_ID, id);
    localStorage.setItem(LS_GIST_TOKEN, tok);
    hideSetup();
    toast("ì„¤ì • ì™„ë£Œ âœ…");
    updateFabVisibility();
    showSnack("ë™ê¸°í™” ì„¤ì • ì™„ë£Œ", {loading:false});
  }catch(e){
    console.error(e);
    toast(e.message || "ê²€ì¦ ì‹¤íŒ¨");
  }finally{
    btnSave.textContent = prevText;
    updateSaveState();
  }
});

  function updateFabVisibility(){
    // Hide FAB if token exists (one-time setup). Show if missing or backup errors.
    const tok = getToken();
    fab.style.display = tok ? "none" : "block";
  }

  async function sha256(str){
    const enc = new TextEncoder().encode(str);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // ----- Gather current app payload (prefer app's export if present)
  function getLocalPayload() {
    // Prefer app-level export if present (should include updatedAt)
    try {
      if (typeof window.buildBackupPayload === "function") {
        const p = window.buildBackupPayload();
        if(p && !p.updatedAt) p.updatedAt = new Date().toISOString();
        return p;
      }
      if (typeof window.exportAll === "function") {
        const p = window.exportAll();
        if(p && !p.updatedAt) p.updatedAt = new Date().toISOString();
        return p;
      }
    } catch(e){}

    // Generic localStorage dump (with explicit updatedAt)
    const out = {};
    for (let i=0;i<localStorage.length;i++) {
      const k = localStorage.key(i);
      if(!k) continue;
      if([LS_GIST_ID, LS_GIST_TOKEN, LS_LAST_BACKUP_AT, LS_LAST_RESTORE_AT, LS_LAST_HASH, LS_SYNC_POLICY].includes(k)) continue;
      out[k] = localStorage.getItem(k);
    }
    // Best-effort updatedAt key (your app already writes KEY_LOCAL_UPDATED_AT into localStorage)
    const updatedAt = out["LOCAL_UPDATED_AT"] || out["KEY_LOCAL_UPDATED_AT"] || out["localUpdatedAt"] || out["updatedAt"] || localStorage.getItem("LOCAL_UPDATED_AT") || localStorage.getItem("KEY_LOCAL_UPDATED_AT") || new Date().toISOString();

    return { kind:"localStorageDump", ts:new Date().toISOString(), updatedAt, data: out };
  }

  function applyPayload(payload) {
    try {
      if (typeof window.applyBackupPayload === "function") return window.applyBackupPayload(payload);
      if (typeof window.importAll === "function") return window.importAll(payload);
    } catch(e){}
    if(payload && payload.kind==="localStorageDump" && payload.data) {
      const keep = new Set([LS_GIST_ID, LS_GIST_TOKEN, LS_LAST_BACKUP_AT, LS_LAST_RESTORE_AT, LS_LAST_HASH, LS_SYNC_POLICY]);
      const existingKeys = [];
      for (let i=0;i<localStorage.length;i++) {
        const k = localStorage.key(i); if(k && !keep.has(k)) existingKeys.push(k);
      }
      existingKeys.forEach(k=>localStorage.removeItem(k));
      Object.entries(payload.data).forEach(([k,v])=>localStorage.setItem(k, v));
    }
    try {
      if (typeof window.renderAll === "function") window.renderAll();
      if (typeof window.render === "function") window.render();
      if (typeof window.refreshUI === "function") window.refreshUI();
      // force listeners
      try{ window.dispatchEvent(new Event('storage')); }catch(e){}
      try{ window.dispatchEvent(new Event('app:dataRestored')); }catch(e){}
    } catch(e){}
  }

  // ----- GitHub API helpers
  async function gistGet(id) {
    const res = await fetch(`https://api.github.com/gists/${id}`, {
      headers: { "Accept": "application/vnd.github+json" }
    });
    if(!res.ok) throw new Error("Gist GET ì‹¤íŒ¨: " + res.status);
    return await res.json();
  }

  async function gistPatch(id, token, fileContent) {
    const res = await fetch(`https://api.github.com/gists/${id}`, {
      method: "PATCH",
      headers: {
        "Accept": "application/vnd.github+json",
        "Content-Type": "application/json",
        "Authorization": "token " + token
      },
      body: JSON.stringify({
        files: { [TARGET_FILENAME]: { content: fileContent } }
      })
    });
    if(!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error("Gist PATCH ì‹¤íŒ¨: " + res.status + " " + t);
    }
    return await res.json();
  }

  // ----- Backup & Restore core
  let backupTimer = null;
  let isSyncing = false;

  async function backupToGist(reason="") {
    const token = getToken();
    if(!token) {
      updateFabVisibility();
      showSnack("Gist ìë™ ë°±ì—…: ì„¤ì • í•„ìš”", {loading:false, actionText:"ì„¤ì •", actionFn:showSetup});
      return;
    }
    if(isSyncing) return;

    isSyncing = true;
    showSnack(`ë°±ì—… ì¤‘â€¦ ${reason ? "(" + reason + ")" : ""}`, {loading:true, autoHideMs:0});

    try {
      const payload = getLocalPayload();
      const jsonStr = JSON.stringify(payload);
      const h = await sha256(jsonStr);

      const lastHash = localStorage.getItem(LS_LAST_HASH);
      if(lastHash === h) {
        showSnack("ë³€ê²½ ì—†ìŒ Â· ë°±ì—… ìƒëµ", {loading:false});
        isSyncing = false;
        return;
      }

      await gistPatch(getGistId(), token, jsonStr);
      localStorage.setItem(LS_LAST_HASH, h);
      const at = new Date().toISOString();
      localStorage.setItem(LS_LAST_BACKUP_AT, at);
      showSnack("ë°±ì—… ì™„ë£Œ Â· " + new Date(at).toLocaleTimeString(), {loading:false});
      updateFabVisibility();
    } catch(e) {
      console.error(e);
      updateFabVisibility();
      fab.style.display = "block"; // allow reconfigure quickly
      showSnack("ë°±ì—… ì‹¤íŒ¨: " + (e.message || e), {loading:false, actionText:"ì„¤ì •", actionFn:showSetup});
    } finally {
      isSyncing = false;
    }
  }

  function extractTs(payload){
    try{
      if(payload && payload.updatedAt) return Date.parse(payload.updatedAt) || 0;
      if(payload && payload.ts) return Date.parse(payload.ts) || 0;
      if(payload && payload.data){
        const v = payload.data["LOCAL_UPDATED_AT"] || payload.data["KEY_LOCAL_UPDATED_AT"] || payload.data["updatedAt"] || payload.data["localUpdatedAt"];
        if(v) return Date.parse(v) || 0;
      }
    }catch(e){}
    return 0;
  }

  async function restoreFromGist(manual=false) {
    if(isSyncing) return;
    isSyncing = true;
    showSnack("ë³µì› ì¤‘â€¦", {loading:true, autoHideMs:0});

    try {
      const data = await gistGet(getGistId());
      const f = data.files && data.files[TARGET_FILENAME];
      if(!f) throw new Error("Gistì— " + TARGET_FILENAME + " íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");

      let content = f.content;
      if(f.truncated && f.raw_url) {
        const r = await fetch(f.raw_url);
        content = await r.text();
      }
      const cloudPayload = JSON.parse(content || "{}");
      try{ localStorage.setItem('GIST_CLOUD_UPDATED_AT', cloudPayload.updatedAt || cloudPayload.ts || ''); }catch(e){}

      // Compare recency (best effort)
      const localPayload = getLocalPayload();
      const cloudMs = extractTs(cloudPayload);
      const localMs = extractTs(localPayload);

      const policy = getPolicy();

      if(cloudMs && localMs && Math.abs(cloudMs - localMs) > 2000){
        if(localMs > cloudMs){
          // Local is newer
          if(policy === "cloudWins"){
            applyPayload(cloudPayload);
      // âœ… ê°•ì œ ë¦¬ë Œë”(í•„ìš” ì‹œ): ë³µì› í›„ ì•± ìƒíƒœê°€ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ UIê°€ ì•ˆ ë°”ë€ŒëŠ” ê²½ìš°ë¥¼ ë°©ì§€
      try{
        if(typeof window.afterGistRestore === "function") window.afterGistRestore();
        // ë§ˆì§€ë§‰ ìˆ˜ë‹¨: í™”ë©´ì´ ê°±ì‹ ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œëŠ” 1íšŒ ìë™ ë¦¬ë¡œë“œ
        if(!window.__GIST_RELOADED_ONCE__){
          window.__GIST_RELOADED_ONCE__ = true;
          setTimeout(()=>{ location.reload(); }, 80);
        }
      }catch(e){}

            showSnack("ë³µì› ì™„ë£Œ(í´ë¼ìš°ë“œ ìš°ì„ )", {loading:false});
          }else if(policy === "localWins"){
            showSnack("ë¡œì»¬ì´ ë” ìµœì‹  Â· ë³µì› ìƒëµ", {loading:false});
          }else{
            // ask
            showSnack("ë¡œì»¬ì´ ë” ìµœì‹  Â· ë³µì›í• ê¹Œìš”?", {loading:false, actionText:"ë³µì›", actionFn:()=>{ applyPayload(cloudPayload);
      // âœ… ê°•ì œ ë¦¬ë Œë”(í•„ìš” ì‹œ): ë³µì› í›„ ì•± ìƒíƒœê°€ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ UIê°€ ì•ˆ ë°”ë€ŒëŠ” ê²½ìš°ë¥¼ ë°©ì§€
      try{
        if(typeof window.afterGistRestore === "function") window.afterGistRestore();
        // ë§ˆì§€ë§‰ ìˆ˜ë‹¨: í™”ë©´ì´ ê°±ì‹ ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œëŠ” 1íšŒ ìë™ ë¦¬ë¡œë“œ
        if(!window.__GIST_RELOADED_ONCE__){
          window.__GIST_RELOADED_ONCE__ = true;
          setTimeout(()=>{ location.reload(); }, 80);
        }
      }catch(e){}
 hideSnack(); toast("ë³µì› ì™„ë£Œ"); }});
          }
        }else{
          // Cloud is newer
          applyPayload(cloudPayload);
      // âœ… ê°•ì œ ë¦¬ë Œë”(í•„ìš” ì‹œ): ë³µì› í›„ ì•± ìƒíƒœê°€ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ UIê°€ ì•ˆ ë°”ë€ŒëŠ” ê²½ìš°ë¥¼ ë°©ì§€
      try{
        if(typeof window.afterGistRestore === "function") window.afterGistRestore();
        // ë§ˆì§€ë§‰ ìˆ˜ë‹¨: í™”ë©´ì´ ê°±ì‹ ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œëŠ” 1íšŒ ìë™ ë¦¬ë¡œë“œ
        if(!window.__GIST_RELOADED_ONCE__){
          window.__GIST_RELOADED_ONCE__ = true;
          setTimeout(()=>{ location.reload(); }, 80);
        }
      }catch(e){}

          showSnack("ë³µì› ì™„ë£Œ Â· ìµœì‹  ë°˜ì˜", {loading:false});
        }
      }else{
        // No reliable timestamps -> default apply (cloud is source of truth on restore)
        applyPayload(cloudPayload);
      // âœ… ê°•ì œ ë¦¬ë Œë”(í•„ìš” ì‹œ): ë³µì› í›„ ì•± ìƒíƒœê°€ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ UIê°€ ì•ˆ ë°”ë€ŒëŠ” ê²½ìš°ë¥¼ ë°©ì§€
      try{
        if(typeof window.afterGistRestore === "function") window.afterGistRestore();
        // ë§ˆì§€ë§‰ ìˆ˜ë‹¨: í™”ë©´ì´ ê°±ì‹ ë˜ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œëŠ” 1íšŒ ìë™ ë¦¬ë¡œë“œ
        if(!window.__GIST_RELOADED_ONCE__){
          window.__GIST_RELOADED_ONCE__ = true;
          setTimeout(()=>{ location.reload(); }, 80);
        }
      }catch(e){}

        showSnack("ë³µì› ì™„ë£Œ", {loading:false});
      }

      const at = new Date().toISOString();
      localStorage.setItem(LS_LAST_RESTORE_AT, at);
      if(manual) toast("ë³µì› ì™„ë£Œ");
      updateFabVisibility();
    } catch(e) {
      console.error(e);
      updateFabVisibility();
      fab.style.display = "block";
      showSnack("ë³µì› ì‹¤íŒ¨: " + (e.message || e), {loading:false, actionText:"ì„¤ì •", actionFn:showSetup});
      if(manual) toast("ë³µì› ì‹¤íŒ¨: " + (e.message || e));
    } finally {
      isSyncing = false;
    }
  }

  function scheduleBackup(reason="") {
    if(backupTimer) clearTimeout(backupTimer);
    backupTimer = setTimeout(()=>backupToGist(reason), 2000);
  }

  // Expose for app hooks
  window.gistScheduleBackup = scheduleBackup;
  window.gistBackupNow = backupToGist;
  window.gistRestoreNow = restoreFromGist;

  // Auto: start restore in background shortly after load
  setTimeout(()=>restoreFromGist(false), 900);

  // Every 10 minutes (foreground only)
  setInterval(()=> { if(!document.hidden) backupToGist("10ë¶„ ì£¼ê¸°"); }, 10*60*1000);

  // On background / page hide
  document.addEventListener("visibilitychange", ()=> { if(document.hidden) backupToGist("ë°±ê·¸ë¼ìš´ë“œ ì „í™˜"); });
  window.addEventListener("pagehide", ()=> backupToGist("í˜ì´ì§€ ì¢…ë£Œ"));

  // Pull-to-refresh (in-app) â€” app-like
  let startY = null;
  let pulling = false;
  let maxPull = 0;
  let rafId = null;
  const ptrText = document.getElementById("ptrText");
  const ptrDot = document.getElementById("ptrDot");
  const ptrRing = document.getElementById("ptrRing");

  const THRESHOLD = 72;
  const MAX = 120;

  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function setPtr(y){
    // Rubber-band effect (iOS-like)
    const eased = y < THRESHOLD ? y : THRESHOLD + (y-THRESHOLD)*0.35;
    const shown = clamp(eased - 10, 0, 56);
    ptrHint.style.transform = `translateY(${shown}px)`;
    ptrHint.style.opacity = String(Math.min(1, eased/60));

    const progress = clamp(eased / THRESHOLD, 0, 1);
    if(ptrRing){
      ptrRing.style.opacity = String(0.15 + progress*0.85);
      ptrRing.style.transform = `rotate(${Math.floor(progress*320)}deg)`;
    }
    if(ptrDot) ptrDot.style.opacity = String(1 - progress*0.9);

    if(ptrText){
      ptrText.textContent = (eased >= THRESHOLD) ? "ë†“ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨" : "ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨";
    }
    // subtle "ready" emphasis
    if(ptrDot) ptrDot.style.background = (eased >= THRESHOLD) ? "rgba(0,0,0,.45)" : "rgba(0,0,0,.15)";
  }

  function resetPtr(){
    ptrHint.style.transform = "translateY(0px)";
    ptrHint.style.opacity = "0";
    if(ptrRing){ ptrRing.style.opacity = "0"; ptrRing.style.transform = "rotate(0deg)"; }
    if(ptrDot){ ptrDot.style.opacity = "1"; }
    if(ptrText){ ptrText.textContent = "ë‹¹ê²¨ì„œ ìƒˆë¡œê³ ì¹¨"; }
  }

  window.addEventListener("touchstart", (e)=> {
    if(window.scrollY === 0) startY = e.touches[0].clientY;
  }, {passive:true});

  window.addEventListener("touchmove", (e)=> {
    if(startY==null) return;
    const dy = e.touches[0].clientY - startY;
    if(dy <= 0 || window.scrollY !== 0) return;
    pulling = true;
    maxPull = Math.max(maxPull, dy);

    const y = clamp(dy, 0, MAX);
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(()=> setPtr(y));
  }, {passive:true});

  window.addEventListener("touchend", async ()=> {
    if(!pulling) { startY=null; maxPull=0; return; }
    const ready = maxPull >= THRESHOLD;

    pulling = false;
    startY = null;

    if(ready){
      // lock hint in visible state while refreshing
      ptrHint.style.opacity = "1";
      ptrHint.style.transform = "translateY(42px)";
      if(ptrText) ptrText.textContent = "ìƒˆë¡œê³ ì¹¨ ì¤‘â€¦";
      if(ptrDot) ptrDot.style.display = "none";
      if(ptrRing){
        ptrRing.style.opacity = "1";
        ptrRing.style.animation = "gistSpin .8s linear infinite";
      }
      // haptic (best-effort)
      try{ if(navigator.vibrate) navigator.vibrate(8); }catch(e){}

      await restoreFromGist(true);

      if(ptrRing){
        ptrRing.style.animation = "none";
      }
      // snap away
      resetPtr();
    }else{
      resetPtr();
    }
    maxPull = 0;
  });


  // If app emits this event, auto-backup
  window.addEventListener("app:dataChanged", ()=> scheduleBackup("ë°ì´í„° ë³€ê²½"));

  updateFabVisibility();
})();

}catch(e){console.error('GistSync init error', e);}
</script>
<!-- ===================== /GitHub Gist Backup/Restore ===================== -->


</body>
</html>

